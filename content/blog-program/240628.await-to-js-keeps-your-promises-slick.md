---
title: å›ä¸å»æƒ¹ï¼Œç”¨ await-to-js è®“ä½ çš„ Promise æ“ä½œç°¡æ½”åˆä¿è½ï¼
description: å¯ä»¥åœ¨ç‰¹å®šæƒ…å¢ƒä¸‹ç°¡åŒ– Promise å¯«æ³•
tags: ['JavaScript', 'TypeScript']
image: https://codlin.me/await-to-js.webp
date: 20240628
---

# å›ä¸å»æƒ¹ï¼Œç”¨ await-to-js è®“ä½ çš„ Promise æ“ä½œç°¡æ½”åˆä¿è½

![await-to-js](/await-to-js.webp){height="600"}

å‰é™£å­æ„å¤–æ³¨æ„åˆ°ä¸€å€‹æœ‰è¶£çš„å¥—ä»¶ï¼Œåç‚º [await-to-js](https://www.npmjs.com/package/await-to-js)ã€‚

ä¸»è¦ç”¨é€”æ˜¯å¤šä¸€ç¨® Promise èˆ‡ await çš„å¯«æ³•ï¼Œå¯ä»¥åœ¨ç‰¹å®šæƒ…å¢ƒä¸‹è®“ç¨‹å¼ç¢¼æ›´ç°¡æ½”ã€‚

é¡ä¼¼çš„å¯¦ä½œå…¶å¯¦ [Radash](https://radash-docs.vercel.app/docs/async/tryit) ä¹Ÿæœ‰ï¼Œä¸é await-to-js ç”¨æ³•æ¯”è¼ƒå–®ç´”ã€‚

::: tip 2024/08/26 æ›´æ–°
[ECMAScript æ–°ææ¡ˆï¼š Safe Assignment Operator Proposal](https://dev.to/dharamgfx/bye-bye-try-catch-blocks-meet-javascripts-safe-assignment-operator-proposal-1j7?ref=dailydev)

ç­‰æ–¼ç›´æ¥æŠŠ await-to-js åŠ åˆ°èªè¨€è¦æ ¼ä¸­ï¼ŒæœŸå¾… await-to-js å¥—ä»¶é€€ä¼‘é‚£ä¸€å¤©ã€‚(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§
:::

## å…·é«”å·®åœ¨å“ªï¼Ÿ

å‡è¨­åŸæœ¬çš„ Promise æ˜¯é€™æ¨£ï¼š

```ts
let isLoading = true
task().then(() => {
  console.log('done')
}).catch(() => {
  console.error('error')
}).finally(() => {
  isLoading = false
})
```

ç”¨ await æœƒé€™æ¨£å¯«ã€‚

```ts
let isLoading = true
try {
  await task()
  console.log('done')
}
catch (e) {
  console.error('error')
}

isLoading = false
```

ä½¿ç”¨ await-to-js æ”¹å¯«å¾Œè®Šæˆï¼š

```ts
import to from 'await-to-js'

let isLoading = true
const [error] = await to(task())
isLoading = false

if (error) {
  console.error('error')
  return
}

console.log('done')
```

é™¤äº†çœ‹èµ·ä¾†æ¯”è¼ƒç°¡æ½”ï¼Œä¸ç”¨ try catch å¤–ï¼Œé…åˆ early return å¾ˆæœ‰æ•ˆã€‚

åœ¨å‰ç«¯å¯èƒ½é‚„å¥½ï¼Œåœ¨å¾Œç«¯å„ç¨® Promise æ“ä½œçš„å ´åˆçš„å¾ˆæ–¹ä¾¿ï¼Œå¾æ­¤ä»¥å¾Œå¯«æ³•å†ä¹Ÿå›ä¸å»äº†ã€‚XD

ä»¥ä¸‹æ˜¯å®˜æ–¹çš„ç¯„ä¾‹ã€‚

```ts
import to from 'await-to-js'

async function asyncTaskWithCb(cb) {
  let err, user, savedTask, notification;

  [err, user] = await to(UserModel.findById(1))
  if (!user)
    return cb('No user found');

  [err, savedTask] = await to(TaskModel({ userId: user.id, name: 'Demo Task' }))
  if (err)
    return cb('Error occurred while saving task')

  if (user.notificationsEnabled) {
    [err] = await to(NotificationService.sendNotification(user.id, 'Task Created'))
    if (err)
      return cb('Error while sending notification')
  }

  if (savedTask.assignedUser.id !== user.id) {
    [err, notification] = await to(NotificationService.sendNotification(savedTask.assignedUser.id, 'Task was created for you'))
    if (err)
      return cb('Error while sending notification')
  }

  cb(null, savedTask)
}

async function asyncFunctionWithThrow() {
  const [err, user] = await to(UserModel.findById(1))
  if (!user)
    throw new Error('User not found')
}
```

æˆ‘è‡ªå·±çš„è©±å¾Œç«¯æ¯”è¼ƒå¸¸ç”¨ï¼Œä¾‹å¦‚ NestJS çš„ Controller ä¸­ï¼š

```ts
@Controller()
export class ArticleController {
  // ..

  @UseGuards(AuthGuard('jwt'))
  @Post('articles')
  async getInfo(
    @User() jwtPayload: JwtPayload,
    @Body() body: CreateArticleDto,
  ) {
    const [userError, result] = await to(
      this.userService.check(jwtPayload)
    )
    if (userError) {
      throw new HttpException(
        `ä½¿ç”¨è€…èº«åˆ†ç•°å¸¸`,
        HttpStatus.FORBIDDEN,
      )
    }

    const [checkError, result] = await to(
      this.articleService.checkQuota(jwtPayload)
    )
    if (checkError) {
      throw new HttpException(
        `å»ºç«‹æ–‡ç« å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦`,
        HttpStatus.INTERNAL_SERVER_ERROR,
      )
    }

    if (result.reason === 'quota-has-been-used-up') {
      throw new HttpException(
        `æ–‡ç« é¡åº¦å·²æ»¿ï¼Œè«‹è¯çµ¡å®¢æœ`,
        HttpStatus.BAD_REQUEST,
      )
    }

    const [createError, article] = await to(
      this.articleService.create(body)
    )
    if (createError) {
      throw new HttpException(
        `å»ºç«‹æ–‡ç« å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦`,
        HttpStatus.INTERNAL_SERVER_ERROR,
      )
    }

    return article
  }
}
```

å¯ä»¥æå‰è™•ç† errorï¼Œæ›´æ–¹ä¾¿ä½¿ç”¨ early returnã€‚â—(â‰§âˆ€â‰¦)â—Ÿ

await-to-js çš„å¯¦ç¾å¾ˆç°¡å–®ï¼Œä»–çš„åŸå§‹ç¢¼åªæœ‰ 22 è¡Œã€‚

```ts
/**
 * @param { Promise } promise
 * @param {object=} errorExt - Additional Information you can pass to the err object
 * @return { Promise }
 */
export function to<T, U = Error>(
  promise: Promise<T>,
  errorExt?: object
): Promise<[U, undefined] | [null, T]> {
  return promise
    .then<[null, T]>((data: T) => [null, data])
    .catch<[U, undefined]>((err: U) => {
      if (errorExt) {
        const parsedError = Object.assign({}, err, errorExt)
        return [parsedError, undefined]
      }

      return [err, undefined]
    })
}

export default to
```

å¦‚æœä¸æƒ³ npm install çš„è©±ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è²¼åˆ°è‡ªå·±çš„å°ˆæ¡ˆä½¿ç”¨ã€‚ãƒ¾(â—'à±ª`â—)ï¾‰ï¾

## Promise éƒ½æ”¹ç”¨ await to å—ï¼Ÿ

ç•¶ç„¶ä¸æ˜¯é€™æ¨£å•¦ï¼Œawait to åªæ˜¯å¤šä¸€å€‹é¸æ“‡ã€‚áƒš(â•¹Îµâ•¹áƒš)

å¯¦éš›ä¸Šé‚„æ˜¯æœ‰äº›åœ°æ–¹æ›´é©åˆä½¿ç”¨ then æˆ– try catchã€‚

ä¾‹å¦‚ï¼š

æœ‰æ™‚å€™æ ¹æœ¬å°±ä¸æœƒæœ‰éŒ¯èª¤ï¼Œå°±ç¶­æŒ awaitã€‚

```ts
const result = await task()
```

æœ‰éŒ¯èª¤ä¹Ÿæ²’é—œä¿‚ï¼Œä¸éœ€è¦ç‰¹åˆ¥è™•ç†ï¼Œç”¨ catch ç´€éŒ„ä¸€ä¸‹å°±è¡Œã€‚

```ts
await task().catch(console.error)
```

å–®ä¸€éŒ¯èª¤ä¸é‡è¦ï¼Œçµ±ä¸€è™•ç†å³å¯ï¼Œå°±ç›´æ¥ try catchã€‚

```ts
try {
  await task1()
  await task2()
  await task3()
  await task4()
}
catch (error) {
  console.error(error)
}
```

è«‹ä¾ç…§å¯¦éš›æƒ…æ³æŒ‘é¸é©åˆçš„å¯«æ³•å–”ã€‚(ï½¡ï½¥âˆ€ï½¥)ï¾‰ï¾

## ç¸½çµ ğŸŸ

- await-to-js å¯ä»¥åœ¨ç‰¹å®šæƒ…å¢ƒä¸‹ç°¡åŒ– Promise å¯«æ³•
- é…åˆ early return å¾ˆæœ‰æ•ˆ
- è«‹ä¸è¦åªç”¨ await-to-jsï¼Œéœ€è¦ç”¨ then æˆ– try catch é‚„æ˜¯ç”¨åŸæœ¬çš„å¯«æ³•
