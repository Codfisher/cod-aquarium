---
title: è½èªª forEach æ¯” for è¿´åœˆæ…¢ï¼Ÿ
description: å¸¸è½åˆ°åˆ¥äººèªªç‰¹å®šæƒ…å¢ƒä¸‹ forEach æ¯” for è¿´åœˆé‚„æ…¢ï¼Œå‰›å¥½æœ‰å€‹å¥½æ©Ÿæœƒï¼Œè®“æˆ‘ä¾†è©¦è©¦çœ‹å§ã€‚Ô…(Â´âˆ€` Ô…)
tags: ['JavaScript']
image: https://codlin.me/for-each-and-for-loop.webp
date: 20241222
---

# è½èªª forEach æ¯” for è¿´åœˆæ…¢ï¼Ÿ

![for-each-and-for-loop](/for-each-and-for-loop.webp)

å¸¸è½åˆ°åˆ¥äººèªªï¼šæŸäº›æƒ…æ³ä¸‹ `forEach` æ¯” `for` è¿´åœˆé‚„æ…¢ã€‚

babylon.js çš„ Particle System æ–‡ä»¶ä¸­ï¼Œ[æ›´æ–°å¤§é‡ç²’å­](https://doc.babylonjs.com/features/featuresDeepDive/particles/particle_system/customizingParticles/)çš„è¿´åœˆé è¨­ä¹Ÿéƒ½æ˜¯ä½¿ç”¨ `for` è¿´åœˆã€‚

æœ€è¿‘é…·é…·çš„å…ƒä»¶åšäº†ä¸€å€‹[ä¸‹é›ªèƒŒæ™¯](https://chillcomponent.codlin.me/components/bg-snow/)ï¼Œç²’å­æ•¸é‡èˆ‡è¨ˆç®—é‡ç›¸å°å¾—å¤šã€‚

å‰›å¥½è—‰é€™å€‹æ©Ÿæœƒä¾†å¯¦æ¸¬çœ‹çœ‹ä¸åŒè¿´åœˆçš„å¯¦éš›æ•ˆæœã€‚<span class="text-nowrap">Ô…(Â´âˆ€` Ô…)</span>

::: tip
ä»¥ä¸‹å¯¦é©—åŸºæ–¼ Google Chrome v131.0.6778.110

è¶…ä¸åš´è¬¹ï¼Œåƒ…é‡å°æ­¤å…ƒä»¶æƒ…å¢ƒï¼Œè«‹ä¸è¦ç•¶ä½œæ­£å¼çµè«–ã€‚( ï¾Ÿâˆ€ã€‚)
:::

## å¯¦æ¸¬

åŸºæ–¼åŸæœ¬çš„[ç¨‹å¼ç¢¼](https://gitlab.com/side_project/chill-component/-/blob/main/src/components/bg-snow/bg-snow-worker.ts?ref_type=heads#L97)ï¼ŒåŠ ä¸Š `performance.now` è¨ˆç®—åŸ·è¡Œæ™‚é–“ï¼Œä¸”æ¯é‹è¡Œ 100 æ¬¡å†è¼¸å‡ºä¸€æ¬¡ï¼Œé¿å… devtool ç‚¸æ‰ã€‚

```ts
let count = 0
particleSystem.updateFunction = function (particles) {
  const startTime = performance.now()

  // è¨ˆç®— staticMap èˆ‡ç²’å­æ˜¯å¦æœ‰ç¢°æ’
  for (const id in staticMap) {
    // ...
  }

  const endTime = performance.now()

  if (count % 100 === 0) {
    console.log({
      particles: particles.length,
      time: endTime - startTime,
    })
  }
  count++
}
```

### for

```text
{particles: 1159, time: 0.5}
{particles: 1185, time: 1}
{particles: 1170, time: 0.5999999046325684}
{particles: 1195, time: 1}
{particles: 1200, time: 1.2000000476837158}
{particles: 1194, time: 0.7000000476837158}
{particles: 1201, time: 0.6999999284744263}
{particles: 1182, time: 1.1999999284744263}
```

å¯ä»¥çœ‹åˆ°åŸæœ¬ç²’å­æ•¸é‡æœ€å¤šå¤§ç´„åœ¨ 1200 å·¦å³ï¼ŒåŸ·è¡Œæ™‚é–“åœ¨ 0.5 ~ 1.2 ms ä¹‹é–“ã€‚

### forEach

ç¾åœ¨ä¾†çœ‹çœ‹ `forEach` çš„åŸ·è¡Œæ™‚é–“ã€‚

::: tip
staticMap çš„ `for` éƒ¨åˆ†ç¶­æŒä¸è®Šï¼Œå› ç‚ºé€™æ¬¡åªæ¯”è¼ƒçŸ©é™£ `forEach` èˆ‡ `for` çš„å·®ç•°ã€‚
:::

```ts
particleSystem.updateFunction = function (particles) {
  const startTime = performance.now()
  // è¨ˆç®— staticMap èˆ‡ç²’å­æ˜¯å¦æœ‰ç¢°æ’
  for (const id in staticMap) {
    const bounding = staticMap[id]
    if (!bounding)
      continue

    /** ä¾ç…§æ–‡ä»¶ä½œæ³•æ›´æ–°ç²’å­
     *
     * https://doc.babylonjs.com/features/featuresDeepDive/particles/particle_system/customizingParticles/
     */
    particles.forEach((particle, index) => {
      // ...
    })
  }

  // ...
}
```

ä¾†çœ‹çœ‹çµæœ

```text
{particles: 1163, time: 1.100000023841858}
{particles: 1168, time: 1.2000000476837158}
{particles: 1184, time: 1.2000000476837158}
{particles: 1180, time: 1}
{particles: 1171, time: 1}
{particles: 1161, time: 1.2000000476837158}
{particles: 1174, time: 1.1999999284744263}
{particles: 1166, time: 1.2999999523162842}
```

å¯ä»¥æ³¨æ„åˆ°è€—æ™‚å¤šäº†ä¸€é»é»ï¼ŒåŸ·è¡Œæ™‚é–“åœ¨ 1 ~ 1.3 ms ä¹‹é–“ã€‚

### for of

å†ä¾†è©¦è©¦çœ‹ `for of`ã€‚

```ts
particleSystem.updateFunction = function (particles) {
  const startTime = performance.now()
  // è¨ˆç®— staticMap èˆ‡ç²’å­æ˜¯å¦æœ‰ç¢°æ’
  for (const id in staticMap) {
    const bounding = staticMap[id]
    if (!bounding)
      continue

    /** ä¾ç…§æ–‡ä»¶ä½œæ³•æ›´æ–°ç²’å­
     *
     * https://doc.babylonjs.com/features/featuresDeepDive/particles/particle_system/customizingParticles/
     */
    let index = -1
    for (const particle of particles) {
      index++
      // ...
    }
  }

  // ...
}
```

çµæœï¼š

```text
{particles: 1189, time: 1.2000000476837158}
{particles: 1186, time: 1.5}
{particles: 1185, time: 1.5}
{particles: 1182, time: 1.100000023841858}
{particles: 1190, time: 0.7999999523162842}
{particles: 1188, time: 1.100000023841858}
{particles: 1187, time: 1.399999976158142}
{particles: 1185, time: 2.1999999284744263}
{particles: 1181, time: 1.1999999284744263}
{particles: 1186, time: 1}
```

å’Œ `for` å·®ä¸å¤šï¼Œä½†æ˜¯å¶è€Œæœƒè·‘å‡º 2 ms çš„æ™‚é–“ã€‚

## æš´é¢¨é›ªï¼

å·®ç•°ä¸å¤§å¥½åƒä¸å¤ ç²¾å½©ï¼Œè®“æˆ‘å€‘æŠŠç²’å­æ•¸é‡åŠ å¥½åŠ æ»¿ï¼Œè®Šæˆæš´é¢¨é›ªçœ‹çœ‹ï¼áƒšï¼ˆÂ´âˆ€`áƒšï¼‰

![snowstorm](/for-each-and-for-loop/snowstorm.png)

è¶…å¤šé›ªï¼á••( ï¾Ÿ âˆ€ã€‚)á•—

`for`

```text
{particles: 98017, time: 354}
{particles: 97970, time: 360.10000002384186}
{particles: 98122, time: 340}
{particles: 98118, time: 342.7000000476837}
{particles: 98035, time: 355.2000000476837}
{particles: 98069, time: 348.60000002384186}
```

`forEach`

```text
{particles: 98170, time: 311.5}
{particles: 98275, time: 304.09999990463257}
{particles: 98491, time: 273.5}
{particles: 98092, time: 356}
{particles: 97463, time: 472.7000000476837}
{particles: 98080, time: 342}
```

`for of`

```text
{particles: 99421, time: 110.09999990463257}
{particles: 99365, time: 122.20000004768372}
{particles: 99052, time: 181.59999990463257}
{particles: 98330, time: 289.3000000715256}
{particles: 97579, time: 390.7999999523163}
{particles: 98233, time: 329.3000000715256}
```

ç²’å­æ•¸é‡å¤§ç´„åœ¨ 98k å·¦å³ï¼Œå¯ä»¥çœ‹åˆ°çµæœå¾ˆæœ‰è¶£ï¼š

- `for` èˆ‡ `forEach` æ™‚é–“å·®ä¸å¤šï¼Œä½†æ˜¯ `for` æ¯”è¼ƒç©©å®š
- `for of` æœ€å¿«ï¼Œä½†å¶è€Œæœƒè®Šæ…¢ã€‚

ä»¥ä¸Šå°±æ˜¯é€™æ¬¡çš„è¶…ä¸å°ˆæ¥­çš„ä¸åš´è¬¹å¯¦é©—ã€‚à©­ Ë™á—œË™ )à©­

ç©¶ç«Ÿèª°æ¯”è¼ƒå¿«ï¼Œæœƒå› ç‚ºæƒ…å¢ƒã€runtimeã€ç€è¦½å™¨æœ€ä½³åŒ–èˆ‡ç¨‹å¼å¯«æ³•è€Œæœ‰æ‰€ä¸åŒï¼Œæœ€å¥½æ‡‰è©²å¯¦éš›è·‘é benchmark å†åšé¸æ“‡ã€‚

## ç¸½çµ ğŸŸ

- å…ƒç´ æ•¸é‡ä¸å¤šæ™‚ï¼Œ`forEach` èˆ‡ `for` å·®ç•°ä¸å¤§ã€‚
- æ€§èƒ½æœƒå› æƒ…å¢ƒã€runtimeã€ç€è¦½å™¨æœ€ä½³åŒ–èˆ‡ç¨‹å¼å¯«æ³•è€Œæœ‰æ‰€ä¸åŒï¼Œæœ€å¥½æ‡‰è©²å¯¦éš›è·‘é benchmark å†åšé¸æ“‡ã€‚
