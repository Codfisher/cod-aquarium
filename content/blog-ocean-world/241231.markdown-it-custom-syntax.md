---
title: 臉被切到了怎麼辦！來自定義 markdown 語法吧
description: 顏文字換行會原地變為一坨亂碼，該怎麼辦呢？(PД`q｡)
tags: ['markdown-it']
image: https://codlin.me/markdown-it-custom-syntax.webp
date: 20241231
draft: true
---

# 臉被切到了怎麼辦！來自定義 markdown 語法吧

![markdown-it-custom-syntax](/markdown-it-custom-syntax.webp)

段落文字太長時，在句尾的顏文字很容易被換行，像這樣 (＃°
Д°)

一秒便變成了一坨不知所云的亂碼。%( ´•̥̥̥ ω •̥̥̥` )%

原本解法像這樣 `<span class="text-nowrap">(>'-'<)</span>`

把顏文字用 HTML 包起來，雖然有效，但是實在不夠~~懶人~~優雅。%( ・ิω・ิ)%

既然此部落格基於 markdown 寫作，那麼就來調整一下 markdown-it 吧！%◝(≧∀≦)◟%

## 自定義語法

markdown-it 設計之初就考慮到了擴展性，自定義語法小菜一碟。

查了一圈 markdown 還沒被使用的符號，看起來 `%` 還不錯，所以預計使用 % 符號建立一個決不換行的區塊。

也就是 `%(>'-'<)%` 自動變為 `<span class="text-nowrap">(>'-'<)</span>`

首先建立一個 plugin。

`.vitepress\plugin\markdown-it-nowrap.ts`

```ts
import type { Token } from 'markdown-it'
import type MarkdownIt from 'markdown-it'

type RuleInline = Parameters<
  MarkdownIt['inline']['ruler']['before']
>[2]

/** 使用 % 包圍文字，即可建立不換行的元素
 * https://vitepress.dev/guide/markdown#advanced-configuration
 *
 * @param md
 */
export function markdownItNowrap(md: MarkdownIt) {
  /** 解析 % 區塊 */
  const parsePercentSyntax: RuleInline = (state, silent) => {
    const start = state.pos
    const marker = '%'

    // 如果不是 %，直接跳過
    if (state.src[start] !== marker) {
      return false
    }

    const end = state.src.indexOf(marker, start + 1)
    if (end === -1) {
      return false
    }

    if (!silent) {
      const token = state.push('nowrap_span', '', 0)
      token.content = state.src.slice(start + 1, end).trim()
    }

    state.pos = end + 1
    return true
  }

  /** 渲染 nowrap_span 區塊內容 */
  function renderPercentSyntax(tokens: Token[], idx: number) {
    if (!tokens[idx]?.content) {
      return ''
    }

    return `<span class="text-nowrap">${tokens[idx].content}</span>`
  }

  // 插件註冊
  md.inline.ruler.before('emphasis', 'nowrap_span', parsePercentSyntax)
  md.renderer.rules.nowrap_span = renderPercentSyntax
}
```

接著依照[文件指示](https://vitepress.dev/guide/markdown#advanced-configuration)，在 vitepress 使用 plugin。

`.vitepress\config.mts`

```ts
// ...

// https://vitepress.dev/reference/site-config
export default ({ mode }: { mode: string }) => {
  // ...

  return withMermaid({
    title: '鱈魚的魚缸',
    // ...

    markdown: {
      lineNumbers: true,
      config(md) {
        md.use((md) => markdownItBaseImg(md, mode))
        md.use(markdownItNowrap) // [!code ++]
      },
    },

    // ...
  })
}
```

完工！

現在被 % 包圍的文字都會自動變成帶有 text-nowrap class 的 `span` 了！

![nowrap-span](/markdown-it-custom-syntax/nowrap-span.png)

好像太快惹，藉這個機會來好好研究一下 markdown-it 好惹。

## markdown-it 語法

## 總結 🐟
