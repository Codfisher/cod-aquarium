---
description: å¦‚ä½•å¯¦ç¾éˆæ´»çš„è³‡æ–™æ’åº
tags: ['Algorithm', 'JavaScript']
image: https://codlin.me/flexible-data-reordering.webp
date: 20250807
---

![flexible-data-reordering](/flexible-data-reordering.webp){.cover}

# å¦‚ä½•å¯¦ç¾éˆæ´»çš„è³‡æ–™æ’åº

æœ€è¿‘é‡åˆ°ä»»æ„æ’åºè³‡æ–™çš„éœ€æ±‚ï¼Œç ”ç©¶äº†ä¸€è¼ªå¾Œæ‰¾åˆ°äº†ä¸€å€‹æœ‰è¶£çš„è§£æ±ºæ–¹æ¡ˆã€‚

æ–¹æ¡ˆæ˜¯ä¸€å€‹åç‚º Fractional indexing çš„æ¼”ç®—æ³•ï¼Œèƒ½å¤ å¯¦ç¾éˆæ´»çš„è³‡æ–™æ’åºã€‚

å…¶ç‰¹é»ç‚ºèƒ½å¤ åœ¨ç¾æœ‰æ¸…å–®ä¸­ä»»æ„ä½ç½®æ’å…¥æ–°è³‡æ–™ä¸”ä¸æ”¹è®Šå…¶ä»–è³‡æ–™é †åºçš„æƒ…æ³ä¸‹é€²è¡Œæ’åºã€‚

æ›å€‹æ¯”å–»ï¼Œå°±åƒæ˜¯å¯ä»¥åœ¨ä¸è®Šæ›´å…¶ä»–äººè™Ÿç¢¼ç‰Œçš„æƒ…æ³ä¸‹ï¼Œè®“ä½ æ‰‹ä¸Šçš„è™Ÿç¢¼ç‰Œè®Šæˆä»»æ„ä½ç½®ï¼Œå¯ä»¥éš¨æ„æ’éšŠçš„æ„Ÿè¦ºã€‚%â—( â€¢Ï‰â€¢ )â—Ÿ%

è®“æˆ‘å€‘ä¸€æ­¥æ­¥æ¢è¨çœ‹çœ‹ã€‚

## å¦‚ä½•æ’åºï¼Ÿ

å¦‚ä½•è‡ªç”±èª¿æ•´è³‡æ–™æ’åºå‘¢ï¼Ÿ%áƒš(â•¹Îµâ•¹áƒš)%

æœ‰äººå¯èƒ½æœƒæƒ³èªªï¼šã€Œé˜¿ä¸å°±èª¿æ•´çŸ©é™£é †åºå°±å¥½äº†ï¼Ÿ%( Ë˜ï½¥Ğ·ï½¥)%ã€

ä¸éé‚£æ˜¯åœ¨åŒä¸€å€‹çŸ©é™£ä¸­æ‰æœ‰è¾¦æ³•ï¼Œå¦‚æœæ˜¯å¾ DB å–å‡ºä¾†å‘¢ï¼Ÿ

DB å…§çš„è³‡æ–™é€šå¸¸éƒ½åªèƒ½ä¾é æŸå€‹æ¬„ä½é€²è¡Œæ’åºå–å€¼ï¼Œä¸èƒ½åƒçŸ©é™£æ›å€‹ä½ç½®å°±è¡Œã€‚

èˆ‰å€‹é¡æ¯”æƒ…å¢ƒï¼Œå°±åƒæ˜¯ `object` çš„ key-value è³‡æ–™é‚£æ¨£ï¼Œä¾‹å¦‚ï¼š

```ts
const data = {
  1: {
    name: 'cod',
    age: 10,
  },
  2: {
    name: 'cat',
    age: 1,
  },
  3: {
    name: 'dog',
    age: 4,
  },
}
```

éœ€è¦å°‡æ­¤ `data` å…§å®¹è½‰æ›æˆçŸ©é™£ï¼Œè‹¥ä¾æ“š `age` æ’å‡åºå‰‡ç‚ºï¼š

```ts
const list = [
  {
    name: 'cat',
    age: 1,
  },
  {
    name: 'dog',
    age: 4,
  },
  {
    name: 'cod',
    age: 10,
  },
]
```

`object` ä¸æœƒä¿è­‰è³‡æ–™é †åºï¼Œæ‰€ä»¥ç›´æ¥è½‰æ›æˆ `array` ä¸èƒ½ä¿è­‰é †åºæ­£ç¢ºï¼Œä¸€å®šè¦å…ˆ `sort()` æ‰è¡Œã€‚

å‰›å‰›ä¾ `age` æ¬„ä½æ’åºï¼Œç¾åœ¨éœ€æ±‚æ”¹æˆå¯ä»¥éš¨æ„èª¿æ•´è³‡æ–™é †åºï¼Œè©²æ€éº¼åšå‘¢ï¼Ÿ

å¤§å®¶å¯èƒ½æ‡‰è©²éƒ½æƒ³åˆ°æ–¹æ³•äº†ï¼Œæ–°å¢ä¸€å€‹ `order` æ¬„ä½ä¸å°±å¥½äº†å—ï¼Ÿ

```ts
const data = {
  1: {
    name: 'cod',
    age: 10,
    order: 1,
  },
  2: {
    name: 'cat',
    age: 1,
    order: 2,
  },
  3: {
    name: 'dog',
    age: 4,
    order: 3,
  },
}
```

è‹¥è¦ç§»å‹•ä½ç½®ï¼Œåªéœ€è¦èª¿æ•´ `order` æ¬„ä½çš„å€¼å³å¯ã€‚

ä¾‹å¦‚ï¼šè¦å°‡ `dog` ç§»åˆ° `cat` å‰é¢ï¼Œåªéœ€è¦å°‡ `dog` çš„ `order` æ”¹æˆ `1.5` å³å¯ã€‚

é€™å°±æ˜¯ Fractional indexing çš„æ ¸å¿ƒæ¦‚å¿µï¼%( â€¢Ì€ Ï‰ â€¢Ì )âœ§%

ä¸éæ­¤æ¼”ç®—æ³•çš„æ•¸å€¼ç¯„åœä½¿ç”¨ 0 åˆ° 1 ä¹‹é–“çš„æµ®é»æ•¸ã€‚

::: tip
è‡³æ–¼ç‚ºç”šéº¼æ˜¯ 0 åˆ° 1 ä¹‹é–“ï¼Œé€™å€‹å€’æ˜¯æ²’æœ‰ç‰¹åˆ¥æ‰¾åˆ°å…·é«”çš„åŸå› ï¼Œè‹¥æœ‰å¤§å¤§çŸ¥é“ç‚ºç”šéº¼é‚„è«‹ä¸åå‘Šè¨´æˆ‘ã€‚%(*Â´âˆ€`)~â™¥%
:::

æ­¤æ¼”ç®—æ³•ä¾†è‡ªé¼é¼å¤§åçš„ Figmaï¼Œå…¶ CTO åˆ†äº«çš„[é€™ç¯‡æ–‡ç« ](https://madebyevan.com/algos/crdt-fractional-indexing/)ã€‚

æ–‡ç« å…§æœ‰å¾ˆç”Ÿå‹•çš„äº’å‹•æ•ˆæœï¼Œèƒ½å¤ è®“äººæ›´ç›´è¦ºåœ°ç†è§£ Fractional indexing é‹ä½œæ–¹å¼ã€‚

## æµ®é»æ•¸ç²¾åº¦

ä¸éé€™è£¡é‚„æœ‰å€‹å°å•é¡Œï¼Œå°±æ˜¯æµ®é»æ•¸çš„ç²¾åº¦æœ‰é™ï¼Œè‹¥äº¤æ›å¤ªå¤šæ¬¡å¯èƒ½æœƒå°è‡´å› ç²¾åº¦ä¸è¶³ï¼Œè®“æ’åºç•°å¸¸ã€‚

ä»¥ JS çš„æ•¸å­—ï¼ˆIEEE 754 çš„ 64 ä½å…ƒé›™ç²¾åº¦æµ®é»æ•¸ï¼‰ç‚ºä¾‹ï¼Œå°æ•¸é»å¾Œå¤§ç´„å¯ä»¥æ­£ç¢ºè¡¨ç¤ºåˆ° 15~17 ä½æ•¸å­—ï¼Œè‹¥è¶…éé€™å€‹ç¯„åœï¼Œæœƒå‡ºç¾æ•¸å€¼éºå¤±å•é¡Œã€‚

æœ‰æ²’æœ‰å¯ä»¥å­˜å¥½å­˜æ»¿çš„æ–¹æ³•å‘¢ï¼Ÿ

é‚£å°±ç”¨å­—ä¸²å§ï¼åŒæ™‚ä½¿ç”¨ Base62 ç·¨ç¢¼ï¼Œè®“å­—ä¸²çŸ­ä¸€é»ã€‚%(ãƒ»âˆ€ãƒ»)ï¼™%

::: tip
JS æœ‰æ™‚å€™ä¹Ÿæœƒä½¿ç”¨å­—ä¸²è¡¨ç¤ºæ•¸å€¼ï¼Œé¿å…æ½›åœ¨çš„ç²¾åº¦æå¤±å•é¡Œã€‚

[Decimal.js](https://github.com/MikeMcl/decimal.js?tab=readme-ov-file#use:~:text=it%20is%20recommended%20to%20pass%20strings%20rather%20than%20numbers%20to%20avoid%20a%20potential%20loss%20of%20precision.)
:::

ç”šéº¼æ˜¯ Base62 ç·¨ç¢¼ï¼Ÿé€™æ˜¯ä¸€ç¨®å°‡è³‡æ–™è½‰æ›æˆåªåŒ…å« 62 å€‹å¯åˆ—å°å­—å…ƒçš„ç·¨ç¢¼æ–¹å¼

62 å€‹å­—å…ƒåŒ…æ‹¬ï¼š

- æ•¸å­—ï¼š0 åˆ° 9ï¼ˆå…± 10 å€‹ï¼‰
- å¤§å¯«è‹±æ–‡å­—æ¯ï¼šA åˆ° Zï¼ˆå…± 26 å€‹ï¼‰
- å°å¯«è‹±æ–‡å­—æ¯ï¼ša åˆ° zï¼ˆå…± 26 å€‹ï¼‰

ç¸½å…±ï¼š10 + 26 + 26 = 62 å€‹å­—å…ƒ

èˆ‰å€‹ä¾‹å­ï¼š%( Â´ â–½ ` )ï¾‰ğŸŒ°%

å‡è¨­è¦å°‡åé€²ä½çš„æ•¸å­— 125 è½‰æˆ Base62 ç·¨ç¢¼

1. 125 Ã· 62 = 2 é¤˜ 1 â†’ ç¬¬ä¸€å€‹å­—å…ƒæ˜¯ 1
1. 2 Ã· 62 = 0 é¤˜ 2 â†’ ç¬¬äºŒå€‹å­—å…ƒæ˜¯ 2

æœ€çµ‚å¾—åˆ° 125 çš„ Base62 ç·¨ç¢¼ç‚º 21

æ‰€ä»¥ [Fractional Indexing](https://github.com/rocicorp/fractional-indexing?tab=readme-ov-file#generatekeybetween) ç¯„ä¾‹ç¨‹å¼ç¢¼æ‰æœƒéƒ½æ˜¯å¥‡æ€ªçš„è‹±æ–‡æ•¸å­—çµ„åˆï¼š

```ts
import { generateKeyBetween } from 'fractional-indexing'

const first = generateKeyBetween(null, null) // "a0"

// Insert after 1st
const second = generateKeyBetween(first, null) // "a1"

// Insert after 2nd
const third = generateKeyBetween(second, null) // "a2"

// Insert before 1st
const zeroth = generateKeyBetween(null, first) // "Zz"

// Insert in between 2nd and 3rd (midpoint)
const secondAndHalf = generateKeyBetween(second, third) // "a1V"
```

## æ‰€ä»¥æˆ‘èªªé‚£å€‹ç¨‹å¼ç¢¼å‘¢ï¼Ÿ

è®“æˆ‘å€‘ç”¨å·¥ç¨‹å¸«çš„èªè¨€ä¾†å°è©±å§ï¼ä¾†äººå•Šï¼Œä¸Šç¨‹å¼ç¢¼ï¼%(â‰–â€¿ã‚â‰–)âœ§%

é€™è£¡å¯¦ä½œä½¿ç”¨ [`fractional-indexing-jittered`](https://www.npmjs.com/package/fractional-indexing-jittered) é€™å€‹å¥—ä»¶ã€‚

è®“æˆ‘å€‘æ–°å¢ä¸€å€‹ `createDataManager` function å»ºç«‹ä¸€å€‹ç®¡ç†è³‡æ–™æ’åºçš„ç‰©ä»¶ã€‚

é¦–å…ˆæ–°å¢ä¸€äº›é æœŸå¯èƒ½ç”¨åˆ°çš„åŸºç¤æ–¹æ³•ã€‚

`content\blog-ocean-world\flexible-data-reordering\index.ts`

```ts
export function createDataManager<Data>() {
  const dataMap: Map<string, {
    data: Data;
    order: string;
  }> = new Map()

  return {
    add(data: Data) {
      return ''
    },

    moveBefore(
      id: string,
      targetId: string,
    ) { },

    moveAfter(
      id: string,
      targetId: string,
    ) { },

    delete(id: string) { },

    getAll() {
      return []
    },
  }
}
```

æ¥è‘—è®“æˆ‘å€‘æ–°å¢æ¸¬è©¦æª”æ¡ˆèˆ‡æ¸¬è©¦æ¡ˆä¾‹ã€‚

`content\blog-ocean-world\flexible-data-reordering\index.test.ts`

```ts
import { describe, expect, it } from 'vitest'
import { createDataManager } from './'

interface Data {
  name: string;
  value: number;
}

describe('createDataManager', () => {
  it('æ–°å¢è³‡æ–™ä¸¦å–å¾—æ‰€æœ‰è³‡æ–™', () => {
    const manager = createDataManager<Data>()
    manager.add({ name: 'a', value: 1 })
    manager.add({ name: 'b', value: 2 })

    const allData = manager.getAll()

    expect(allData).toHaveLength(2)
    expect(allData[0]?.name).toBe('a')
    expect(allData[1]?.name).toBe('b')
  })

  it('æ ¹æ“š id åˆªé™¤è³‡æ–™', () => {
    const manager = createDataManager<Data>()
    const aId = manager.add({ name: 'a', value: 1 })
    manager.add({ name: 'b', value: 2 })

    manager.delete(aId)

    const allData = manager.getAll()
    expect(allData).toHaveLength(1)
    expect(allData[0]?.name).toBe('b')
  })

  it('å¯ä»¥ç§»å‹•è³‡æ–™åˆ°æŒ‡å®šè³‡æ–™ä¹‹å¾Œ', () => {
    const manager = createDataManager<Data>()
    const aId = manager.add({ name: 'a', value: 1 })
    const bId = manager.add({ name: 'b', value: 2 })
    const cId = manager.add({ name: 'c', value: 3 })

    manager.moveAfter(aId, cId)

    const allData = manager.getAll()
    expect(
      allData.map((d) => d.name),
    ).toEqual(['b', 'c', 'a'])
  })

  it('å¯ä»¥ç§»å‹•è³‡æ–™åˆ°æŒ‡å®šè³‡æ–™ä¹‹å‰', () => {
    const manager = createDataManager<Data>()
    const aId = manager.add({ name: 'a', value: 1 })
    const bId = manager.add({ name: 'b', value: 2 })
    const cId = manager.add({ name: 'c', value: 3 })

    manager.moveBefore(bId, aId)

    const allData = manager.getAll()
    expect(
      allData.map((d) => d.name),
    ).toEqual(['b', 'a', 'c'])
  })
})
```

åŸ·è¡Œæ¸¬è©¦ï¼Œçµæœå…¨éƒ¨å¤±æ•—ï¼Œä¸æ„å¤–ï¼Œå› ç‚ºé‚„æ²’æœ‰å¯¦ä½œä»»ä½•é‚è¼¯ï¼Œå¦‚æœå…¨éæˆ‘æœƒæ¯”è¼ƒé©šè¨ã€‚%(Â´ãƒ»Ï‰ãƒ»`)%

ç¾åœ¨è®“æˆ‘å€‘å®Œæˆå¯¦ä½œå§ï¼%ãƒ¾(â—'à±ª`â—)ï¾‰ï¾%

`content\blog-ocean-world\flexible-data-reordering\index.ts`

```ts
import { generateKeyBetween } from 'fractional-indexing-jittered'

export function createDataManager<Data>() {
  const dataMap: Map<string, {
    data: Data;
    order: string;
  }> = new Map()

  function getDataEntriesList() {
    return Array
      .from(dataMap)
      .sort((a, b) => a[1].order < b[1].order ? -1 : 1)
  }

  return {
    add(data: Data) {
      const id = crypto.randomUUID()
      const lastData = getDataEntriesList().at(-1)

      const order = generateKeyBetween(
        lastData?.[1].order ?? null,
        null,
      )
      dataMap.set(id, { data, order })
      return id
    },
    moveBefore(
      id: string,
      targetId: string,
    ) {
      const currentData = dataMap.get(id)
      if (!currentData)
        return
      const targetData = dataMap.get(targetId)
      if (!targetData)
        return

      const dataList = getDataEntriesList()
      const targetIndex = dataList.findIndex((item) => item[0] === targetId)
      const prevTarget = dataList[targetIndex - 1]

      const newOrder = generateKeyBetween(
        prevTarget?.[1].order ?? null,
        targetData.order,
      )
      currentData.order = newOrder
      dataMap.set(id, currentData)
    },
    moveAfter(
      id: string,
      targetId: string,
    ) {
      const currentData = dataMap.get(id)
      if (!currentData)
        return
      const targetData = dataMap.get(targetId)
      if (!targetData)
        return

      const dataList = getDataEntriesList()
      const targetIndex = dataList.findIndex((item) => item[0] === targetId)
      const nextTarget = dataList[targetIndex + 1]

      const newOrder = generateKeyBetween(
        targetData.order,
        nextTarget?.[1].order ?? null,
      )
      currentData.order = newOrder
      dataMap.set(id, currentData)
    },
    delete(id: string) {
      dataMap.delete(id)
    },

    getAll() {
      return getDataEntriesList()
        .map(([_, { data }]) => data)
    },
  }
}
```

æ²’æ„å¤–çš„è©±ï¼Œç¾åœ¨æ¸¬è©¦æ‡‰è©²å…¨éƒ¨é€šéäº†ã€‚

åœ¨ `getDataEntriesList` ä¸­ log ä¸€ä¸‹å…§å®¹ï¼Œè§€å¯Ÿçœ‹çœ‹ `order` æ¬„ä½çš„å€¼ã€‚

```txt
{ data: { name: 'b', value: 2 }, order: 'a1' }

{ data: { name: 'b', value: 2 }, order: 'a1' }

{ data: { name: 'b', value: 2 }, order: 'a1' }
{ data: { name: 'c', value: 3 }, order: 'a2' }
{ data: { name: 'a', value: 1 }, order: 'a3' }

{ data: { name: 'b', value: 2 }, order: 'Zz' }
{ data: { name: 'a', value: 1 }, order: 'a0' }
{ data: { name: 'c', value: 3 }, order: 'a2' }
```

å¯ä»¥ç™¼ç¾å…§å®¹èˆ‡å®˜æ–¹ç¯„ä¾‹ç¨‹å¼ç¢¼ä¸€è‡´ï¼Œç›¸ç•¶æœ‰è¶£ã€‚%(Â´,,â€¢Ï‰â€¢,,)%

::: tip
é€™è£¡çš„æ¸¬è©¦æ¡ˆä¾‹åªæœ‰ç°¡å–®é©—è­‰ï¼Œæ²’æœ‰è€ƒæ…®åˆ°å…¶ä»–æ¡ˆä¾‹èˆ‡é‚Šç•Œæƒ…æ³ï¼Œå¤§å®¶æœ‰èˆˆè¶£å¯ä»¥è‡ªå·±æ“´å……æ¸¬è©¦ã€‚%( â€§Ï‰â€§)ãƒâ•°(â€§Ï‰â€§ )%
:::

å®Œæ•´ç¨‹å¼ç¢¼å¯ä»¥åœ¨[é€™è£¡æ‰¾åˆ°](https://github.com/Codfisher/cod-aquarium/blob/main/content/blog-ocean-world/flexible-data-reordering)ã€‚

## ç¸½çµ ğŸŸ

- Fractional indexing æ¼”ç®—æ³•èƒ½å¤ å¯¦ç¾éˆæ´»çš„è³‡æ–™æ’åºï¼Œè®“è³‡æ–™å¯ä»¥ä»»æ„æ’éšŠã€‚
- æµ®é»æ•¸æœ‰ç²¾åº¦å•é¡Œï¼Œä½¿ç”¨ Base62 ç·¨ç¢¼çš„å­—ä¸²è¡¨ç¤ºæ•¸å€¼ï¼Œå¯ä»¥é¿å…ç²¾åº¦æå¤±ã€‚
