---
title: å‰å¾Œç«¯ä¸å†æ‰“æ¶ï¼Œè®“ ts-rest ç™¼æ® TypeScript çš„é­”æ³•å§ï¼ï¼ˆå¯¦å‹™ç¯‡ï¼‰
description: ç´€éŒ„ä¸€ä¸‹ä½¿ç”¨ ts-rest å¯¦éš›é–‹ç™¼çš„é»é»æ»´æ»´
tags: ['Full Stack', 'TypeScript', 'ts-rest']
image: https://codlin.me/unleash-the-magic-of-type-script-with-ts-rest-practical-experience.webp
date: 20250814
---

![unleash-the-magic-of-type-script-with-ts-rest](/unleash-the-magic-of-type-script-with-ts-rest-practical-experience.webp){.cover}

# å‰å¾Œç«¯ä¸å†æ‰“æ¶ï¼Œè®“ ts-rest ç™¼æ® TypeScript çš„é­”æ³•å§ï¼ï¼ˆå¯¦å‹™ç¯‡ï¼‰

è·é›¢ä¸Šæ¬¡[æ¦‚å¿µç¯‡](/blog-ocean-world/unleash-the-magic-of-type-script-with-ts-rest)ä¹Ÿå¿«ä¸€å¹´äº†ï¼Œæ™‚é–“éå¾—çœŸå¿«ã€‚%(Â´ãƒ»Ï‰ãƒ»`)%

æœ¬æ–‡å»¶çºŒæ¦‚å¿µç¯‡å…§å®¹ï¼Œç´€éŒ„ä¸€äº›å¯¦ä½œç­†è¨˜ï¼Œå¤§å®¶è‹¥æœ‰æ›´å¥½çš„åšæ³•é‚„è«‹ä¸åæŒ‡æ•™ã€‚%(*Â´âˆ€`)~â™¥%

æŠ€è¡“å †ç–Šä»¥ Vueã€NestJS ç‚ºä¾‹ï¼Œç›¸é—œå¥—ä»¶ç‰ˆæœ¬å¦‚ä¸‹ï¼š

- @nestjs/coreï¼š`11.1.5`
- @ts-rest/coreï¼š`3.52.1`
- @ts-rest/nestï¼š`3.52.1`
- zodï¼š`3.25.76`

::: tip
ts-rest é è¨ˆ `^3.53.0` é–‹å§‹æ”¯æ´ [`Standard Schema`](https://github.com/standard-schema/standard-schema) é©—è­‰ï¼Œåªè¦æ”¯æ´æ­¤è¦ç¯„çš„é©—è­‰å™¨ï¼ˆä¾‹ï¼š[Zod v4](https://zod.dev/v4)ã€[Valibot](https://valibot.dev/guides/introduction/)ã€[ArkType](https://arktype.io/)ï¼‰çš„é©—è­‰å™¨éƒ½å¯ä»¥ç”¨ä¾†å®šç¾©åˆç´„è³‡æ–™ï¼Œä¸é™æ–¼ Zod äº†ï¼%âœ§â‘ï½¡Ù©(ËŠá—œË‹*)Ùˆâœ§â•ï½¡%
:::

æœ¬æ–‡åˆ†æˆ 3 å€‹ä¸»è¦éƒ¨åˆ†ï¼š

1. é€šç”¨æ¦‚å¿µ

    ä¸åˆ†å‰å¾Œç«¯çš„æ³¨æ„äº‹é …èˆ‡å¿ƒå¾—

1. å‰ç«¯

    å‰ç«¯ ts-rest æ‡‰ç”¨ï¼ŒåŒ…å«åˆå§‹åŒ– Clientã€ç‹€æ…‹èˆ‡çµæœè³‡æ–™ã€è¡¨å–®è³‡æ–™é©—è­‰ç­‰

1. å¾Œç«¯

    å¾Œç«¯ ts-rest æ‡‰ç”¨ï¼ŒåŒ…å«å®šç¾© API åˆç´„ã€é©—è­‰è³‡æ–™ã€è™•ç†è«‹æ±‚ç­‰

è®“æˆ‘å€‘é–‹å§‹å§ï¼%â™ª( â—œÏ‰â—Ùˆ(Ùˆ%

::: tip ä¸å®šæœŸæ›´æ–°
æœ¬ç‚º ts-rest æ‡‰ç”¨ç­†è¨˜ï¼Œæœƒéš¨è‘—æ™‚é–“æ¨ç§»è€Œè®ŠåŒ–ã€æ›´æ–°ï¼Œç”šè‡³éæ™‚ï¼Œè«‹å¤§å®¶å¤šå¤šåŒ…æ¶µã€‚
:::

## é€šç”¨æ¦‚å¿µ

### jsonQuery

ä¸€èˆ¬ä¾†èªª REST API çš„ query string æœƒè¢«è¦–ç‚ºå­—ä¸²ï¼Œå…¶ä¸­æ•¸å­—èˆ‡çŸ©é™£å¯èƒ½æœƒå‡ºç¾æ­§ç•°ã€‚

#### æ•¸å­—èˆ‡å¸ƒæ—

è‹¥ URL ç‚º `/posts?take=10&draft=false`

ä¼ºæœå™¨æœƒå–å¾— `{ take: "10", draft: "false" }`ï¼Œå¯ä»¥çœ‹åˆ°å…§å®¹éƒ½æ˜¯å­—ä¸²ã€‚

ä½ å¯èƒ½æœƒèªªï¼šZod å¯ä»¥ç”¨ `z.coerce.number()`ã€`z.coerce.boolean()` è½‰æ›å•Šï¼Ÿ

é€™è£¡æœ‰å€‹[éš±è—çš„å°åœ°é›·](https://github.com/colinhacks/zod/issues/1630)ï¼Œå°±æ˜¯å­—ä¸²çš„ `"true"` èˆ‡ `"false"`ï¼Œç¶“é `z.coerce.boolean()` éƒ½æœƒè®Šæˆ `true`ï¼%â•­(Â°A ,Â°`)â•®%

å¦‚æœæœ‰é–‹å•Ÿ jsonQueryï¼ˆå‰ç«¯å¾Œç«¯éƒ½è¦é–‹ï¼‰

ä¼ºæœå™¨æœƒå–å¾— `{ take: 10, draft: false }`ï¼Œä¸éœ€è¦å†æ¬¡è½‰æ›ã€‚

#### çŸ©é™£

è‹¥ URL ç‚º `/posts?tags=js&tags=ts`

server æœƒæ‹¿åˆ° `['js', 'ts']`ï¼Œä½†è‹¥ `tags` åªæœ‰ä¸€å€‹å‘¢ï¼Ÿ

URL è®Šç‚º `/posts?tags=cod`

é€™æ¨£ server å–åˆ°çš„åƒæ•¸å¯èƒ½æœƒè®Šæˆè³‡æ–™ç‚º `'cod'` çš„ `tags` å­—ä¸²ï¼Œè€Œä¸æ˜¯å…§å®¹åªæœ‰ `['cod']` çš„ `tags` å­—ä¸²çŸ©é™£ï¼ %Î£(ËŠĞ”Ë‹;)%

å¦‚æœæœ‰é–‹å•Ÿ jsonQueryï¼ˆå‰ç«¯å¾Œç«¯éƒ½è¦é–‹ï¼‰

å‰‡ URL æœƒè®Šæˆ `/posts?tags=["js","ts"]`ï¼Œå°±æ²’æœ‰ä»¥ä¸Šå•é¡Œäº†ã€‚

<br>

è·¯äººï¼šã€Œå¦‚æœ client ç«¯ä¸æ˜¯ä½¿ç”¨ ts-rest clientï¼Œæ˜¯ä¸æ˜¯å¯èƒ½æœ‰ä¸€æ¨£çš„å•é¡Œï¼Ÿã€

é±ˆé­šï¼šã€Œä½ èªªçš„æ²’éŒ¯ ...%(â€ºÂ´Ï‰`â€¹ )%ï¼Œå¦‚æœä½¿ç”¨ç«¯ä¸æ˜¯ç”¨ JSON Query Parameters ç™¼é€ï¼Œé‚„æ˜¯è¦ä¹–ä¹–çš„æŠŠåˆç´„å…§çš„é©—è­‰å™¨èˆ‡è½‰æ›å™¨å¯«å¥½å¯«æ»¿äº† %( Ë˜ï½¥Ğ·ï½¥)%ã€

### ClientInferã€ServerInfer å‚»å‚»åˆ†ä¸æ¸…æ¥šï¼Ÿ

ts-rest æœ¬èº«æä¾›äº†å¾ˆæ–¹ä¾¿çš„ [Type Helper å·¥å…·](https://ts-rest.com/contract/type-helpers)ï¼Œå¯ä»¥è¼•é¬†æå–åˆç´„å…§çš„å‹åˆ¥ã€‚

ä¸éæœ‰åˆ† ClientInfer èˆ‡ ServerInferï¼Œçœ‹çš„å‡ºä¾†ä¸€å€‹æ˜¯ Client è¦–è§’ï¼Œä¸€å€‹æ˜¯ Server è¦–è§’ï¼Œæ‰€ä»¥å…·é«”å·®åœ¨å“ªå‘¢ï¼Ÿ%(*Â´ï½¥Ğ´ï½¥)%

ç°¡å–®ä¾†èªªå°±æ˜¯é€²å»èˆ‡å‡ºä¾†çš„è³‡æ–™å‹åˆ¥ä¸åŒï¼Œå‡è¨­åˆç´„é€™éº¼å¯«ï¼š

```ts
export const collectionDataContract = contract.router({
  find: {
    method: 'GET',
    path: '/v1/collection-data',
    query: z.object({
      age: z.string().transform(Number),
    }),
    responses: {
      200: collectionDataSchema.array(),
    },
    summary: 'å–å¾— collection-data',
  },
})
```

å¯ä»¥çœ‹å‡º `age` è¼¸å…¥å‹åˆ¥æ˜¯ `string`ï¼Œä½†è¼¸å‡ºå‹åˆ¥æ˜¯ `number`ã€‚

ç¾åœ¨è®“æˆ‘å€‘å¯¦éš›çœ‹çœ‹ ClientInfer èˆ‡ ServerInfer å–å‡ºä¾†çš„ `age`

```ts
// type ç‚º string
type ClientInput = ClientInferRequest<typeof collectionDataContract>['find']['query']['age']
// type ç‚º number
type ServerInput = ServerInferRequest<typeof collectionDataContract>['find']['query']['age']
```

å° Request ä¾†èªªï¼Œclient æ˜¯æä¾›ç«¯ï¼ˆè¼¸å…¥è‡³åˆç´„ï¼‰ï¼Œè€Œ server æ˜¯æ¥æ”¶ç«¯ï¼ˆå–å¾—åˆç´„è¼¸å‡ºï¼‰ã€‚

æ‰€ä»¥å¾—åˆ° `ClientInput` ç‚º `string`ï¼Œè€Œ `ServerInput` ç‚º `number`ã€‚

ä¸é›£ç™¼ç¾åªæœ‰åœ¨è¼¸å…¥èˆ‡è¼¸å‡ºå‹åˆ¥ä¸åŒæ‰æœƒæœ‰æ˜é¡¯å·®åˆ¥ï¼Œå¦å‰‡å…©è€…å‹åˆ¥æœƒç›¸åŒã€‚

ä»¥ä¸Šå°±æ˜¯ ClientInfer èˆ‡ ServerInfer å…·é«”å·®åˆ¥ï¼Œæœ‰æ²’æœ‰æ¯”è¼ƒæ¸…æ¥šäº†å‘¢ï¼Ÿ%Ô…(Â´âˆ€` Ô…)%

## å‰ç«¯

### åˆå§‹åŒ– Client

å¦‚åŒ[æ–‡ä»¶æè¿°](https://ts-rest.com/client/fetch)ï¼Œä½¿ç”¨ `initClient` å³å¯ä»¥å°‡åˆç´„è½‰æ›æˆå¯ç›´æ¥å‘¼å«çš„ Clientã€‚

å¯ä»¥è€ƒæ…®å¤šä¸€å±¤å°è£ï¼Œæä¾›åŸºç¤è¨­å®šå€¼ï¼š

```ts
import type { AppRouter } from '@ts-rest/core'
import { initClient } from '@ts-rest/core'

const baseUrl = import.meta.env.VITE_API_BASE_URL ?? ''

export function useClient<T extends AppRouter>(
  router: T,
  options?: Parameters<typeof initClient>[1],
) {
  return initClient(router, {
    baseUrl,
    baseHeaders: {},
    jsonQuery: true,
    ...options,
  })
}
```

Client æœƒåœ¨ç¶²é ä¸­åˆ°è™•å‡ºç¾ï¼Œå¸Œæœ›ä¸è¦é‡è¤‡å»ºç«‹ï¼Œé¿å…ä¸å¿…è¦çš„è¨˜æ†¶é«”æµªè²»ã€‚

å¯ä»¥å­˜åœ¨æŸå€‹è®Šæ•¸ä¸¦ `export` çµ¦å…¶ä»–æª”æ¡ˆä½¿ç”¨ï¼Œä¸éé€™æ¨£æ¯æ¬¡å¾®èª¿ `options` éƒ½è¦å»ºç«‹å…±ç”¨è®Šæ•¸æœ‰é»éº»ç…©ï¼ˆå‘½åå¥½é›£ %(ã€‚-`Ï‰Â´-)%ï¼‰ï¼Œä½¿ç”¨ memoization æ–¹å¼è™•ç†æœƒæ›´ç°¡å–®ã€‚

::: tip ç”šéº¼æ˜¯ memoization
[å…ˆå‰çš„æ–‡ç« ](/blog-program/250321.improve-speed-using-memoization)æ›¾ç¶“èŠéï¼Œæœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥ä¾†çœ‹çœ‹
:::

é€™è£¡ç”¨ `lodash-es` æä¾›çš„ `memoize` å¯¦ä½œï¼š

```ts
import hash from 'object-hash'

export const useClient = memoize(
  <T extends AppRouter>(
    router: T,
    options?: Parameters<typeof initClient>[1],
  ) => initClient(router, {
    baseUrl,
    baseHeaders: {},
    jsonQuery: true,
    ...options,
  }),
  (router, options) => hash({ router, options }),
)
```

`hash` æ˜¯ç‚ºäº†è¨ˆç®—å¿«å–ç”¨çš„ keyï¼Œé€™è£¡ä½¿ç”¨ [`object-hash`](https://www.npmjs.com/package/object-hash) è™•ç†ï¼Œå¤§å®¶å¯ä»¥æ›æˆè‡ªå·±å–œæ­¡çš„å¯¦ä½œã€‚%ãƒ¾(â—'à±ª`â—)ï¾‰ï¾%

<br>

éœ€è¦æˆæ¬Šçš„ API éœ€è¦åœ¨ Authorization Header æä¾› Access Token æ‰èƒ½å­˜å–ï¼Œè®“æˆ‘å€‘åŠ å…¥è‡ªå‹•åŠ å…¥ Authorization Header çš„åŠŸèƒ½ï¼š

```ts
import { initClient, tsRestFetchApi } from '@ts-rest/core'

/** è‡ªå‹•åŠ å…¥ Authorization Header */
export const useClient = memoize(
  <T extends AppRouter>(
    router: T,
    options?: Parameters<typeof initClient>[1],
  ) => initClient(router, {
    baseUrl,
    baseHeaders: {},
    jsonQuery: true,
    api: async (args) => {
      const { accessToken } = useAuthStore()

      return tsRestFetchApi({
        ...args,
        headers: {
          Authorization: `Bearer ${accessToken}`,
          ...args.headers,
        },
      })
    },
    ...options,
  }),
  (router, options) => hash({ router, options }),
)
```

`api` åƒæ•¸å¯ä»¥è®“æˆ‘å€‘è‡ªå®šç¾©è«‹æ±‚å¦‚ä½•é€å‡ºã€‚%(ã‚âˆ€ãƒ»)b%

<br>

èªªåˆ° Access Tokenï¼Œå°±ä¸€å®šæœ‰ Refresh Tokenï¼Œè®“æˆ‘å€‘åŠ å…¥ 401 æ™‚è‡ªå‹• Refresh Token é‚è¼¯ï¼š

```ts
import { authContract } from '@project-code/shared'

/** è‡ªå‹•åŠ å…¥ Authorization Header ä¸” 401 æ™‚è‡ªå‹• refresh */
export const useClient = memoize(
  <T extends AppRouter>(
    router: T,
    options?: Parameters<typeof initClient>[1],
  ) => initClient(router, {
    baseUrl,
    jsonQuery: true,
    api: async (args) => {
      const authStore = useAuthStore()
      let accessToken = authStore.accessToken

      let res = await tsRestFetchApi({
        ...args,
        headers: {
          Authorization: `Bearer ${accessToken}`,
          ...args.headers,
        },
      })

      // åªæœ‰ 401 éœ€è¦è™•ç† refreshToken
      if (res.status !== 401) {
        return res
      }

      const authApi = initClient(authContract, {
        baseUrl,
        ...options,
      })

      const result = await authApi.refresh()
      if (result.status === 200) {
        accessToken = result.body.accessToken
        authStore.setAccessToken(accessToken)
      }

      /** å†ç™¼é€ä¸€æ¬¡å‰›å‰›è¢« 401 çš„è«‹æ±‚ */
      res = await tsRestFetchApi({
        ...args,
        headers: {
          Authorization: `Bearer ${accessToken}`,
          ...args.headers,
        },
      })
      if (res.status === 401) {
        // å¯åŠ å…¥è¦æ±‚ä½¿ç”¨è€…ç™»å…¥é‚è¼¯
      }

      return res
    },
    ...options,
  }),
  (router, options) => hash({ router, options }),
)
```

é€™æ™‚å€™æœ‰å€‹å°å•é¡Œï¼Œè‹¥æœ‰è«‹æ±‚åŒæ™‚ç™¼å‡ºï¼Œå°±æœƒé‡è¤‡ refresh å¾ˆå¤šæ¬¡ã€‚

ç”šéº¼ï¼Ÿä½ èªªä½ å€‘å¾Œç«¯ä¸åœ¨æ„ï¼Ÿé‚£å°±è·³...é‚„æ˜¯ä¾†åŠ å€‹åŸºæœ¬è™•ç†å¥½äº†ã€‚%(ãƒ»âˆ€ãƒ»)ï¼™%

ä½¿ç”¨ Vue çš„ `ref` èˆ‡ VueUse çš„ [`until`](https://vueuse.org/shared/until/) å¯¦ç¾åŸºæœ¬ç‰ˆï¼š

```ts
/** ç”¨æ–¼é˜²æ­¢å¤šæ¬¡ refresh */
const isRefreshing = ref(false)

/** è‡ªå‹•åŠ å…¥ Authorization Header ä¸” 401 æ™‚è‡ªå‹• refresh */
export const useClient = memoize(
  <T extends AppRouter>(
    router: T,
    options?: Parameters<typeof initClient>[1],
  ) => initClient(router, {
    baseUrl,
    jsonQuery: true,
    api: async (args) => {
      const authStore = useAuthStore()
      let accessToken = authStore.accessToken

      await until(isRefreshing).toBe(false)
      let res = await tsRestFetchApi({
        ...args,
        headers: {
          Authorization: `Bearer ${accessToken}`,
          ...args.headers,
        },
      })

      // åªæœ‰ 401 éœ€è¦è™•ç† refreshToken
      if (res.status !== 401) {
        return res
      }

      // é˜²æ­¢å¤šæ¬¡ refresh
      if (!isRefreshing.value) {
        const refreshClient = initClient(authContract, {
          baseUrl,
          ...options,
        })

        isRefreshing.value = true
        const result = await refreshClient.refresh()
        isRefreshing.value = false

        if (result.status === 200) {
          accessToken = result.body.accessToken
          authStore.setAccessToken(result.body.accessToken)
        }
      }

      await until(isRefreshing).toBe(false)
      /** å†ç™¼é€ä¸€æ¬¡å‰›å‰›è¢« 401 çš„è«‹æ±‚ */
      res = await tsRestFetchApi({
        ...args,
        headers: {
          Authorization: `Bearer ${accessToken}`,
          ...args.headers,
        },
      })
      if (res.status === 401) {
        // å¯åŠ å…¥è¦æ±‚ä½¿ç”¨è€…ç™»å…¥é‚è¼¯
      }

      return res
    },
    ...options,
  }),
  (router, options) => hash({ router, options }),
)
```

é€™æ¨£å¯ä»¥è™•ç†åŸºæœ¬ 9 æˆå¸¸è¦‹çš„æƒ…å¢ƒäº†ã€‚%â—( â€¢Ï‰â€¢ )â—Ÿ%

äºŒæ¬¡å°è£å¾Œå¯ä»¥å¾ˆè¼•é¬†åœ°åŠ å…¥å„ç¨®è‡ªå®šç¾©é‚è¼¯ï¼Œæœ‰éœ€æ±‚çš„è©±é‚„å¯ä»¥åŠ å…¥ Queue ç­‰ç­‰èŠ±å¼åŠŸèƒ½ï¼Œé€™å€‹å°±çœ‹å¯¦éš›éœ€æ±‚è€Œå®šäº†ã€‚%à©­ Ë™á—œË™ )à©­%

<br>

çœ¼å°–çš„æœ‹å‹å¯èƒ½é‚„æœ‰æ³¨æ„æ–‡ä»¶æœ‰æåˆ° [Query Client](https://ts-rest.com/client/vue-query-v4)ï¼Œå¯¦éš›ä¸Šå°±æ˜¯ Vue Queryï¼ˆTanstack Queryï¼‰ã€‚

Vue Query å…§å»ºè³‡æ–™å¿«å–ã€èƒŒæ™¯æ›´æ–°ã€è‡ªå‹•é‡è©¦ç­‰ç­‰å¼·å¤§åŠŸèƒ½ï¼Œæ¨è–¦å¤§å®¶å¯ä»¥ç©ç©çœ‹ã€‚

èˆ‡ä¸€èˆ¬çš„ Client å·®åˆ¥åœ¨åˆå§‹åŒ–èˆ‡åƒæ•¸ç¨å¾®ä¸åŒè€Œå·²ï¼Œæ‰€ä»¥ Query Client çš„å°è£åŒç†ï¼š

```ts
import { initQueryClient } from '@ts-rest/vue-query'

/** è‡ªå‹•åŠ å…¥ Authorization Header ä¸” 401 æ™‚è‡ªå‹• refresh */
export const useQueryClient = memoize(
  <T extends AppRouter>(
    router: T,
    options?: Parameters<typeof initQueryClient>[1],
  ) => initQueryClient(router, {
    baseUrl,
    baseHeaders: {},
    jsonQuery: true,
    api: async (args) => {
      // ...
    },
    ...options,
  }),
  (router, options) => hash({ router, options }),
)
```

å¯ä»¥æ³¨æ„åˆ° ts-rest æ”¯æ´åŒæ™‚ä½¿ç”¨å…©ç¨® Clientï¼Œé€™è®“å¯¦å‹™é–‹ç™¼ä¸Šæ›´æœ‰å½ˆæ€§

è³‡æ–™é‚è¼¯å¾ˆå–®ç´”çš„ç¶²é ä½¿ç”¨ä¸€èˆ¬çš„ Client å³å¯ï¼Œæœ‰è¤‡é›œéœ€æ±‚çš„éƒ¨åˆ†å†ä½¿ç”¨ Query Clientã€‚

æ­£æ‰€è¬‚å°æœ‹å‹æ‰åšé¸æ“‡ï¼Œæˆ‘å…©ç¨®éƒ½è¦ï¼%ãƒ½(â—`âˆ€Â´â—)ï¾‰%

å¦‚æ­¤å¯ä»¥è®“å°ˆæ¡ˆä¿æŒç°¡å–®ã€ä¹¾æ·¨ï¼Œæ›´ä¸å®¹æ˜“å‡ºç¾å”ä½œæ–·å±¤ã€‚%( â€§Ï‰â€§)ãƒâ•°(â€§Ï‰â€§ )%

<br>

æœ€å¾Œè®“æˆ‘å€‘ä¾†é»æ¸¬è©¦ï¼Œç¢ºèªä¸€ä¸‹ `memoize` æœ‰æ­£å¸¸å·¥ä½œï¼š

`/apps/admin-web/src/common/api.test.ts`

```ts
import { initContract } from '@ts-rest/core'
import { describe, expect, it } from 'vitest'
import { useClient } from './api'

const baseContract = initContract().router({
  create: {
    method: 'GET',
    path: '/v1/collection-data',
    responses: {},
    summary: 'å»ºç«‹ collection-data',
  },
}, {
  pathPrefix: '/api',
})

describe('api', () => {
  describe('useClient', () => {
    it(`ç›¸åŒè¨­å®šæ‡‰å–å¾—åŒä¸€å€‹å¯¦ä¾‹`, () => {
      const client1 = useClient(baseContract)
      const client2 = useClient(baseContract)

      expect(client1).toBe(client2)
    })

    it(`ä¸åŒè¨­å®šæ‡‰å–å¾—ä¸åŒå¯¦ä¾‹`, () => {
      const client1 = useClient(baseContract)
      const client2 = useClient(baseContract, {
        baseUrl: '/custom',
        baseHeaders: { a: 'a', b: 'b' },
      })

      expect(client1).not.toBe(client2)
    })

    it(`åŒæ¨£è¨­å®šä½†é †åºä¸åŒï¼Œä¹Ÿæ‡‰å–å¾—åŒä¸€å€‹å¯¦ä¾‹`, () => {
      const client1 = useClient(baseContract, {
        baseUrl: '/custom',
        baseHeaders: { a: 'a', b: 'b' },
      })
      const client2 = useClient(baseContract, {
        baseHeaders: { b: 'b', a: 'a' },
        baseUrl: '/custom',
      })

      expect(client1).toBe(client2)
    })
  })
})
```

ä»¥ä¸Šç¨‹å¼ç¢¼å¯ä»¥[åœ¨æ­¤å–å¾—](https://github.com/Codfisher/blog-ts-rest-practice/blob/main/apps/admin-web/src/common/api.ts)ã€‚

### ç‹€æ…‹èˆ‡çµæœè³‡æ–™

ts-rest å›æ‡‰çš„çµæœæœƒå°‡ HTTP Code åŒ…å«åœ¨è³‡æ–™å…§ï¼Œå…¶çµæ§‹ç¯„ä¾‹å¦‚ä¸‹ï¼š

```txt
{
  status: 200,
  body: {
    name: 'cod'
  },
  header: {}
}
```

å‡è¨­ API åˆç´„ç‚ºï¼š

```ts
const c = initContract()

export const accountContract = c.router({
  create: {
    method: 'POST',
    path: '/v1/accounts',
    body: z.object({
      username: z.string(),
      password: z.string(),
      name: z.string(),
      description: z.string().optional(),
    }),
    responses: {
      200: z.object({
        id: z.string(),
      }),
      400: z.object({
        reason: z.enum([
          'username-duplicate',
        ]).optional(),
        message: z.string(),
      }),
      401: c.noBody(),
      403: c.noBody(),
    },
    summary: 'å»ºç«‹ account',
  },
})
```

å¯ä»¥æ ¹æ“š `status` å–å¾—å…·é«”å…§å®¹ï¼Œä¾‹å¦‚ï¼š

```ts
const accountApi = useClient(accountContract)

const result = await accountApi.create({})

if (result.status === 200) {
  const newId = result.body.id
  // æç¤ºæˆåŠŸå»ºç«‹ä½¿ç”¨è€…
}

if (result.status === 400) {
  if (result.body.reason === 'username-duplicate') {
    // è™•ç†é‡è¤‡çš„ä½¿ç”¨è€…åç¨±
  }
  else {
    // è™•ç†å…¶ä»–éŒ¯èª¤
  }
}
```

é€™æ¨£å‰å¾Œç«¯åªè¦ç´„å®šå¥½ `status` æˆ–åˆ—èˆ‰è³‡æ–™ï¼ˆåƒæ˜¯ `reason` æ¬„ä½ï¼‰ï¼Œå°±å¯ä»¥ç²¾æº–è™•ç†å„ç¨®æ¥­å‹™é‚è¼¯äº†ã€‚%( Â´ â–½ ` )ï¾‰%

ç•¶ç„¶å¦‚æœä¸éœ€è¦é—œå¿ƒç´°ç¯€ï¼Œç›´æ¥æ¯”è¼ƒæ•¸å­—å³å¯ï¼š

```ts
const accountApi = useClient(accountContract)

const result = await accountApi.create({})

if (result.status >= 400) {
  // æç¤ºå»ºç«‹ä½¿ç”¨è€…å¤±æ•—
}
```

### è¡¨å–®è³‡æ–™é©—è­‰

è‹¥ UI å¥—ä»¶çš„ Form å¯ä»¥ä½¿ç”¨é©—è­‰å™¨ï¼Œå¯ä»¥ç›´æ¥èˆ‡å–å¾—åˆç´„å…§çš„é©—è­‰å™¨é€²è¡Œè¡¨å–®é©—è­‰ï¼Œä»¥ Nuxt UI Form ç‚ºä¾‹ï¼š

```vue
<script setup lang="ts">
import type { FormSubmitEvent } from '@nuxt/ui'
import { accountContract } from '@project-code/shared'
import * as z from 'zod'

const schema = accountContract.create.body
type Schema = z.output<typeof schema>

const state = reactive<Partial<Schema>>({
  email: undefined,
  password: undefined
})

const toast = useToast()
async function onSubmit(event: FormSubmitEvent<Schema>) {
  toast.add({ title: 'Success', description: 'The form has been submitted.', color: 'success' })
  console.log(event.data)
}
</script>

<template>
  <UForm
    :schema="schema"
    :state="state"
    class="space-y-4"
    @submit="onSubmit"
  >
    <UFormField label="Email" name="email">
      <UInput v-model="state.email" />
    </UFormField>

    <UFormField label="Password" name="password">
      <UInput v-model="state.password" type="password" />
    </UFormField>

    <UButton type="submit">
      Submit
    </UButton>
  </UForm>
</template>
```

è‹¥ Form ä¸èƒ½ç›´æ¥ä½¿ç”¨é©—è­‰å™¨ï¼ˆZod schemaã€ArkType type ç­‰ç­‰ï¼‰ï¼Œä¹Ÿä¸æ˜¯å¤§å•é¡Œï¼Œä¾†å€‹è½‰æ›å™¨å°±è¡Œã€‚

ä»¥æˆ‘å¸¸ç”¨çš„ Quasar ç‚ºä¾‹ï¼Œå¯ä»¥åƒè€ƒæ­¤[å¯¦ä½œ](https://github.com/Codfisher/blog-ts-rest-practice/blob/main/apps/admin-web/src/common/zod-validator.ts)ã€‚

## å¾Œç«¯

### åˆç´„ + æ¸¬è©¦ = æ›´å¯é çš„ API

å¾Œç«¯å¯¦ä½œåˆç´„åŸºæœ¬ä¸Šå°±å’Œæ¦‚å¿µç¯‡ç›¸åŒï¼Œå¯¦ä½œä¸Šæœ€é‡è¦çš„éƒ¨åˆ†æ˜¯å¯ä»¥æ‹¿åˆç´„å¯« e2e æ¸¬è©¦ï¼Œé€™æ¨£åªè¦æ¸¬è©¦æœ‰éï¼ŒAPI åŸºæœ¬ä¸Šä¸æœƒæœ‰éŒ¯æƒ¹ã€‚%Ô…(Â´âˆ€` Ô…)%

æ‰€ä»¥è¦æ€éº¼æ‹¿åˆç´„å¯« e2e æ¸¬è©¦å‘¢ï¼Ÿ

æ¦‚å¿µå¦‚ä¸‹ï¼š

1. å°‡è³‡æ–™è¼¸å…¥åˆç´„ï¼Œå–å¾— API è«‹æ±‚è³‡æ–™ï¼ˆä¾‹å¦‚ urlã€query stringã€body dataï¼‰
1. åˆ©ç”¨ç¬¬ 1 æ­¥å–å¾—çš„è³‡æ–™ï¼Œä½¿ç”¨æ¸¬è©¦å·¥å…·ï¼ˆä¾‹å¦‚ Supertestï¼‰ç™¼é€è«‹æ±‚

æ¥ä¸‹ä¾†ä»¥ [`collection-data` åˆç´„](https://github.com/Codfisher/blog-ts-rest-practice/blob/main/packages/shared/src/collection-data/contract.ts)ç‚ºä¾‹ï¼Œä¸€æ­¥ä¸€æ­¥ä¾†å§ã€‚

å»ºç«‹ä¸€å€‹å°‡ ts-rest åˆç´„è½‰æ›æˆ API è«‹æ±‚è³‡æ–™çš„å·¥å…·ï¼š

`apps\api-server\src\common\utils\utils-ts-rest.ts`

```ts
type ExtractQuery<T> = T extends { query: infer U } ? U : never
type ExtractBody<T> = T extends { body: infer U } ? U : never

interface UseContractReturn<Query, Body> {
  url: string;
  method: Lowercase<AppRoute['method']>;
  query: Query;
  body: Body;
}

/** å”åŠ©å–å‡ºåˆç´„ API æŒ‡å®š API å…§å®¹
 *
 * ä¸»è¦ç”¨æ–¼ e2e æ¸¬è©¦
 */
export function useContract<
  Route extends AppRouteQuery,
  Data extends ClientInferRequest<Route>,
>(
  route: Route,
  data?: Data
): UseContractReturn<ExtractQuery<Data>, ExtractBody<Data>>
export function useContract<
  Route extends AppRouteMutation,
  Data extends ClientInferRequest<Route>,
>(
  route: Route,
  data?: ClientInferRequest<Route>
): UseContractReturn<ExtractQuery<Data>, undefined>
export function useContract<
  Route extends AppRouteQuery | AppRouteMutation,
>(
  route: Route,
  data?: ClientInferRequest<Route>,
): any {
  const {
    method,
    path,
  } = route

  const url = path.replace(
    /:(\w+)/g,
    (match, key) => data?.params?.[key],
  )

  if (data && 'body' in data) {
    return {
      url,
      method: method.toLowerCase() as Lowercase<AppRoute['method']>,
      query: data?.query,
      body: data,
    }
  }

  return {
    url,
    method: method.toLowerCase() as Lowercase<AppRoute['method']>,
    query: data?.query,
  }
}
```

æ¸¬è©¦å·¥å…·ä½¿ç”¨ Supertestï¼Œå»ºç«‹ä¸€å€‹å°‡åˆç´„è³‡æ–™é€é Supertest ç™¼é€è«‹æ±‚çš„å·¥å…·ï¼š

`apps/api-server/src/resource/collection-data/collection-data.e2e.ts`

```ts
import type { ClientInferRequest, ClientInferResponseBody } from '@ts-rest/core'
import type { IncomingHttpHeaders } from 'node:http'
import {
  collectionDataContract,
} from '@ts-rest-practice/shared'
import request from 'supertest'
import { useContract } from '../../common/utils/utils-ts-rest'

// é€™è£¡ä¸å¯èƒ½å‡ºç¾å…¶ä»– Contractï¼Œæ‰€ä»¥å¯ä»¥ç°¡çŸ­å‘½å
type Contract = typeof collectionDataContract
type ContractRequest = ClientInferRequest<Contract>

interface ApiOptions {
  headers?: IncomingHttpHeaders;
}

/** e2e æ¸¬è©¦ä¹‹åˆç´„è½‰æ›å±¤
 *
 * å°‡åˆç´„è½‰æ›æˆ API å‘¼å«ï¼Œé€™æ¨£å°±å¯ä»¥ç›´æ¥æ‹¿åˆç´„å…§å®¹é€²è¡Œ e2e æ¸¬è©¦
 *
 * ä¹Ÿå°±æ˜¯èªªåªè¦åˆç´„æœ‰è®Šå‹•ï¼Œé€™è£¡ä¹Ÿè¦è·Ÿè‘—è®Šå‹•ï¼Œé€™æ¨£å°±å¯ä»¥ç¢ºä¿åˆç´„çš„æ­£ç¢ºæ€§
 *
 * åŒæ™‚åªè¦ e2e æ¸¬è©¦é€šéï¼Œå³è¡¨ç¤ºåˆç´„æ­£ç¢ºï¼Œå¯ä»¥äº¤ä»˜
 *
 * å¦ä¸€å€‹é™„åŠ å¥½è™•æ˜¯å¦‚æœå…¶ä»–è³‡æºçš„ e2e æ¸¬è©¦æœ‰ä¾è³´æ­¤è³‡æºï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‹¿å»é‡è¤‡ä½¿ç”¨
 *
 * @param server æ¸¬è©¦ç’°å¢ƒä¸­çš„ HTTP server ä¸»é«”
 * @param globalOptions é¡å¤–çš„é¸é …ã€‚åŒ method å…§çš„ optionsï¼Œmethod å…§çš„ options æœƒè¦†è“‹é€™è£¡çš„ options
 */
export function createCollectionDataApi(
  server: any,
  globalOptions?: ApiOptions,
) {
  return {
    async create<
      Code extends keyof Contract['create']['responses'] = 200,
    >(
      data: ContractRequest['create']['body'],
      code = 200 as Code,
      options?: ApiOptions,
    ) {
      const { url, method } = useContract(collectionDataContract.create, {
        body: data,
      })

      const { body, statusCode, headers } = await request(server)[method](url)
        .set({
          ...globalOptions?.headers,
          ...options?.headers,
        })
        .send(data)

      if (code !== statusCode) {
        throw new Error(`${statusCode} : ${JSON.stringify(body, null, 2)}`)
      }

      return {
        headers,
        body: body as ClientInferResponseBody<
          typeof collectionDataContract.create,
          Code
        >,
      }
    },

    // å…¶ä»–æ–¹æ³•åŒç†
  }
}
```

æœ€å¾Œå°±é‡å°æ­¤è³‡æºå»ºç«‹ e2e æ¸¬è©¦ï¼ˆä»¥ä¸‹ç‚ºåƒè€ƒï¼Œå¯¦ä½œå¯ä»¥æ›¿æ›æˆè‡ªå·±å–œæ­¡çš„æ–¹å¼ï¼‰ï¼š

```ts
type CollectionDataContract = ClientInferRequest<typeof collectionDataContract>

describe('collectionData e2e', () => {
  /** ä½¿ç”¨è¨˜æ†¶é«”ç‰ˆæœ¬ MongoDB é‹è¡Œæ¸¬è©¦ */
  let mongodb: MongoMemoryReplSet
  let mongoConnection: Connection
  let app: INestApplication
  let server: ReturnType<INestApplication['getHttpServer']>

  let collectionDataApi: ReturnType<typeof createCollectionDataApi>

  beforeAll(async () => {
    // ...å•Ÿå‹• Server èˆ‡ DB

    collectionDataApi = createCollectionDataApi(server)
  }, 60000)

  /** æ¸¬è©¦çµæŸï¼Œé—œé–‰ DB */
  afterAll(async () => {
    // ...
  })

  async function clearAll() {
    // ...
  }
  /** æ¯æ¬¡æ¸¬è©¦é–‹å§‹å‰èˆ‡çµæŸæ™‚ï¼Œéƒ½æ¸…ç©º collection è³‡æ–™ï¼Œä»¥å…äº’ç›¸å½±éŸ¿ */
  beforeEach(async () => await clearAll())
  afterEach(async () => await clearAll())

  function createCollectionData(
    params?: Partial<CollectionDataContract['create']['body']>,
  ) {
    const expectData: CollectionDataContract['create']['body'] = {
      name: 'test',
      description: 'å®‰å®‰',
      ...params,
    }

    return collectionDataApi.create(expectData)
  }

  describe('å»ºç«‹ collection-data', () => {
    it('å…¨éƒ¨åƒæ•¸', async () => {
      const expectData: Required<CollectionDataContract['create']['body']> = {
        name: 'name',
        description: 'description',
        remark: 'remark',
      }

      const { body: result } = await collectionDataApi.create(expectData)

      expect(result).toMatchObject(pick(
        expectData,
        ['name', 'description', 'remark'],
      ))
    })
  })

  describe('å–å¾— collection-data', () => {
    it('å–å¾—æŒ‡å®šç­†æ•¸è³‡æ–™', async () => {
      await Promise.allSettled([
        createCollectionData(),
        createCollectionData(),
      ])

      const { body: result } = await collectionDataApi.find({ limit: 1 })
      expect(result.total).toBe(2)
      expect(result.data).toHaveLength(1)
    })
  })

  describe('å–å¾—æŒ‡å®š collection-data', () => {
    it('å–å¾—æŒ‡å®šè³‡æ–™', async () => {
      const { body: data } = await createCollectionData()
      const { body: newData } = await collectionDataApi.findOne(data.id)

      expect(newData).toEqual(data)
    })
  })

  describe('æ›´æ–°æŒ‡å®š collection-data', () => {
    it('ä¿®æ”¹ name ç‚º cod', async () => {
      const { body: data } = await createCollectionData()
      const { body: newData } = await collectionDataApi.update(data.id, {
        name: 'cod',
      })

      expect(newData.name).toBe('cod')
    })
  })

  describe('åˆªé™¤æŒ‡å®š collection-data', () => {
    it('åˆªé™¤è³‡æ–™å¾Œï¼Œfind ç„¡æ³•å–å¾—', async () => {
      const { body: data } = await createCollectionData()
      await collectionDataApi.remove(data.id)
      const { body: result } = await collectionDataApi.find()

      expect(result.data).toHaveLength(0)
    })
  })
})
```

ç‚ºäº†é˜²æ­¢ç¯‡å¹…éé•·ï¼Œé€™è£¡åªå±•ç¤ºéƒ¨åˆ†æ¸¬è©¦å…§å®¹ï¼Œå®Œæ•´æ¸¬è©¦ç¨‹å¼ç¢¼å¯ä»¥[åœ¨æ­¤æŸ¥çœ‹](https://github.com/Codfisher/blog-ts-rest-practice/blob/main/apps/api-server/src/resource/collection-data/collection-data.e2e.spec.ts)ã€‚

## ç¸½çµ ğŸŸ

æ„Ÿè¬å¤§å®¶çœ‹åˆ°é€™è£¡ï¼Œä»¥ä¸Šç‚ºä½¿ç”¨ ts-rest å¯¦éš›é–‹ç™¼çš„é»é»æ»´æ»´ï¼Œå…§å®¹èˆ‡è§€å¿µæœƒéš¨è‘—æ™‚é–“æ¨ç§»è€Œè®ŠåŒ–ï¼Œæ‰€ä»¥æœ¬æ–‡æœƒä¸å®šæœŸæ›´æ–°ã€‚

æœ‰ä»»ä½•å•é¡Œé‚„è«‹å¤§å®¶ä¸åæŒ‡æ•™ã€‚%(*Â´âˆ€`)~â™¥%

æœ¬æ–‡å®Œæ•´ç¨‹å¼ç¢¼å¯ä»¥[åœ¨æ­¤å–å¾—](https://github.com/Codfisher/blog-ts-rest-practice)ã€‚
