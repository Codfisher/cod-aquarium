---
description: 元素被卡住怎麼辦？
tags: ["Web", "JS"]
image: https://codlin.me/detached-dom-elements.webp
pubDate: 20260112
draft: true
---

<script setup>
  import VirtualScrollVisualizer from './detached-dom-elements/virtual-scroll-visualizer.vue'
  import VirtualList from './detached-dom-elements/virtual-list.vue'
  import DetachedElements from './detached-dom-elements/detached-dom-elements.vue'
</script>

![detached-dom-elements](/detached-dom-elements.webp){.cover}

# 說好的虛擬呢？記憶體爆炸啦！Σ(ˊДˋ;)

某個專案回報網頁會越來越卡，甚至崩潰。

查了一下是因為記憶體用量像鱈魚的體重一樣越來越高，都不知道是鯨魚還是鱈魚了。

鱈魚：「旁白不要給我亂念劇本 %ლ（´ 口`ლ）%」

<br>

嘗試重現了一下，發現在虛擬滾動中，反覆滾動會讓記憶體不斷上升，而且還沒有辦法釋放。

讓我們來看看是怎麼回事。

## 虛擬滾動

若頁面一次載入太多元素，可能會導致頁面卡頓，甚至崩潰。

這時候我們可以透過虛擬滾動來解決這個問題。

虛擬滾動只會顯示可見區域的元素，同時也會預先載入（Overscan）可見區域外的一些元素，避免快速捲動時出現大量空白。

下方是一個虛擬滾動的互動說明，可以清楚看到可視區域、渲染區域和未渲染區域。

<virtual-scroll-visualizer />

UI 套件可能會有內建虛擬滾動元件，如果沒有、需求簡單，則可以使用 VueUse 的 `useVirtualList`。

使用上非常簡單：

<<< ./detached-dom-elements/virtual-list.vue

結果如下：

<virtual-list class="h-[40vh]" />

## 問題重現

不難注意到虛擬列表會不斷建立、銷毀 DOM 元素，如果我們反覆滾動，記憶體就會不斷上升。

讓我們快速滾動列表並打開 DevTools 使用 Performance Monitor（效能監視器）查看記憶體與 DOM 的變化。

![dom-is-released-normally](/detached-dom-elements/dom-is-released-normally.jpg)

可以注意到即使 DOM 元素一度衝到接近 40000 個，也會在特定時間點釋放並不會無限上升。

所以到底是怎麼回事呢？%(́⊙◞౪◟⊙‵)%

<br>

在我抽絲剝繭後，發現問題出在 `input` 元素，沒錯，就是那個樸實無華的輸入框。%(◉◞౪◟◉ )%

只要在剛剛的虛擬列表中加入 `input` 元素，記憶體就會不斷上升，不會自動釋放，直到記憶體爆炸。

<<< ./detached-dom-elements/detached-dom-elements.vue

## 總結 🐟
