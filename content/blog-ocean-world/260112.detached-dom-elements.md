---
description: 使用虛擬列表時，記憶體不斷上升，甚至爆炸，該怎麼辦呢？
tags: ["JavaScript", "Performance"]
image: https://codlin.me/detached-dom-elements.webp
pubDate: 20260115
---

<script setup>
  import VirtualScrollVisualizer from './detached-dom-elements/virtual-scroll-visualizer.vue'
  import VirtualList from './detached-dom-elements/virtual-list.vue'
  import DetachedElements from './detached-dom-elements/detached-elements.vue'
</script>

![detached-dom-elements](/detached-dom-elements.webp){.cover}

# 說好的虛擬呢？記憶體爆炸啦！

某個專案回報網頁會越來越卡，甚至崩潰。

查了一下是因為記憶體用量像鱈魚的體重一樣越來越高，都不知道是鯨魚還是鱈魚了。

鱈魚：「旁白不要給我亂念劇本 %ლ（´ 口`ლ）%」

<br>

嘗試重現了一下，發現在虛擬滾動列表中，反覆滾動會讓記憶體不斷上升，而且還沒有辦法釋放。

讓我們來看看是怎麼回事。

## 虛擬滾動

若頁面一次載入太多元素，可能會導致頁面卡頓，甚至崩潰。

這時候我們可以透過虛擬滾動來解決這個問題。

虛擬滾動只會顯示可見區域的元素，同時也會預先載入（Overscan）可見區域外的一些元素，避免快速捲動時出現大量空白。

下方是一個虛擬滾動的互動說明，可以清楚看到可視區域、渲染區域和未渲染區域。

<virtual-scroll-visualizer />

UI 套件可能會有內建虛擬滾動元件，如果沒有且需求簡單，則可以使用 VueUse 的 `useVirtualList`。

使用上非常簡單：

<<< ./detached-dom-elements/virtual-list.vue

結果如下：

<virtual-list class="h-[40vh]" />

可以看到 50000 列資料輕輕鬆鬆啦！%( •̀ ω •́ )✧%

## 問題重現

不難注意到虛擬列表會不斷建立、銷毀 DOM 元素，如果我們反覆滾動，記憶體就會不斷上升。

讓我們快速滾動列表並打開 DevTools 使用 Performance Monitor（效能監視器）查看記憶體與 DOM 的變化。

![dom-is-released-normally](/detached-dom-elements/dom-is-released-normally.webp)

可以注意到即使 DOM 元素一度衝到接近 40000 個，也會在特定時間點釋放並不會無限上升。

所以到底是怎麼回事呢？%(́⊙◞౪◟⊙‵)%

<br>

反覆交叉嘗試後，發現問題出在 `input` 元素，沒錯，就是那個樸實無華的輸入框。%(◉◞౪◟◉ )%

只要在剛剛的虛擬列表中加入 `input` 元素，記憶體就會不斷上升，不會自動釋放，直到記憶體爆炸。

<<< ./detached-dom-elements/detached-elements.vue{14-17,36}

<detached-elements class="h-[40vh]" />

一樣不斷滾動列表，並查看 Performance Monitor。

![dom-is-not-released](/detached-dom-elements/dom-is-not-released.webp)

可以看到 DOM 數量不斷上升，完全沒有釋放的跡象。%(;´༎ຶД༎ຶ`)%

<br>

鱈魚：「真相出爐了，兇手就是 `input`！%ヽ(●`∀´●)ﾉ%」

同事：「可是一樣的範例，我的電腦沒有這個問題欸%(´･ω･`)%」

鱈魚：...%ヽ(́⊙◞౪◟⊙‵)ﾉ%

<br>

使用不同瀏覽器交叉測試後，發現內鬼是瀏覽器外掛（例如：密碼管理工具），關閉外掛後就沒問題了。%( ˘•ω•˘ )%

所以其實此問題可能一直都在，只是因為大量的 `input` 在虛擬滾動中反覆建立、銷毀，放大了問題才會注意到，所以該怎麼辦呢？

<br>

鱈魚：「這個簡單，關閉外掛或只能用乾淨瀏覽器，不要拉倒 %(・∀・)９%」

同事：「PM 在你後面，他非常火 %╭(°A ,°`)╮%」

<br>

我們沒辦法控制客戶的瀏覽器環境，只能調整 `input` 出現的時機了。

可以改成開啟編輯模式時才顯示 `input` 或使用像 [Popup Edit](https://quasar.dev/vue-components/popup-edit) 這種點擊後顯示浮動 `input` 的元件。

最後改成 Popup Edit 方案，不但問題解決惹，性能也提升了一點，用起來更流暢惹。%ԅ( ˘ω˘ԅ)%

## 總結 🐟

- 虛擬列表可以確保大量資料顯示時，不會造成頁面卡頓。
- 某些瀏覽器外掛會導致問題，調整 `input` 出現的時機，避免大量建立、銷毀 `input` 元素。
