---
description: ç¢ºä¿åœ–ç‰‡éƒ½ä¹–ä¹–è¼‰å…¥å®Œæˆï¼Œä¸€å€‹éƒ½ä¸èƒ½å°‘ï¼é †ä¾¿ç©ç©çœ‹ Vitest çš„ Browser Mode(ãƒ»âˆ€ãƒ»)ï¼™
tags: ['Vue', 'Vitest']
image: https://codlin.me/img.webp
date: 20250610
draft: true
---

![img](/img.webp){.cover}

# ç”šéº¼ï¼Ÿåœ–ç‰‡é‚„æ²’å¥½å–”ï¼Î£(ËŠĞ”Ë‹;)

æœ€è¿‘é–‹ç™¼ç¶²é åˆ—å°åŠŸèƒ½æ™‚ï¼Œç™¼ç¾ä½¿ç”¨è€…åˆ—å°ç•¶ä¸‹ï¼Œåœ–ç‰‡å¯èƒ½é‚„æ²’å‡ºç¾ï¼Œå°è‡´é é¢ä¸å®Œæ•´ã€‚%(â—â€¸â—Ÿ )%

æ€éº¼è¾¦å“©ï¼Ÿä¾†åšä¸€å€‹åœ–ç‰‡è¼‰å…¥å®Œæˆçš„æª¢æŸ¥å§ï¼%(ãƒ»âˆ€ãƒ»)ï¼™%

## é‡æ¸…éœ€æ±‚

ç¬¬ä¸€å…ˆä¾†é‡æ¸…éœ€æ±‚ï¼Œé€™å€‹åŠŸèƒ½çš„ç›®çš„æ˜¯ï¼š

1. ç¢ºä¿æŒ‡å®š DOM ä¸‹æ‰€æœ‰åœ–ç‰‡éƒ½è¼‰å…¥å®Œæˆ
1. å¦‚æœåœ–ç‰‡ä¸å¯è¦‹å‰‡å¿½ç•¥
1. éœ€è€ƒæ…® CSS background-image

## å¯¦ä½œ

ç†Ÿæ‚‰ Web é–‹ç™¼çš„äººï¼Œæ‡‰è©²éƒ½çŸ¥é“åœ–ç‰‡è¼‰å…¥å®Œæˆå¯ä»¥é€é `load` äº‹ä»¶ä¾†è™•ç†ã€‚

çŸ¥é“é€™é»å¾Œï¼Œå…¶å¯¦å°±å¾ˆç°¡å–®äº†ï¼Œè®“æˆ‘å€‘ä¸€æ­¥ä¸€æ­¥ä¾†ã€‚

é€™è£¡ä»¥ Vue ç‚ºä¾‹ï¼Œå»ºç«‹ä¸€å€‹åç‚º `useImagesReady` çš„ Composition APIã€‚

### å–å¾—ç›®æ¨™çš„ HTML å…ƒç´ 

æˆ‘å€‘çš„åƒæ•¸æ”¯æ´ç›´æ¥ä½¿ç”¨ Vue å…ƒä»¶ï¼Œæ‰€ä»¥è¦å…ˆè™•ç†ä¸€ä¸‹ï¼Œè®“æˆ‘å€‘å¯ä»¥å–å¾—ç›®æ¨™çš„ HTML å…ƒç´ ã€‚

```ts
interface UseImagesReadyParams {
  /** ä¸æŒ‡å®šå‰‡ç‚ºç›®å‰å…ƒä»¶ */
  target?: MaybeElement;
  /** å¼·åˆ¶å»¶é²ï¼ˆmsï¼‰ï¼Œä¿éšªèµ·è¦‹
   * @default 0
   */
  forceDelay?: number;
  /** æ˜¯å¦åŒ…å« background-image
   * @default true
   */
  includeBackgroundImages?: boolean;
}

/** åµæ¸¬ç›®æ¨™ä¸‹æ‰€æœ‰åœ–ç‰‡æ˜¯å¦è¼‰å…¥å®Œæˆ
 *
 * ç›®å‰ä¸è€ƒæ…®å‹•æ…‹æ–°å¢çš„åœ–ç‰‡
 */
export function useImagesReady(params: UseImagesReadyParams = {}) {
  const {
    target,
    forceDelay = 0,
    includeBackgroundImages = true,
  } = params

  const totalImages = ref(0)
  const isReady = ref(false)
  /** å–å¾—ç›®å‰å…ƒä»¶å¯¦ä¾‹ */
  const instance = getCurrentInstance()

  onMounted(() => {
    const rootElement = pipe(
      toValue(target),
      (value) => {
        if (value && '$el' in value) {
          return value.$el
        }

        return value
          ?? instance?.vnode?.el
          ?? instance?.proxy?.$el
          ?? document.documentElement
      },
      (value) => {
        if (!value) {
          return undefined
        }

        if (value instanceof HTMLElement) {
          return value
        }

        throw new Error(
          '[useImagesReady] å–å¾—ç›®æ¨™å…ƒç´ ç•°å¸¸ï¼Œè«‹ç¢ºèª target æ˜¯å¦ç‚º HTMLElement æˆ– Vue å…ƒä»¶',
        )
      },
    )

    if (!rootElement) {
      isReady.value = true
      console.warn('[useImagesReady] ç›®æ¨™å…ƒç´ ä¸å­˜åœ¨ï¼Œç„¡æ³•åµæ¸¬åœ–ç‰‡è¼‰å…¥ç‹€æ…‹')
      return
    }
  })

  return {
    isReady,
    totalImages,
  }
}
```

::: tip é‚£å€‹ `pipe` æ˜¯ç”šéº¼å’šå’šï¼Ÿ
ä¸çŸ¥é“çš„æœ‹å‹å€‘å¯ä»¥ä¾†é€™è£¡[çœ‹çœ‹](/blog-program/remeda-pipe)
:::

### å–å¾—æ‰€æœ‰åœ–ç‰‡

æ¥è‘—æ˜¯å–å¾—åœ–ç‰‡éƒ¨åˆ†ï¼Œå…ˆæ–°å¢ä¸€å€‹åˆ¤æ–· image æ˜¯å¦å¯è¦‹çš„ functionã€‚

è‹¥å…¶çˆ¶å…ƒç´ éš±è—ï¼Œå‰‡åœ–ç‰‡ä¸€å®šä¹Ÿçœ‹ä¸åˆ°ï¼Œæ‰€ä»¥è¦ä¸€è·¯æ‰¾ä¸Šå»ï¼Œ~~æŠŠåˆ—ç¥–åˆ—å®—éƒ½æ‰¾å‡ºä¾† %áƒšï¼ˆÂ´âˆ€`áƒšï¼‰%~~ã€‚

```ts
function isElementVisible(el: HTMLElement | null) {
  /** ä¸€è·¯å¾€çˆ¶å±¤æª¢æŸ¥ */
  while (el) {
    const style = getComputedStyle(el)
    if (style.display === 'none' || style.visibility === 'hidden') {
      return false
    }
    el = el.parentElement
  }
  return true
}
```

::: tip æ€éº¼ä¸ç”¨ `offsetParent`ï¼Ÿ%áƒš(â•¹Îµâ•¹áƒš)%
ç ”ç©¶ä¸­æœ‰æ‰¾åˆ° `offsetParent` é€™å€‹å±¬æ€§ï¼Œç•¶çˆ¶å…ƒç´  `display: none` æ™‚æœƒæ˜¯ `null`ï¼Œå°±å¯ä»¥ä¸ç”¨ä¸€è·¯å¾€ä¸Šæ‰¾ã€‚

åªæ˜¯çˆ¶å…ƒç´ ç‚º `position: fixed` ä¹Ÿæœƒæ˜¯ `null`ï¼Œé€™æ¨£æœƒèª¤åˆ¤ï¼Œæ‰€ä»¥ä¸è¡Œã€‚%áƒš(â•¹Îµâ•¹áƒš)%

[HTMLElement: offsetParent property](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetParent)
:::

<br>

æ¥è‘—å–å¾—ç›®æ¨™å…ƒç´ ä¸‹çš„æ‰€æœ‰åœ–ç‰‡ã€‚

```ts
const imageElements = Array.from(rootElement.querySelectorAll('img'))
  .filter((img) => !!img.src && isElementVisible(img))
```

æ¥è‘—å–å¾—èƒŒæ™¯åœ–ç‰‡ä¸¦è½‰æ›æˆ `HTMLImageElement`ï¼Œæœ€å¾Œåˆä½µåˆ° `imageElements`ã€‚

```ts
const backgroundImageElements = Array.from(
  includeBackgroundImages
    ? rootElement.querySelectorAll('*')
    : [],
).reduce((list, el) => {
  if (!(el instanceof HTMLElement) || !isElementVisible(el)) {
    return list
  }

  const bgValue = getComputedStyle(el).getPropertyValue('background-image')
  if (bgValue && bgValue !== 'none') {
    // åªè™•ç† url çš„èƒŒæ™¯åœ–ç‰‡
    const url = bgValue.match(/url\(["']?([^"']+)["']?\)/)
    if (!url || !url[1]) {
      return list
    }
    const img = new Image()
    img.src = url[1]
    list.push(img)
  }

  return list
}, [] as HTMLImageElement[])

const imageElements = Array.from(rootElement.querySelectorAll('img'))
  .filter((img) => !!img.src && isElementVisible(img))
  .concat(backgroundImageElements)
```

### åœ–ç‰‡è¼‰å…¥äº‹ä»¶

åœ–ç‰‡åˆ°é½Šäº†ï¼Œå‰©ä¸‹å°±æ˜¯è™•ç†è¼‰å…¥äº‹ä»¶äº†ï¼Œé€™è£¡æˆ‘å€‘ä½¿ç”¨ VueUse çš„ [`useEventListener`](useEventListener)ã€‚

```ts
export function useImagesReady(params: UseImagesReadyParams = {}) {
  // ...

  onMounted(() => {
    // ...

    const imageElements = Array.from(rootElement.querySelectorAll('img'))
      .filter((img) => !!img.src && isElementVisible(img))
      .concat(backgroundImageElements)

    totalImages.value = imageElements.length

    if (totalImages.value === 0) {
      isReady.value = true
      return
    }

    let loadedCount = 0

    async function checkCompletion() {
      if (loadedCount === totalImages.value) {
        await promiseTimeout(forceDelay)
        isReady.value = true
      }
    }

    function handleEvent() {
      loadedCount++
      checkCompletion()
    }

    imageElements.forEach((img) => {
      if (img.complete) {
        loadedCount++
        return
      }

      useEventListener(img, 'load', handleEvent, { once: true })
      useEventListener(img, 'error', handleEvent, { once: true })
    })

    checkCompletion()
  })

  return {
    isReady,
    totalImages,
  }
}
```

é€™æ¨£å°±å®Œæˆäº†ï¼Œç•¶æ‰€æœ‰åœ–ç‰‡è¼‰å…¥å®Œæˆï¼ˆæˆ–éŒ¯èª¤ï¼‰å¾Œï¼Œ`isReady` æœƒè®Šæˆ `true`ã€‚

é›–ç„¶é‚„æœ‰ä¸€äº›æƒ…å¢ƒèˆ‡é‚Šç•Œå•é¡Œé‚„æœªè€ƒæ…®ï¼Œä¸éé€™æ¨£å·²ç¶“å¾ˆå¤ ç”¨æƒ¹ã€‚%Ô…(Â´âˆ€` Ô…)%

## ä¾†å€‹æ¸¬è©¦

å…ˆå‰éƒ½ç”¨ Playwright æ¸¬è©¦ï¼Œé€™æ¬¡ä¾†è©¦è©¦çœ‹ Vitest çš„ Browser Modeã€‚%(ï½¡ï½¥âˆ€ï½¥)ï¾‰ï¾%

Browser Mode æœ€å¤§çš„å·®åˆ¥åœ¨æ–¼ä¸ç”¨åƒ Playwright ä¸€æ¨£é–‹å•ŸæŒ‡å®šé é¢

Vitest æœƒåœ¨å…§éƒ¨è‡ªå‹•è™•ç†ï¼Œé–‹ç™¼è€…ç”¨èµ·ä¾†å°±å¦‚åŒå¹³å¸¸å¯«å–®å…ƒæ¸¬è©¦ä¸€æ¨£å–®ç´”ã€‚

::: tip
Playwright å…¶å¯¦ä¹Ÿå¯ä»¥æ¸¬è©¦å…ƒä»¶ï¼Œä¸éæ­¤åŠŸèƒ½æ­£åœ¨å¯¦é©—ä¸­ã€‚

è€Œå› å–®å…ƒæ¸¬è©¦å¾ˆå¸¸ä½¿ç”¨ Vitestï¼Œå¦‚æœæ¸¬è©¦éƒ½èƒ½åœ¨ Vitest å®Œæˆï¼Œæ•´åˆæ€§æ›´é«˜ã€æ›´æ–¹ä¾¿ã€‚

[Playwright test-components](https://playwright.dev/docs/test-components)
:::

é¦–å…ˆä¾†

## ç¸½çµ ğŸŸ

- æ¸¬è©¦åœ–ç‰‡è¼‰å…¥ç‹€æ…‹çš„åŠŸèƒ½ï¼Œç¢ºä¿åˆ—å°æ™‚åœ–ç‰‡éƒ½è¼‰å…¥å®Œæˆ
- ä½¿ç”¨ Vue çš„ Composition API å¯¦ä½œ `useImagesReady`
- ä½¿ç”¨ `useEventListener` åµæ¸¬åœ–ç‰‡è¼‰å…¥äº‹ä»¶
- ä½¿ç”¨ Vitest çš„ Browser Mode é€²è¡Œæ¸¬è©¦
