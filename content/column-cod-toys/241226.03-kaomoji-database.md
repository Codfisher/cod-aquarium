---
title: CodToys - EP03ï¼šé¡æ–‡å­—è³‡æ–™åº«
description: ä¸Šä¸€ç« ç¯€æˆ‘å€‘å®Œæˆäº†å¿«æ·éµé–‹é—œè¦–çª—åŠŸèƒ½ï¼Œé€™ä¸€ç« ç¯€æˆ‘å€‘ä¾†å¯¦ä½œåŠŸèƒ½é¸é …éƒ¨åˆ†å§ï¼
tags: ['Electron']
image: https://codlin.me/cod-toys.webp
pubDate: 20250102
---

![å¿«æ¨‚å †ç©æœ¨çš„é­š](/cod-toys.webp){.cover}

# CodToys - EP03ï¼šé¡æ–‡å­—è³‡æ–™åº«

ä¸Šä¸€ç« ç¯€æˆ‘å€‘å®Œæˆäº†å¿«æ·éµé–‹é—œè¦–çª—åŠŸèƒ½ï¼Œé€™ä¸€ç« ç¯€æˆ‘å€‘ä¾†å¯¦ä½œåŠŸèƒ½é¸é …éƒ¨åˆ†å§ï¼

## é–‹ç™¼

æœ¬ç« ç¯€é è¨ˆæœƒå»ºç«‹ä»¥ä¸‹å…§å®¹ï¼š

- ç”¢ç”Ÿ Trayï¼šç”¨ä¾†æŸ¥çœ‹ç‹€æ…‹èˆ‡é–‹å•Ÿè¨­å®šè¦–çª—
- å„²å­˜è¨­å®šæª”ï¼šå„²å­˜ä½¿ç”¨è€…ä¹‹ Notion API è³‡æ–™
- é€£æ¥ Notion Database
- æ¨¡ç³Šæœå°‹é¡æ–‡å­—è³‡æ–™

### ç”¢ç”Ÿ Tray

ä½¿ç”¨ [Tray æ¨¡çµ„](https://www.electronjs.org/docs/latest/api/tray)ï¼Œè¼•é¬†å®Œæˆã€‚â—( â€¢Ï‰â€¢ )â—Ÿ

åŒæ™‚å°‡ `app` çš„ `window-all-closed` äº‹ä»¶ç§»åˆ° `app.whenReady` ä¸­ï¼Œæ¸›å°‘å°æ–¼å…¨åŸŸè®Šæ•¸çš„ä¾è³´ã€‚

`electron\main.ts`

```ts
import path from 'node:path'
import process from 'node:process'
import {
  app,
  BrowserWindow,
  globalShortcut,
  Menu,
  shell,
  Tray,
} from 'electron'
import { version } from '../package.json'

function createTray(
  {
    mainWindow,
  }: {
    mainWindow: BrowserWindow;
  },
) {
  const tray = new Tray(
    path.join(__dirname, '../public/fish.ico'),
  )
  const contextMenu = Menu.buildFromTemplate([
    {
      label: 'æš«æ™‚åœç”¨',
      type: 'checkbox',
      click(item) {
        if (item.checked) {
          globalShortcut.unregisterAll()
        }
        else {
          initGlobalShortcut({ mainWindow })
        }
      },
    },
    {
      label: 'è©³ç´°è¨­å®š',
      submenu: [
        {
          label: 'é–‹å•Ÿè¨­å®šè¦–çª—',
        },
      ],
    },
    {
      label: 'é—œæ–¼',
      click: () => shell.openExternal('https://codlin.me/column-cod-toys/01-origin.html'),
    },
    { type: 'separator' },
    {
      label: 'é€€å‡ºæ‡‰ç”¨ç¨‹å¼',
      click: () => app.quit(),
    },
  ])
  tray.setToolTip(`CodToys v${version}`)
  tray.setContextMenu(contextMenu)

  return tray
}

app.whenReady().then(async () => {
  const mainWindow = await createInputWindow()

  initGlobalShortcut({ mainWindow })

  initIpcMain({ configStore })

  const tray = createTray({ mainWindow })

  app.on('window-all-closed', () => { // [!code ++]
    if (process.platform !== 'darwin') { // [!code ++]
      app.quit()// [!code ++]
    }// [!code ++]

    globalShortcut.unregisterAll()// [!code ++]
    tray.destroy()// [!code ++]
  })// [!code ++]
})

app.on('window-all-closed', () => { // [!code --]
  if (process.platform !== 'darwin') { // [!code --]
    app.quit()// [!code --]
  }// [!code --]

  globalShortcut.unregisterAll()// [!code --]
})// [!code --]
```

ç¾åœ¨æœƒæ³¨æ„åˆ°ç³»çµ±æ‰˜ç›¤æœƒå‡ºç¾é­šçš„åœ–ç¤ºï¼Œé»æ“Šå³éµæœƒå‡ºç¾æ›´å¤šé¸å–®ã€‚

![create-tray](/cod-toys/create-tray.png)

### å„²å­˜ä½¿ç”¨è€…è¨­å®š

é€™è£¡ä½¿ç”¨ [electron-store](https://www.npmjs.com/package/electron-store) ä¾†å„²å­˜ä½¿ç”¨è€…è¨­å®šã€‚

å®‰è£å¥—ä»¶å¾Œï¼Œç¬¬ä¸€æ­¥å…ˆä¾†å®šç¾©ä¸€ä¸‹ä½¿ç”¨è€…è¨­å®šå‹åˆ¥ä¸¦æ–°å¢ `ConfigApi`ï¼Œç”¨æ–¼å­˜å–ä½¿ç”¨è€…è¨­å®šã€‚
`electron\electron-env.d.ts`

```ts
export interface MainApi {
  // ...
}

export interface UserConfig {
  kaomoji: {
    databaseId: string;
    token: string;
  };
}
export interface ConfigApi {
  get: () => Promise<UserConfig>;
  update: (data: Partial<UserConfig>) => Promise<void>;
  onUpdate: (callback: (config: UserConfig) => void) => void;
}

declare global {
  interface Window {
    main: MainApi;
    config: ConfigApi; // [!code ++]
  }
}

export { }
```

æ¥è‘—åœ¨ main process åˆå§‹åŒ– store ä¸¦è¨»å†Š `ipcMain`ã€‚

é€™è£¡åŒæ™‚é‡æ§‹ä¸€ä¸‹ `ipcMain` çš„éƒ¨åˆ†ï¼Œwindow ç›¸é—œæ§åˆ¶æ”¹ç‚ºé‡å°ç™¼é€çš„ windowï¼Œä¸é™å®šåªèƒ½æ§åˆ¶ `mainWindow`ã€‚

`electron\main.ts`

```ts{20-30,36-50,72}
import type { UserConfig } from './electron-env'
import {
  app,
  BrowserWindow,
  ipcMain,
  shell,
} from 'electron'
import Store from 'electron-store'

type ConfigStore = Store<{ config: UserConfig }>

function initIpcMain(
  {
    configStore,
  }: {
    configStore: ConfigStore;
  },
) {
  // main
  ipcMain.on('main:updateHeight', (event, height: number) => {
    const window = BrowserWindow.fromWebContents(event.sender)

    window?.setBounds({ height })
  })
  ipcMain.on('main:hideWindow', (event) => {
    const window = BrowserWindow.fromWebContents(event.sender)

    window?.setFocusable(false)
    window?.hide()
  })
  ipcMain.on('main:openExternal', (event, url: string) => {
    shell.openExternal(url)
  })

  // config
  ipcMain.handle('config:get', async () => {
    return configStore.get('config')
  })
  ipcMain.handle('config:update', async (event, config) => {
    const data = configStore.get('config')
    configStore.set('config', {
      ...data,
      ...config,
    })

    // å‘æ‰€æœ‰è¦–çª—è§¸ç™¼ config:onUpdate äº‹ä»¶
    BrowserWindow.getAllWindows().forEach((window) => {
      window.webContents.send('config:onUpdate', config)
    })
  })
}

function createConfigStore(): ConfigStore { // [!code ++]
  const config: UserConfig = { // [!code ++]
    kaomoji: { // [!code ++]
      databaseId: '', // [!code ++]
      token: '', // [!code ++]
    }, // [!code ++]
  } // [!code ++]

  return new Store({ // [!code ++]
    name: 'config', // [!code ++]
    defaults: { config }, // [!code ++]
  }) // [!code ++]
} // [!code ++]

app.whenReady().then(async () => {
  const configStore = createConfigStore()

  // ...

  initIpcMain({ configStore })

  // ...
})
```

æ¥è‘—åœ¨ preload å¯¦ä½œ APIã€‚

`electron\preload.ts`

```ts
// ...

contextBridge.exposeInMainWorld('config', {
  get() {
    return ipcRenderer.invoke('config:get')
  },
  update(data: Partial<UserConfig>) {
    return ipcRenderer.invoke('config:update', data)
  },
  onUpdate(callback: (config: UserConfig) => void) {
    ipcRenderer.on('config:onUpdate', (event, config) => {
      callback(config)
    })
  },
})
```

ç¾åœ¨æˆ‘å€‘å¯ä»¥å„²å­˜è¨­å®šæª”äº†ï¼Œé‚„éœ€è¦ä¸€å€‹é é¢è¼¸å…¥è³‡æ–™æ‰è¡Œã€‚

### é–‹å•Ÿè¨­å®šé é¢

é è¨ˆä½¿ç”¨ Vue Routerï¼Œç”±æ–¼ Electron æœ¬èº«æ²’æœ‰ Web Serverï¼Œæ‰€ä»¥æ²’è¾¦æ³•ç›´æ¥ä½¿ç”¨ History æ¨¡å¼ï¼Œé€™è£¡æˆ‘å€‘å°‡ router æ”¹ç‚º Hash æ¨¡å¼è§£æ±ºã€‚

`src\main.ts`

```ts
import { createRouter, createWebHashHistory } from 'vue-router/auto'

// ...

const router = createRouter({
  history: createWebHashHistory(import.meta.env.BASE_URL), // [!code highlight]
  routes,
})

// ...
```

æ¥è‘—æ–°å¢è¨­å®šé é¢å§ã€‚

`src\pages\kaomoji-config\index.vue`

```vue
<template>
  <q-form
    class="relative flex-col gap-6 p-6"
    @submit="handleSubmit"
  >
    <q-input
      v-model="form.databaseId"
      outlined
      label="databaseId"
    />

    <q-input
      v-model="form.token"
      outlined
      label="token"
    />

    <q-btn
      label="å„²å­˜"
      type="submit"
      unelevated
      color="primary"
    />

    <q-inner-loading :showing="isLoading" />
  </q-form>
</template>

<script setup lang="ts">
import type { UserConfig } from '../../../electron/electron-env'
import { useAsyncState } from '@vueuse/core'
import { useQuasar } from 'quasar'
import { clone } from 'remeda'
import { ref } from 'vue'
import { useConfigApi } from '../../composables/use-config-api'

const configApi = useConfigApi()
const $q = useQuasar()

document.title = 'é¡æ–‡å­—è¨­å®š'

const form = ref<UserConfig['kaomoji']>({
  databaseId: '',
  token: '',
})

const {
  isLoading,
} = useAsyncState(
  () => configApi.get(),
  undefined,
  {
    onSuccess(data) {
      if (data) {
        form.value = data.kaomoji
      }
    },
  },
)

function handleSubmit() {
  // clone è™•ç†ï¼Œé¿å… Error: An object could not be cloned
  configApi.update(clone({
    kaomoji: form.value,
  })).then(() => {
    $q.notify({
      type: 'positive',
      message: 'å„²å­˜æˆåŠŸ',
    })
  }).catch(() => {
    $q.notify({
      type: 'negative',
      message: 'å„²å­˜å¤±æ•—',
    })
  })
}
</script>
```

ç¾åœ¨è®“æˆ‘å€‘é€é Tray çš„é¸å–®é–‹å•Ÿæ­¤è¨­å®šé é¢å§ã€‚

å»ºç«‹ `createConfigWindow` ç”¨æ–¼é–‹å•ŸæŒ‡å®šé é¢ä¸¦å°‡ç›®æ¨™ route path åŠ åœ¨ # å¾Œé¢å³å¯ã€‚

```ts
// ...

async function createConfigWindow(route: keyof RouteNamedMap) {
  const newWindow = new BrowserWindow({
    backgroundColor: '#fff',
    webPreferences: {
      preload: path.join(__dirname, './preload.js'),
    },
  })
  // éš±è—é è¨­ç³»çµ±é¸å–®
  newWindow.setMenu(null)

  if (process.env.VITE_DEV_SERVER_URL) {
    await newWindow.loadURL(
      `${process.env.VITE_DEV_SERVER_URL}#${route}`,
    )
    // newWindow.webContents.openDevTools()
  }
  else {
    // loadFile å¯ä»¥æŒ‡å®š hash
    await newWindow.loadFile('dist/index.html', {
      hash: route,
    })
  }

  return newWindow
}

// ...

function createTray(
  // ...
) {
  // ...
  const contextMenu = Menu.buildFromTemplate([
    // ...
    {
      label: 'è©³ç´°è¨­å®š',
      submenu: [
        {
          label: 'é–‹å•Ÿè¨­å®šè¦–çª—',
          click: () => createConfigWindow('/kaomoji-config/'), // [!code ++]
        },
      ],
    },
    // ...
  ])
  // ...
}

// ...
```

:::tip
`RouteNamedMap` æ˜¯ `unplugin-vue-router` è‡ªå‹•ç”¢ç”Ÿçš„å‹åˆ¥ï¼Œç”¨æ–¼å®šç¾©æ‰€æœ‰é é¢è·¯ç”±èˆ‡åƒæ•¸ã€‚
:::

ç¾åœ¨è®“æˆ‘å€‘å¾ Tray é–‹å•Ÿè¨­å®šé é¢çœ‹çœ‹å§ï¼(/â‰§â–½â‰¦)/

![kaomoji-config](/cod-toys/kaomoji-config.png)

...å¯ä»¥çœ‹åˆ°ç•«é¢ç›¸ç•¶ç°¡æ½”æœ‰åŠ›ï¼Œæœ‰æ©Ÿæœƒå†ä¾†æ…¢æ…¢ç¾åŒ–å§ã€‚<span class="text-nowrap">( â€¢Ì€ Ï‰ â€¢Ì )âœ§</span>

### é€£æ¥ Notion Database

ç¾åœ¨è®“æˆ‘å€‘é€é Notion API ä¾†é€£æ¥æŒ‡å®šçš„ Database å§ï¼

é¦–å…ˆéœ€è¦å…ˆå»ºç«‹ Integrationsï¼Œå‰å¾€[è¨­å®šé é¢](https://www.notion.so/profile/integrations)ä¸¦ä¾ç…§æ­¥é©Ÿå»ºç«‹ã€‚

1. é»æ“Šç•«é¢ä¸­çš„ã€Œ+ New integrationã€
1. Associated workspace é¸æ“‡è¦ä½¿ç”¨çš„ Workspace
1. Type é¸æ“‡ Internal
1. æŒ‰ä¸‹ Save

é€™æ¨£å°±å»ºç«‹å®Œæˆäº†ï¼æ¥è‘—æˆ‘å€‘éœ€è¦å–å¾—ä¸¦èª¿æ•´ä¸€ä¸‹ Token è¨­å®šã€‚

åœ¨ Integrations é é¢ä¸­ï¼Œé»æ“Šå‰›å‰›å»ºç«‹çš„ Integrationï¼Œæœƒé€²åˆ°è¨­å®šé é¢ï¼Œè®“æˆ‘å€‘é™ç¸®ä»¥ä¸‹æ­¤ Token æ¬Šé™ï¼Œä¿æŒæœ€å°æ¬Šé™åŸå‰‡ã€‚

åŸºæœ¬ä¸Šå°±æ˜¯åªæœ‰ Read æ¬Šé™ï¼Œå¦‚ä¸‹åœ–ã€‚

![notion-token-capabilities](/cod-toys/notion-token-capabilities.png)

è¤‡è£½ Internal Integration Secret ä¸­çš„ tokenï¼Œä¸¦è²¼åˆ°è¨­å®šé é¢ä¸­ã€‚

æ¥è‘—ä¾†å»ºç«‹ Databaseã€‚

1. å°‡åŸæœ¬é è¨­çš„ Name æ¬„ä½æ”¹åç‚º valueï¼Œå…§å®¹ç‚ºé¡æ–‡å­—
1. æ–°å¢ä¸€å€‹åç‚º tags çš„å¤šé¸æ¬„ä½ï¼Œç”¨ä¾†æä¾›ç¯©é¸è³‡æ–™
1. å°‡ database ä½¿ç”¨ open as page é–‹å•Ÿ
1. é»æ“Šæœ€å³ä¸Šè§’çš„ä¸‰å€‹é»ï¼Œå°‡ Connections è¨­å®šç‚ºå‰›å‰›å»ºç«‹çš„ Integration

å®Œæˆå¾Œçµæœæœƒå¦‚ä¸‹åœ–ã€‚

![notion-connections](/cod-toys/notion-connections.png)

æœ€å¾Œç›®å‰ç¶²é çš„ URL æœƒæ˜¯ `https://www.notion.so/{workspace}/{databaseId}?xxx`ï¼Œå°‡æ­¤ URL ä¸­çš„ databaseId è¤‡è£½ä¸‹ä¾†ï¼Œè²¼åˆ°è¨­å®šé é¢ä¸­å¾ŒæŒ‰ä¸‹å„²å­˜å³å¯ã€‚

![save-kaomoji-config](/cod-toys/save-kaomoji-config.png)

### å–å¾— Notion Database è³‡æ–™

ç¾åœ¨è¨­å®šè³‡æ–™æœ‰äº†ï¼Œè®“æˆ‘å€‘ä¸²æ¥ Notion API å§ã€‚

å®‰è£ `@notionhq/client` å¥—ä»¶ä¾†å­˜å– Notion API ä¸¦åŠ å…¥å–å¾—è³‡æ–™é‚è¼¯ã€‚

`src\domains\feature-card-kaomoji\index.vue`

```vue
<template>
  <template v-if="visible">
    <feature-option
      v-if="!isFeature"
      class="p-4"
      icon="emoticon"
      text="è¼¸å…¥ @ æœå°‹é¡æ–‡å­—"
      :action="() => setText('@')"
    />

    <template v-else>
      <feature-option
        v-for="item, i in list"
        :key="i"
        class="w-full px-4 py-2"
        :action="() => copy(item.value)"
      >
        <div class="flex-1">
          {{ item.value }}
        </div>

        <div class="flex">
          <q-chip
            v-for="tag in item.tags"
            :key="tag"
            :label="tag"
          />
        </div>
      </feature-option>
    </template>
  </template>
</template>

<script setup lang="ts">
import type { UserConfig } from '../../../electron/electron-env'
import { Client } from '@notionhq/client'
import { useAsyncState } from '@vueuse/core'
import dayjs from 'dayjs'
import { get } from 'lodash-es'
import { pipe, reduce, take } from 'remeda'
import { computed, ref, shallowRef, triggerRef } from 'vue'
import FeatureOption from '../../components/feature-option.vue'
import { useConfigApi } from '../../composables/use-config-api'
import { useFeatureStore } from '../../stores/feature.store'

const configApi = useConfigApi()
const featureStore = useFeatureStore()

// ...

const {
  state: config,
  execute: refreshConfig,
} = useAsyncState(
  () => configApi.get(),
  undefined,
  { immediate: false },
)

let notionClient: Client | undefined
function initNotionClient(config: UserConfig) {
  notionClient = new Client({
    auth: config.kaomoji.token,
  })
}

const updatedAt = shallowRef(dayjs())
const notionData = shallowRef<any[]>([])
const startCursor = ref('')
const {
  isLoading: isDataLoading,
  execute: getData,
} = useAsyncState(
  async () => {
    const databaseId = config.value?.kaomoji.databaseId
    if (!databaseId) {
      throw new Error('å°šæœªè¨­å®š databaseId')
    }

    return notionClient?.databases.query({
      database_id: databaseId,
      start_cursor: startCursor.value ? startCursor.value : undefined,
    })
  },
  undefined,
  {
    immediate: false,
    onSuccess(result) {
      notionData.value.push(...(result?.results ?? []))

      if (result?.has_more && result.next_cursor) {
        startCursor.value = result.next_cursor
        getData()
        return
      }

      triggerRef(notionData)
      updatedAt.value = dayjs()
    },
  },
)

function refreshData() {
  startCursor.value = ''
  notionData.value = []
  getData()
}

interface ListItem {
  value: string;
  tags: string[];
}
const list = computed(() => pipe(
  notionData.value,
  reduce((acc: ListItem[], result) => {
    acc.push({
      // @notionhq/client çš„å‹åˆ¥èˆ‡å¯¦éš›è³‡æ–™æœ‰é»å‡ºå…¥ï¼Œè‡ªè¡Œå¾å›æ‡‰åˆ¤æ–·
      value: get(result, 'properties.value.title[0].plain_text', '') as string,
      tags: pipe(
        get(result, 'properties.tags.multi_select', []) as { name: string }[],
        (value) => {
          if (!value) {
            return []
          }

          return value.map((item) => item.name)
        },
      ),
    })

    return acc
  }, []),
  // å…ˆé¡¯ç¤º 5 å€‹çœ‹çœ‹
  take(5),
))

configApi.onUpdate(async (config) => {
  init(config)
})

async function init(config?: UserConfig) {
  const _config = config ?? await refreshConfig()
  if (!_config) {
    return
  }

  initNotionClient(_config)
  refreshData()
}
init()
</script>
```

![get-kaomoji-database-data](/cod-toys/get-kaomoji-database-data.png)

è³‡æ–™é€²ä¾†äº†ï¼( Â´ â–½ ` )ï¾‰

æ¥è‘—æ–°å¢æ›´æ–°ç”¨çš„æŒ‰éˆ•ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥æ‰‹å‹•æ›´æ–°è³‡æ–™ã€‚

`src\domains\feature-card-kaomoji\index.vue`

```vue
<template>
  <template v-if="visible">
    <feature-option
      v-if="!isFeature"
      ...
    />

    <template v-else>
      <feature-option
        v-for="item, i in list"
        :key="i"
        ...
      >
        ...
      </feature-option>

      <feature-option
        class="relative w-full bg-primary/10 p-4"
        :action="() => refreshData()"
      >
        <div class="w-full flex items-center justify-around">
          <span class="flex-1">
            æ›´æ–°è³‡æ–™
          </span>
          <span class="flex-1 text-right text-xs text-gray-500">
            å…± {{ list.length }} ç­†ï¼Œæœ€å¾Œæ›´æ–°æ–¼ {{ updatedAt.format('YYYY/MM/DD HH:mm:ss') }}
          </span>
        </div>

        <q-inner-loading :showing="isDataLoading" />
      </feature-option>
    </template>
  </template>
</template>
```

![refresh-kaomoji-database-data](/cod-toys/refresh-kaomoji-database-data.gif)

ç”±æ–¼è³‡æ–™å¯èƒ½å¾ˆå¤šï¼Œæœ€å¾Œè®“æˆ‘å€‘å¯¦ç¾åˆ†é åŠŸèƒ½å§ï¼

`src\domains\feature-card-kaomoji\index.vue`

```vue
<template>
  <template v-if="visible">
    <feature-option
      v-if="!isFeature"
    />

    <template v-else>
      <!-- WARNING --> // [!code highlight]
      <div
        :key="pagination.page"
        class="flex-col"
      >
        <feature-option
          v-if="nextPageVisible"
          class="w-full px-4 py-2"
          :action="() => nextPage()"
        >
          <span class="flex-1">
            ä¸‹ä¸€é  ({{ pagination.page + 1 }}/{{ totalPages }})
          </span>
        </feature-option>

        ...
      </div>
    </template>
  </template>
</template>

<script setup lang="ts">
import { chunk, pipe } from 'remeda'
import { computed, nextTick, ref } from 'vue'
import FeatureOption from '../../components/feature-option.vue'

// ...

const pagination = ref({
  page: 0,
  itemsPerPage: 5,
})
watch(inputText, () => {
  pagination.value.page = 0
})
const totalPages = computed(() => Math.ceil(list.value.length / pagination.value.itemsPerPage))

const paginationList = computed(() => pipe(
  list.value,
  chunk(pagination.value.itemsPerPage),
  (data) => data[pagination.value.page] ?? [],
))

const nextPageVisible = computed(() => totalPages.value > 1)
async function nextPage() {
  pagination.value.page += 1
  pagination.value.page %= totalPages.value

  await nextTick()
  featureStore.setOption(featureStore.optionIdList[0] ?? '')
}

configApi.onUpdate(async (config) => {
  init(config)
})

// ...
</script>
```

::: warning
ç¨‹å¼ç¢¼ä¸­æœ‰å€‹ `<!-- WARNING -->` éƒ¨åˆ†ï¼Œ`:key="pagination.page"` æ˜¯ç‚ºäº†åœ¨æ›é æ™‚å¼·åˆ¶é‡æ–°æ¸²æŸ“ï¼Œæ‰èƒ½ä¿è­‰æ‰€æœ‰ option é †åºä¸€è‡´ï¼Œé€™å€‹æ–¹æ³•æœƒæœ‰ä¸å¿…è¦çš„æ€§èƒ½æè™Ÿï¼Œæœªä¾†å†ä¾†æ”¹é€²ã€‚
:::

![pagination-kaomoji-data](/cod-toys/pagination-kaomoji-data.gif)

æ‰€æœ‰çš„è³‡æ–™éƒ½é€²ä¾†äº†ï¼âœ§â‘ï½¡Ù©(ËŠá—œË‹*)Ùˆâœ§â•ï½¡

### æ¨¡ç³Šéæ¿¾

æœ€å¾Œè®“æˆ‘å€‘ä¾†å¯¦ä½œæ¨¡ç³Šéæ¿¾åŠŸèƒ½å§ï¼

æˆ‘å€‘å¸Œæœ›å³ä½¿åªæœ‰éƒ¨åˆ†æ–‡å­—ç¬¦åˆï¼Œä¹Ÿèƒ½å€™é¸æœ€æ¥è¿‘çš„è³‡æ–™ã€‚

é€™è£¡ä½¿ç”¨ [fuse.js](https://fusejs.io/) å¯¦ä½œæ¨¡ç³Šéæ¿¾åŠŸèƒ½ã€‚

é€™å€‹éƒ¨ä»½å¾ˆå–®ç´”ï¼Œå›°é›£çš„éƒ¨åˆ† `fuse.js` å·²ç¶“å¹«æˆ‘å€‘è™•ç†å¥½äº†ï¼Œæˆ‘å€‘åªè¦çˆ½çˆ½ç”¨å°±è¡Œæƒ¹ã€‚<span class="text-nowrap">Ïˆ(ï½€âˆ‡Â´)Ïˆ</span>

`src\domains\feature-card-kaomoji\index.vue`

```vue
// ...

<script setup lang="ts">
// ...

const fuseInstance = new Fuse(list.value, {
  keys: ['tags'],
})
watch(list, (value) => {
  fuseInstance.setCollection(value)
})

const filteredList = computed(() => {
  if (inputText.value === '@') {
    return list.value
  }

  const text = pipe(
    inputText.value,
    (value) => {
      if (value.startsWith('@')) {
        return value.slice(1)
      }

      return value
    },
    (value) => value.trim(),
  )

  const result = fuseInstance.search(text)

  return pipe(
    result,
    map(prop('item')),
  )
})

// ...

const totalPages = computed(() => Math.ceil(
  list.value.length / pagination.value.itemsPerPage, // [!code --]
  filteredList.value.length / pagination.value.itemsPerPage, // [!code ++]
))

const paginationList = computed(() => pipe(
  list.value, // [!code --]
  filteredList.value, // [!code ++]
  chunk(pagination.value.itemsPerPage),
  (data) => data[pagination.value.page] ?? [],
))

// ...
</script>
```

![fuse-search](/cod-toys/fuse-search.gif)

å°±é€™éº¼ç°¡å–®ã€‚(*Â´âˆ€`)~â™¥

ç¾åœ¨è®“æˆ‘å€‘å®Œæ•´çš„å±•ç¤ºä¸€æ¬¡åŠŸèƒ½ã€‚

- è¼¸å…¥ @ å¯ä»¥é–‹å§‹æœå°‹é¡æ–‡å­—
- æ²’æœ‰åŒ¹é…ä»»ä½•åŠŸèƒ½æ™‚ï¼Œå‰‡é–‹å•Ÿ Google æœå°‹

![phase-1-completed](/cod-toys/phase-1-completed.gif)

æ„Ÿè¦ºè¶…è®šï¼âœ§â‘ï½¡Ù©(ËŠá—œË‹*)Ùˆâœ§â•ï½¡

## æ”¹é€²èˆ‡é‡æ§‹

å¯¦éš›ä¸Šä½¿ç”¨å¾Œç™¼ç¾æœ‰äº›åœ°æ–¹éœ€è¦æ”¹é€²ï¼Œè®“æˆ‘å€‘ä¾†æ”¹é€²ä¸€ä¸‹å§ï¼<span class="text-nowrap">à©­ Ë™á—œË™ )à©­</span>

### å–æ¶ˆæ»‘é¼  hover æ•ˆæœ

æ»‘é¼  hover æ•ˆæœæœƒè®“ä½¿ç”¨è€…æ··æ·†ç›®å‰é¸é …ï¼Œç‹ å¿ƒåˆªé™¤ã€‚<span class="text-nowrap">Ô…( Ë˜Ï‰Ë˜Ô…)</span>

`src\components\feature-option.vue`

```vue
// ...

<script setup lang="ts">
// ...
const optionRef = ref<HTMLDivElement>()
const isHover = useElementHover(optionRef) // [!code --]
const selected = computed( // [!code --]
  () => isHover.value || featureStore.selectedOptionId === id, // [!code --]
) // [!code --]
const selected = computed(() => featureStore.selectedOptionId === id) // [!code ++]
</script>
```

### feature-option é‡è¤‡ä½¿ç”¨æ™‚ï¼Œé¸æ“‡é †åºéŒ¯èª¤å•é¡Œ

å‰›å‰›æåˆ° `<!-- WARNING -->` å¼·åˆ¶æ›´æ–°éƒ¨åˆ†ï¼Œé€™è£¡æˆ‘å€‘ä¾†æ”¹é€²ä¸€ä¸‹ã€‚

`featureStore` è¨»å†Š option æ™‚ï¼Œå¤šæä¾›å…ƒä»¶ y åº§æ¨™ä½ç½®ï¼Œåªè¦æ ¹æ“š y åº§æ¨™æ’åºï¼Œé¸é …é †åºå°±æœƒåŒæ­¥è‡ªç„¶é †åºäº†ã€‚

`src\stores\feature.store.ts`

```ts
import { defineStore } from 'pinia'
import { map, pipe, sortBy } from 'remeda'
import { computed, shallowRef } from 'vue'

interface OptionValue {
  y: number; // [!code ++]
  action: () => void;
}

export const useFeatureStore = defineStore('feature', () => {
  const optionMap = shallowRef(new Map<string, OptionValue>())
  const optionIdList = computed(() => pipe(
    [...optionMap.value.keys()], // [!code --]
    /** ä¾ç…§æ•¸å­—æ’åºï¼Œä¿è­‰ option é †åº */ // [!code --]
    sortBy((id) => Number.parseInt(id.replace(/\D/g, ''), 10)), // [!code --]
    [...optionMap.value.entries()], // [!code ++]
    /** ä¾ç…§ç•«é¢ y åº§æ¨™æ’åºï¼Œä¿è­‰ option è‡ªç„¶é †åº */// [!code ++]
    sortBy((data) => data[1].y), // [!code ++]
    map(([id]) => id), // [!code ++]
  ))

  // ...
})
```

feature-option å…ƒä»¶è¨»å†Šæ™‚æä¾› y åº§æ¨™ã€‚

`src\components\feature-option.vue`

```vue
// ...

<script setup lang="ts">
// ...

const { y } = useElementBounding(optionRef)

featureStore.addOption(id, { // [!code --]
  action: props.action, // [!code --]
}) // [!code --]

watch(y, (value) => { // [!code ++]
  featureStore.addOption(id, { // [!code ++]
    y: value, // [!code ++]
    action: props.action, // [!code ++]
  }) // [!code ++]
}) // [!code ++]
// ...
</script>
```

### æ•¸å­—éµç›¤å¿«é€Ÿé¸æ“‡

ä¸€ç›´æŒ‰ä¸Šä¸‹éµæœ‰é»éº»ç…©ï¼ŒåŠ å€‹ä½¿ç”¨æ•¸å­—éµå¿«é€Ÿé¸æ“‡åŠŸèƒ½ã€‚( â€¢Ì€ Ï‰ â€¢Ì )âœ§

ä½¿ç”¨ VueUse çš„ `useMagicKeys` è¼•é¬†å¯¦ç¾ã€‚<span class="text-nowrap">(Â´,,â€¢Ï‰â€¢,,)</span>

é–‹å§‹å‰å…ˆè®“æˆ‘å€‘æ•´ç†ã€é‡æ§‹ä¸€ä¸‹å…§å®¹ï¼Œè®“å…ƒä»¶å…§çš„ç¨‹å¼ç¢¼æ›´å…§èšä¸€é»ã€‚

å…ƒä»¶èˆ‡è³‡æ–™å¯ä»¥ç¨ç«‹å­˜åœ¨ï¼Œæ‰€ä»¥é¦–å…ˆæŠ½é›¢è³‡æ–™éƒ¨åˆ†ã€‚

`src\domains\feature-card-kaomoji\use-kaomoji-data.ts`

```ts
// ...

export function useKaomojiData(
  inputText: Ref<string>,
) {
  const configApi = useConfigApi()
  const featureStore = useFeatureStore()

  const {
    state: config,
    execute: refreshConfig,
  } = useAsyncState(
    // ...
  )

  let notionClient: Client | undefined
  function initNotionClient(config: UserConfig) {
    // ...
  }

  const updatedAt = shallowRef(dayjs())
  const notionData = shallowRef<any[]>([])
  const startCursor = ref('')
  const {
    isLoading,
    execute: getData,
  } = useAsyncState(
    // ...
  )

  function refreshData() {
    // ...
  }

  interface ListItem {
    value: string;
    tags: string[];
  }
  const list = computed(() => pipe(
    // ...
  ))

  const fuseInstance = new Fuse(list.value, {
    keys: ['tags'],
  })
  watch(list, (value) => {
    fuseInstance.setCollection(value)
  })

  const filteredList = computed(() => {
    // ...
  })

  const pagination = ref({
    page: 0,
    itemsPerPage: 5,
  })
  watch(inputText, () => {
    pagination.value.page = 0
  })
  const totalPages = computed(() => Math.ceil(
    filteredList.value.length / pagination.value.itemsPerPage,
  ))

  const paginationList = computed(() => pipe(
    // ...
  ))

  async function nextPage() {
    // ...
  }

  configApi.onUpdate(async (config) => {
    init(config)
  })

  async function init(config?: UserConfig) {
    // ...
  }

  return {
    isLoading,
    updatedAt,

    list,

    pagination,
    paginationList,
    totalPages,
    nextPage,

    init,
    refreshData,
  }
}
```

åŸºæœ¬ä¸Šå°±æ˜¯æŠŠè³‡æ–™çš„éƒ¨ä»½æŠ½é›¢ï¼Œæ‰€ä»¥å…·é«”å…§å®¹å°±ä¸è´…è¿°äº†ã€‚

ç¾åœ¨å…ƒä»¶å…§éƒ¨è®Šå¾—ç›¸ç•¶ç°¡æ½”ã€‚

`src\domains\feature-card-kaomoji\index.vue`

```vue
<template>
  ...
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { useKaomojiData } from './use-kaomoji-data'

// ...

function copy(text: string) {
  // ...
}

const {
  isLoading,
  updatedAt,
  pagination,
  paginationList,
  list,
  nextPage,
  totalPages,
  refreshData,
  init,
} = useKaomojiData(inputText)
init()

const nextPageVisible = computed(() => totalPages.value > 1)
</script>
```

ç¾åœ¨è®“æˆ‘å€‘åœ¨ `featureStore` æ–°å¢ä¸€å€‹ methodã€‚

`src\stores\feature.store.ts`

```ts
// ...
export const useFeatureStore = defineStore('feature', () => {
  // ...
  function setOptionByIndex(index: number) {
    selectedOptionId.value = optionIdList.value[index] ?? ''
  }
  // ...

  return {
    // ...
    setOptionByIndex,
  }
})
```

æœ€å¾Œåœ¨å…ƒä»¶ä¸­ä½¿ç”¨ `useMagicKeys` ä¸¦åŠ ä¸Šå¿«æ·éµæç¤ºå§ã€‚à©­ Ë™á—œË™ )à©­

`src\domains\feature-card-kaomoji\index.vue`

```vue
<template>
  <template v-if="visible">
    <feature-option
      v-if="!isFeature"
      ...
    />

    <template v-else>
      <feature-option
        v-if="nextPageVisible"
        ...
      >
        <q-chip
          v-if="isFeature"
          label="Ctrl+1"
          square
          outline
          color="primary"
        />
        <span class="flex-1">
          ä¸‹ä¸€é  ({{ pagination.page + 1 }}/{{ totalPages }})
        </span>
      </feature-option>

      <feature-option
        v-for="item, i in paginationList"
        :key="i"
        ...
      >
        <q-chip
          v-if="isFeature"
          :label="`Ctrl+${i + textStartIndex}`"
          square
          outline
          color="primary"
        />

        ...
      </feature-option>

      ...
    </template>
  </template>
</template>

<script setup lang="ts">
// ...

const nextPageVisible = computed(() => totalPages.value > 1)

const textStartIndex = computed(() => nextPageVisible.value ? 2 : 1)

const { current } = useMagicKeys()

watch(current, (keySet) => {
  // åƒ…ä½¿ç”¨æ­¤åŠŸèƒ½æ‰ä½œç”¨ï¼Œé¿å…å¹²æ“¾å…¶ä»–åŠŸèƒ½
  if (!isFeature.value || keySet.size === 0)
    return

  if (!keySet.has('control'))
    return

  /** 1~6 */
  const numberKey = [...keySet].find((key) => key.match(/^[1-6]$/))
  if (numberKey) {
    const index = Number(numberKey) - 1
    featureStore.setOptionByIndex(index)
    featureStore.currentOption?.action()
  }
}, { deep: true })
</script>
```

ç¾åœ¨æˆ‘å€‘å¯ä»¥å¾ˆå¿«é€Ÿåœ°é¸æ“‡ç›®æ¨™é¡æ–‡å­—äº†ï¼( â€¢Ì€ Ï‰ â€¢Ì )âœ§

![shortcut-key-selection-options](/cod-toys/shortcut-key-selection-options.gif)

## ç¸½çµ ğŸŸ

ä»¥ä¸Šç¨‹å¼ç¢¼å¯ä»¥[åœ¨æ­¤å–å¾—](https://github.com/Codfisher/side-project-cod-toys/tree/feat/kaomoji-database)

- ä¸²æ¥ Notion APIï¼Œå®Œæˆé¡æ–‡å­—è³‡æ–™åº«åŠŸèƒ½
- æŠ½é›¢ã€é‡æ§‹ç¨‹å¼ç¢¼ï¼Œè®“ç¨‹å¼ç¢¼æ›´å…·å…§èšæ€§
- åŠ å…¥å¿«æ·éµåŠŸèƒ½ï¼Œè®“ä½¿ç”¨è€…æ›´å¿«é€Ÿé¸æ“‡é¡æ–‡å­—

æ„Ÿè¦ºé‚„å¯ä»¥åŠ å…¥å¾ˆå¤šå¾ˆæœ‰è¶£çš„åŠŸèƒ½ï¼Œæ­¡è¿å¤§å®¶ç•™è¨€æˆ–å¯«ä¿¡è¨±é¡˜å–”ï¼(Â´â–½`Êƒâ™¡Æª)

::: tip
å› ç‚ºç¯‡å¹…å•é¡Œï¼ŒæŸäº›éƒ¨åˆ†ç°¡å–®å¸¶éã€‚

è‹¥æƒ³çœ‹åˆ°æ›´è©³ç´°çš„è§£é‡‹ï¼Œè«‹ä¸åç•™è¨€æˆ–å¯«ä¿¡çµ¦æˆ‘å–”ï¼<span class="text-nowrap">(*Â´âˆ€`)~â™¥</span>
:::
