---
title: CodToys - EP03ï¼šé¡æ–‡å­—è³‡æ–™åº«
description: ä¸Šä¸€ç« ç¯€æˆ‘å€‘å®Œæˆäº†å¿«æ·éµé–‹é—œè¦–çª—åŠŸèƒ½ï¼Œé€™ä¸€ç« ç¯€æˆ‘å€‘ä¾†å¯¦ä½œåŠŸèƒ½é¸é …éƒ¨åˆ†å§ï¼
tags: ['CodToys', 'Electron']
image: https://codlin.me/cod-toys.webp
date: 20241227
---

# CodToys - EP03ï¼šé¡æ–‡å­—è³‡æ–™åº«

![å¿«æ¨‚å †ç©æœ¨çš„é­š](/cod-toys.webp)

ä¸Šä¸€ç« ç¯€æˆ‘å€‘å®Œæˆäº†å¿«æ·éµé–‹é—œè¦–çª—åŠŸèƒ½ï¼Œé€™ä¸€ç« ç¯€æˆ‘å€‘ä¾†å¯¦ä½œåŠŸèƒ½é¸é …éƒ¨åˆ†å§ï¼

## é–‹ç™¼

æœ¬ç« ç¯€é è¨ˆæœƒå»ºç«‹ä»¥ä¸‹å…§å®¹ï¼š

- ç”¢ç”Ÿ Trayï¼šç”¨ä¾†æŸ¥çœ‹ç‹€æ…‹èˆ‡é–‹å•Ÿè¨­å®šè¦–çª—
- å„²å­˜è¨­å®šæª”ï¼šå„²å­˜ä½¿ç”¨è€…ä¹‹ Notion API è³‡æ–™
- é€£æ¥ Notion Database
- æ¨¡ç³Šæœå°‹é¡æ–‡å­—è³‡æ–™

### ç”¢ç”Ÿ Tray

ä½¿ç”¨ [Tray æ¨¡çµ„](https://www.electronjs.org/docs/latest/api/tray)ï¼Œè¼•é¬†å®Œæˆã€‚â—( â€¢Ï‰â€¢ )â—Ÿ

åŒæ™‚å°‡ `app` çš„ `window-all-closed` äº‹ä»¶ç§»åˆ° `app.whenReady` ä¸­ï¼Œæ¸›å°‘å°æ–¼å…¨åŸŸè®Šæ•¸çš„ä¾è³´ã€‚

`electron\main.ts`

```ts
import path from 'node:path'
import process from 'node:process'
import {
  app,
  BrowserWindow,
  globalShortcut,
  Menu,
  shell,
  Tray,
} from 'electron'
import { version } from '../package.json'

function createTray(
  {
    mainWindow,
  }: {
    mainWindow: BrowserWindow;
  },
) {
  const tray = new Tray(
    path.join(__dirname, '../public/fish.ico'),
  )
  const contextMenu = Menu.buildFromTemplate([
    {
      label: 'æš«æ™‚åœç”¨',
      type: 'checkbox',
      click(item) {
        if (item.checked) {
          globalShortcut.unregisterAll()
        }
        else {
          initGlobalShortcut({ mainWindow })
        }
      },
    },
    {
      label: 'è©³ç´°è¨­å®š',
      submenu: [
        {
          label: 'é–‹å•Ÿè¨­å®šè¦–çª—',
        },
      ],
    },
    {
      label: 'é—œæ–¼',
      click: () => shell.openExternal('https://codlin.me/column-cod-toys/01-origin.html'),
    },
    { type: 'separator' },
    {
      label: 'é€€å‡ºæ‡‰ç”¨ç¨‹å¼',
      click: () => app.quit(),
    },
  ])
  tray.setToolTip(`CodToys v${version}`)
  tray.setContextMenu(contextMenu)

  return tray
}

app.whenReady().then(async () => {
  const mainWindow = await createInputWindow()

  initGlobalShortcut({ mainWindow })

  initIpcMain({ configStore })

  const tray = createTray({ mainWindow })

  app.on('window-all-closed', () => { // [!code ++]
    if (process.platform !== 'darwin') { // [!code ++]
      app.quit()// [!code ++]
    }// [!code ++]

    globalShortcut.unregisterAll()// [!code ++]
    tray.destroy()// [!code ++]
  })// [!code ++]
})

app.on('window-all-closed', () => { // [!code --]
  if (process.platform !== 'darwin') { // [!code --]
    app.quit()// [!code --]
  }// [!code --]

  globalShortcut.unregisterAll()// [!code --]
})// [!code --]
```

ç¾åœ¨æœƒæ³¨æ„åˆ°ç³»çµ±æ‰˜ç›¤æœƒå‡ºç¾é­šçš„åœ–ç¤ºï¼Œé»æ“Šå³éµæœƒå‡ºç¾æ›´å¤šé¸å–®ã€‚

![create-tray](/cod-toys/create-tray.png)

### å„²å­˜ä½¿ç”¨è€…è¨­å®š

é€™è£¡ä½¿ç”¨ [electron-store](https://www.npmjs.com/package/electron-store) ä¾†å„²å­˜ä½¿ç”¨è€…è¨­å®šã€‚

å®‰è£å¥—ä»¶å¾Œï¼Œç¬¬ä¸€æ­¥å…ˆä¾†å®šç¾©ä¸€ä¸‹ä½¿ç”¨è€…è¨­å®šå‹åˆ¥ä¸¦æ–°å¢ `ConfigApi`ï¼Œç”¨æ–¼å­˜å–ä½¿ç”¨è€…è¨­å®šã€‚
`electron\electron-env.d.ts`

```ts
export interface MainApi {
  // ...
}

export interface UserConfig {
  kaomoji: {
    databaseId: string;
    token: string;
  };
}
export interface ConfigApi {
  get: () => Promise<UserConfig>;
  update: (data: Partial<UserConfig>) => Promise<void>;
  onUpdate: (callback: (config: UserConfig) => void) => void;
}

declare global {
  interface Window {
    main: MainApi;
    config: ConfigApi; // [!code ++]
  }
}

export { }
```

æ¥è‘—åœ¨ main process åˆå§‹åŒ– store ä¸¦è¨»å†Š `ipcMain`ã€‚

é€™è£¡åŒæ™‚é‡æ§‹ä¸€ä¸‹ `ipcMain` çš„éƒ¨åˆ†ï¼Œwindow ç›¸é—œæ§åˆ¶æ”¹ç‚ºé‡å°ç™¼é€çš„ windowï¼Œä¸é™å®šåªèƒ½æ§åˆ¶ `mainWindow`ã€‚

`electron\main.ts`

```ts{20-30,36-50,72}
import type { UserConfig } from './electron-env'
import {
  app,
  BrowserWindow,
  ipcMain,
  shell,
} from 'electron'
import Store from 'electron-store'

type ConfigStore = Store<{ config: UserConfig }>

function initIpcMain(
  {
    configStore,
  }: {
    configStore: ConfigStore;
  },
) {
  // main
  ipcMain.on('main:updateHeight', (event, height: number) => {
    const window = BrowserWindow.fromWebContents(event.sender)

    window?.setBounds({ height })
  })
  ipcMain.on('main:hideWindow', (event) => {
    const window = BrowserWindow.fromWebContents(event.sender)

    window?.setFocusable(false)
    window?.hide()
  })
  ipcMain.on('main:openExternal', (event, url: string) => {
    shell.openExternal(url)
  })

  // config
  ipcMain.handle('config:get', async () => {
    return configStore.get('config')
  })
  ipcMain.handle('config:update', async (event, config) => {
    const data = configStore.get('config')
    configStore.set('config', {
      ...data,
      ...config,
    })

    // å‘æ‰€æœ‰è¦–çª—è§¸ç™¼ config:onUpdate äº‹ä»¶
    BrowserWindow.getAllWindows().forEach((window) => {
      window.webContents.send('config:onUpdate', config)
    })
  })
}

function createConfigStore(): ConfigStore { // [!code ++]
  const config: UserConfig = { // [!code ++]
    kaomoji: { // [!code ++]
      databaseId: '', // [!code ++]
      token: '', // [!code ++]
    }, // [!code ++]
  } // [!code ++]

  return new Store({ // [!code ++]
    name: 'config', // [!code ++]
    defaults: { config }, // [!code ++]
  }) // [!code ++]
} // [!code ++]

app.whenReady().then(async () => {
  const configStore = createConfigStore()

  // ...

  initIpcMain({ configStore })

  // ...
})
```

æ¥è‘—åœ¨ preload å¯¦ä½œ APIã€‚

`electron\preload.ts`

```ts
// ...

contextBridge.exposeInMainWorld('config', {
  get() {
    return ipcRenderer.invoke('config:get')
  },
  update(data: Partial<UserConfig>) {
    return ipcRenderer.invoke('config:update', data)
  },
  onUpdate(callback: (config: UserConfig) => void) {
    ipcRenderer.on('config:onUpdate', (event, config) => {
      callback(config)
    })
  },
})
```

ç¾åœ¨æˆ‘å€‘å¯ä»¥å„²å­˜è¨­å®šæª”äº†ï¼Œé‚„éœ€è¦ä¸€å€‹é é¢è¼¸å…¥è³‡æ–™æ‰è¡Œã€‚

### é–‹å•Ÿè¨­å®šé é¢

é è¨ˆä½¿ç”¨ Vue Routerï¼Œç”±æ–¼ Electron æœ¬èº«æ²’æœ‰ Web Serverï¼Œæ‰€ä»¥æ²’è¾¦æ³•ç›´æ¥ä½¿ç”¨ History æ¨¡å¼ï¼Œé€™è£¡æˆ‘å€‘å°‡ router æ”¹ç‚º Hash æ¨¡å¼è§£æ±ºã€‚

`src\main.ts`

```ts
import { createRouter, createWebHashHistory } from 'vue-router/auto'

// ...

const router = createRouter({
  history: createWebHashHistory(import.meta.env.BASE_URL),
  routes,
})

// ...
```

æ¥è‘—æ–°å¢è¨­å®šé é¢å§ã€‚

`src\pages\kaomoji-config\index.vue`

```vue
<template>
  <q-form
    class="relative flex-col gap-6 p-6"
    @submit="handleSubmit"
  >
    <q-input
      v-model="form.databaseId"
      outlined
      label="databaseId"
    />

    <q-input
      v-model="form.token"
      outlined
      label="token"
    />

    <q-btn
      label="å„²å­˜"
      type="submit"
      unelevated
      color="primary"
    />

    <q-inner-loading :showing="isLoading" />
  </q-form>
</template>

<script setup lang="ts">
import type { UserConfig } from '../../../electron/electron-env'
import { useAsyncState } from '@vueuse/core'
import { clone } from 'remeda'
import { ref } from 'vue'
import { useConfigApi } from '../../composables/use-config-api'

const configApi = useConfigApi()

document.title = 'é¡æ–‡å­—è¨­å®š'

const form = ref<UserConfig['kaomoji']>({
  databaseId: '',
  token: '',
})

const {
  isLoading,
} = useAsyncState(
  () => configApi.get(),
  undefined,
  {
    onSuccess(data) {
      if (data) {
        form.value = data.kaomoji
      }
    },
  },
)

function handleSubmit() {
  // clone è™•ç†ï¼Œé¿å… Error: An object could not be cloned
  configApi.update(clone({
    kaomoji: form.value,
  }))
}
</script>
```

ç¾åœ¨è®“æˆ‘å€‘é€é Tray çš„é¸å–®é–‹å•Ÿæ­¤è¨­å®šé é¢å§ã€‚

å»ºç«‹ `createConfigWindow` ç”¨æ–¼é–‹å•ŸæŒ‡å®šé é¢ä¸¦å°‡ç›®æ¨™ route path åŠ åœ¨ # å¾Œé¢å³å¯ã€‚

```ts
// ...

async function createConfigWindow(route: keyof RouteNamedMap) {
  const newWindow = new BrowserWindow({
    backgroundColor: '#fff',
    webPreferences: {
      preload: path.join(__dirname, './preload.js'),
    },
  })
  // éš±è—é è¨­ç³»çµ±é¸å–®
  newWindow.setMenu(null)

  if (process.env.VITE_DEV_SERVER_URL) {
    await newWindow.loadURL(
      `${process.env.VITE_DEV_SERVER_URL}#${route}`,
    )
    // newWindow.webContents.openDevTools()
  }
  else {
    // loadFile å¯ä»¥æŒ‡å®š hash
    await newWindow.loadFile('dist/index.html', {
      hash: route,
    })
  }

  return newWindow
}

// ...

function createTray(
  {
    mainWindow,
  }: {
    mainWindow: BrowserWindow;
  },
) {
  // ...
  const contextMenu = Menu.buildFromTemplate([
    {
      label: 'æš«æ™‚åœç”¨',
      // ...
    },
    {
      label: 'è©³ç´°è¨­å®š',
      submenu: [
        {
          label: 'é–‹å•Ÿè¨­å®šè¦–çª—',
          click: () => createConfigWindow('/kaomoji-config/'), // [!code ++]
        },
      ],
    },
    // ...
  ])
  // ...
}

// ...
```

:::tip
`RouteNamedMap` æ˜¯ `unplugin-vue-router` è‡ªå‹•ç”¢ç”Ÿçš„å‹åˆ¥ï¼Œç”¨æ–¼å®šç¾©æ‰€æœ‰é é¢è·¯ç”±åç¨±ã€‚
:::

## ç¸½çµ ğŸŸ

ä»¥ä¸Šç¨‹å¼ç¢¼å¯ä»¥[åœ¨æ­¤å–å¾—](https://github.com/Codfisher/side-project-cod-toys/tree/feat/kaomoji-database)
