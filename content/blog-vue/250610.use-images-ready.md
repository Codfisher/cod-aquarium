---
description: åµæ¸¬åœ–ç‰‡è¼‰å…¥
tags: ['Vue']
image: https://codlin.me/img.webp
date: 202
draft: true
---

![img](/img.webp){.cover}

# æ¨™é¡Œ

```ts
import { type MaybeElement, promiseTimeout, useEventListener } from '@vueuse/core'
import { pipe } from 'remeda'
import { getCurrentInstance, onMounted, ref, toValue } from 'vue'

interface UseImagesReadyParams {
  /** ä¸æŒ‡å®šå‰‡ç‚ºç›®å‰å…ƒä»¶ */
  target?: MaybeElement;
  /** å¼·åˆ¶å»¶é²ï¼ˆmsï¼‰ï¼Œä¿éšªèµ·è¦‹ */
  delay?: number;
}

/** åµæ¸¬ç›®æ¨™ä¸‹æ‰€æœ‰åœ–ç‰‡æ˜¯å¦è¼‰å…¥å®Œæˆ */
export function useImagesReady(params: UseImagesReadyParams = {}) {
  const {
    target,
    delay = 0,
  } = params

  const isLoaded = ref(false)
  const instance = getCurrentInstance()

  function isElementVisible(el: HTMLElement): boolean {
    const style = getComputedStyle(el)
    return style.display !== 'none' && style.visibility !== 'hidden'
  }

  onMounted(() => {
    const rootElement = pipe(
      toValue(target),
      (value) => {
        if (value && '$el' in value) {
          return value.$el
        }

        return value
          ?? instance?.vnode?.el
          ?? instance?.proxy?.$el
          ?? document.documentElement
      },
      (value) => value as HTMLElement | undefined,
    )

    if (!rootElement) {
      isLoaded.value = true
      console.warn('[useImagesReady] no element found')
      return
    }

    const imageElements = Array.from(
      rootElement.querySelectorAll('img'),
    ).filter((img) =>
      /** æ’é™¤ display:none çš„å…ƒç´ ï¼ŒoffsetParent
       *
       * æš«æ™‚ä¸è€ƒæ…® background-image
       *
       * https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetParent
       */
      img.src && isElementVisible(img),
    )
    const totalImages = imageElements.length

    if (totalImages === 0) {
      isLoaded.value = true
      return
    }

    let loadedCount = 0

    async function checkCompletion() {
      if (loadedCount === totalImages) {
        await promiseTimeout(delay)
        isLoaded.value = true
      }
    }

    function handleEvent() {
      loadedCount++
      checkCompletion()
    }

    imageElements.forEach((img) => {
      if (img.complete) {
        loadedCount++
        return
      }

      useEventListener(img, 'load', handleEvent, { once: true })
      useEventListener(img, 'error', handleEvent, { once: true })
    })

    checkCompletion()
  })

  return { isLoaded }
}
```

## ç¸½çµ ğŸŸ
