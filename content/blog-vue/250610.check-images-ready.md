---
description: ç¢ºä¿åœ–ç‰‡éƒ½ä¹–ä¹–è¼‰å…¥å®Œæˆï¼Œä¸€å€‹éƒ½ä¸èƒ½å°‘ï¼é †ä¾¿ç©ç©çœ‹ Vitest çš„ Browser Mode(ãƒ»âˆ€ãƒ»)ï¼™
tags: ['Vue', 'Vitest']
image: https://codlin.me/img.webp
date: 20250610
draft: true
---

![img](/img.webp){.cover}

# ç”šéº¼ï¼Ÿåœ–ç‰‡é‚„æ²’å¥½å–”ï¼Î£(ËŠĞ”Ë‹;)

æœ€è¿‘é–‹ç™¼ç¶²é åˆ—å°åŠŸèƒ½æ™‚ï¼Œç™¼ç¾ä½¿ç”¨è€…åˆ—å°ç•¶ä¸‹ï¼Œåœ–ç‰‡å¯èƒ½é‚„æ²’å‡ºç¾ï¼Œå°è‡´é é¢ä¸å®Œæ•´ã€‚%(â—â€¸â—Ÿ )%

æ€éº¼è¾¦å“©ï¼Ÿä¾†åšä¸€å€‹åœ–ç‰‡è¼‰å…¥å®Œæˆçš„æª¢æŸ¥å§ï¼%(ãƒ»âˆ€ãƒ»)ï¼™%

## é‡æ¸…éœ€æ±‚

ç¬¬ä¸€å…ˆä¾†é‡æ¸…éœ€æ±‚ï¼Œé€™å€‹åŠŸèƒ½çš„ç›®çš„æ˜¯ï¼š

1. ç¢ºä¿æŒ‡å®š DOM ä¸‹æ‰€æœ‰åœ–ç‰‡éƒ½è¼‰å…¥å®Œæˆ
1. å¦‚æœåœ–ç‰‡ä¸å¯è¦‹ï¼ˆåŒ…å«å…¶çˆ¶å…ƒç´ ï¼‰ï¼Œå‰‡å¿½ç•¥
1. éœ€è€ƒæ…® background-image

## å¯¦ä½œ

ç†Ÿæ‚‰ Web é–‹ç™¼çš„äººï¼Œæ‡‰è©²éƒ½çŸ¥é“åœ–ç‰‡è¼‰å…¥å®Œæˆå¯ä»¥é€é `load` äº‹ä»¶ä¾†è™•ç†ã€‚

çŸ¥é“é€™é»å¾Œï¼Œå…¶å¯¦å°±å¾ˆç°¡å–®äº†ï¼Œè®“æˆ‘å€‘å»ºç«‹ä¸€å€‹ `useImagesReady` ä¾†è™•ç†é€™ä»¶äº‹ã€‚

`composables\use-images-ready.ts`

```ts
import { type MaybeElement, promiseTimeout, useEventListener } from '@vueuse/core'
import { pipe } from 'remeda'
import { getCurrentInstance, onMounted, ref, toValue } from 'vue'

interface UseImagesReadyParams {
  /** ä¸æŒ‡å®šå‰‡ç‚ºç›®å‰å…ƒä»¶ */
  target?: MaybeElement;
  /** å¼·åˆ¶å»¶é²ï¼ˆmsï¼‰ï¼Œä¿éšªèµ·è¦‹ */
  forceDelay?: number;
}

/** åµæ¸¬ç›®æ¨™ä¸‹æ‰€æœ‰åœ–ç‰‡æ˜¯å¦è¼‰å…¥å®Œæˆ
 *
 * æš«æ™‚ä¸è€ƒæ…®å‹•æ…‹æ–°å¢çš„åœ–ç‰‡
 */
export function useImagesReady(params: UseImagesReadyParams = {}) {
  const {
    target,
    forceDelay = 0,
  } = params

  const totalImages = ref(0)
  const isReady = ref(false)
  const instance = getCurrentInstance()

  onMounted(() => {
    const rootElement = pipe(
      toValue(target),
      (value) => {
        if (value && '$el' in value) {
          return value.$el
        }

        return value
          ?? instance?.vnode?.el
          ?? instance?.proxy?.$el
          ?? document.documentElement
      },
      (value) => {
        if (!value) {
          return undefined
        }

        if (value instanceof HTMLElement) {
          return value
        }

        throw new Error(
          '[useImagesReady] å–å¾—ç›®æ¨™å…ƒç´ ç•°å¸¸ï¼Œè«‹ç¢ºèª target æ˜¯å¦ç‚º HTMLElement æˆ– Vue å…ƒä»¶',
        )
      },
    )

    if (!rootElement) {
      isReady.value = true
      console.warn('[useImagesReady] ç›®æ¨™å…ƒç´ ä¸å­˜åœ¨ï¼Œç„¡æ³•åµæ¸¬åœ–ç‰‡è¼‰å…¥ç‹€æ…‹')
      return
    }

    const imageElements = Array.from(
      rootElement.querySelectorAll('img'),
    )

    totalImages.value = imageElements.length

    if (totalImages.value === 0) {
      isReady.value = true
      return
    }

    let loadedCount = 0

    async function checkCompletion() {
      if (loadedCount === totalImages.value) {
        await promiseTimeout(forceDelay)
        isReady.value = true
      }
    }

    function handleEvent() {
      loadedCount++
      checkCompletion()
    }

    imageElements.forEach((img) => {
      if (img.complete) {
        loadedCount++
        return
      }

      useEventListener(img, 'load', handleEvent, { once: true })
      useEventListener(img, 'error', handleEvent, { once: true })
    })

    checkCompletion()
  })

  return {
    isReady,
    totalImages,
  }
}
```

## ä¾†å€‹æ¸¬è©¦

å…ˆå‰éƒ½ç”¨ Playwright æ¸¬è©¦ï¼Œé€™æ¬¡ä¾†ç”¨ Vitest çš„ Browser Mode æ¸¬è©¦çœ‹çœ‹ã€‚%(ï½¡ï½¥âˆ€ï½¥)ï¾‰ï¾%

Browser Mode æœ€å¤§çš„å·®åˆ¥åœ¨æ–¼ä¸ç”¨åƒ Playwright ä¸€æ¨£é–‹å•ŸæŒ‡å®šé é¢

Vitest æœƒåœ¨å…§éƒ¨è‡ªå‹•è™•ç†ï¼Œé–‹ç™¼è€…ç”¨èµ·ä¾†å°±å¦‚åŒå¹³å¸¸å¯«å–®å…ƒæ¸¬è©¦ä¸€æ¨£å–®ç´”ã€‚

::: tip
Playwright å…¶å¯¦å¯ä»¥å–®ç´”æ¸¬è©¦å…ƒä»¶ï¼Œä¸éæ­¤åŠŸèƒ½æ­£åœ¨å¯¦é©—ä¸­ã€‚

è€Œå› å–®å…ƒæ¸¬è©¦é€šå¸¸æ˜¯ Vitestï¼Œå¦‚æœæ¸¬è©¦éƒ½èƒ½åœ¨ Vitest å®Œæˆï¼Œæ•´åˆæ€§æ›´é«˜ã€æ›´æ–¹ä¾¿ã€‚

[Playwright test-components](https://playwright.dev/docs/test-components)
:::

## ç¸½çµ ğŸŸ

é›–ç„¶é‚„æœ‰ä¸€äº›æƒ…å¢ƒèˆ‡é‚Šç•Œå•é¡Œé‚„æœªè€ƒæ…®ï¼Œä¸éé€™æ¨£å·²ç¶“å¾ˆå¤ ç”¨æƒ¹ã€‚
