---
title: èª°å·äº†æˆ‘çš„é³³æ¢¨ï¼èŠèŠæ„å¤–ä¿®æ”¹ Pinia è³‡æ–™å•é¡Œ
description: æœ‰æ™‚å€™ä½¿ç”¨ Pinia æœƒé‡åˆ°è³‡æ–™æ„å¤–è®Šæ›´å•é¡Œï¼Œé€™å…¶å¯¦ä¸æ˜¯é³³æ¢¨çš„éŒ¯ï¼Œè®“æˆ‘å€‘çœ‹çœ‹æ€éº¼å›äº‹å§ã€‚( Â´ â–½ ` )ï¾‰
tags: ['Vue', 'Pinia']
image: https://codlin.me/problem-with-accidentally-modifying-pinia-data.webp
date: 20240701
---

# èª°å·äº†æˆ‘çš„é³³æ¢¨ï¼èŠèŠæ„å¤–ä¿®æ”¹ Pinia è³‡æ–™å•é¡Œ

![æ‹¿è‘—é³³æ¢¨çš„é±ˆé­š](/problem-with-accidentally-modifying-pinia-data.webp){.cover}

ç›¸ä¿¡å¤§å®¶ç”¨ Vue 3 å¾Œæ‡‰è©²éƒ½æ”¹ç”¨ Pinia äº†å§ï¼Ÿæ²’ç”¨éçš„äººè¶•å¿«è©¦è©¦çœ‹å§ã€‚(Â´,,â€¢Ï‰â€¢,,)

Pinia æœ€ç°¡å–®çš„ç”¨æ³•å°±åƒé€™æ¨£ï¼š

`counter.ts`

```ts
import { defineStore } from 'pinia'
import { ref } from 'vue'

export const useStore = defineStore('counter', () => {
  const n = ref(0)

  return { n }
})
```

æ¥è‘—åœ¨è¦ä½¿ç”¨çš„åœ°æ–¹å‘¼å« useStoreï¼š

`App.vue`

```vue
<script setup lang="ts">
import { useStore } from './counter.ts'

const store = useStore()

function increment() {
  store.n++
}
</script>

<template>
  <button @click="increment">
    Increment {{ store.n }}
  </button>
</template>
```

å…¶å¯¦åƒé€™æ¨£ç›´æ¥æ“ä½œ `store.n` çš„æ–¹å¼ï¼Œæ–¹ä¾¿æ­¸æ–¹ä¾¿ï¼Œ~~è‹“è†é¾œè‹“è†~~ã€‚

ä½†ä¸æ˜¯å€‹å¥½åšæ³•ï¼Œé€™ç¨®æ–¹å¼å®¹æ˜“è®“è³‡æ–™æµæ··äº‚ï¼Œæƒ³åƒä¸€ä¸‹ä½ æœ‰å¤šå€‹å…ƒä»¶éƒ½ä½¿ç”¨ `store.n`ï¼Œç„¶å¾Œæƒ³æ”¹å°±æ”¹ã€‚â€¦( ãƒ»à¸´Ï‰ãƒ»à¸´)

æ¯”è¼ƒæ¨è–¦çš„æ–¹å¼é€šå¸¸ç‚ºç”± store æä¾›ä¸€å€‹ä¿®æ”¹è³‡æ–™çš„ functionï¼Œä¾‹å¦‚ï¼š

`counter.ts`

```ts
import { defineStore } from 'pinia'
import { ref } from 'vue'

interface User {
  name: string;
  price: number;
}

export const useStore = defineStore('counter', () => {
  const user = ref<User>({
    name: 'cod',
    price: 100,
  })

  function updateUser(data: Partial<User>) {
    user.value = {
      ...user.value,
      ...data,
    }
  }

  return {
    user,
    updateUser,
  }
})
```

å‘¼å«çš„éƒ¨ä»½æ”¹ç‚ºï¼š

`App.vue`

```vue
<script setup lang="ts">
import { useStore } from './counter.ts'

const store = useStore()

function increment() {
  const price = store.user.price + 1
  store.updateUser({ price })
}
</script>

<template>
  <button @click="increment">
    price: {{ store.user.price }}
  </button>
</template>
```

é€™æ¨£å¦‚æœæœªä¾†è¦æ–°å¢é‚è¼¯ã€æ¬Šé™ç”šè‡³é‡æ§‹ï¼Œéƒ½å®¹æ˜“å¾—å¤šã€‚

ä½†æ˜¯å•é¡Œä¾†äº†ï¼Œæœ‰æ™‚å€™æµç¨‹ä¸­æœƒæœ‰ã€Œç¢ºèªã€çš„æŒ‰éˆ•ï¼Œä¹Ÿå°±æ˜¯è¦æŒ‰ä¸‹ç¢ºèªå¾Œï¼Œæ‰ä¿®æ”¹ store çš„è³‡æ–™ã€‚

å‡è¨­æœ‰ä¸€å€‹è² è²¬ä¿®æ”¹ User è³‡æ–™çš„å…ƒä»¶ï¼š

`UserCard.vue`

```vue
<script setup lang="ts">
import { ref } from 'vue'
import { useStore } from './counter.ts'

const store = useStore()
const user = ref(store.user)

function increment() {
  user.value.price++
}
function cancel() {
  user.value = store.user
}
function submit() {
  store.updateUser(user.value)
}
</script>

<template>
  <div>
    <button class="button" @click="increment">
      éå¢
    </button>
    <button class="button" @click="submit">
      ç¢ºèª
    </button>

    <div>
      current price: {{ user.price }}
    </div>
  </div>
</template>

<style>
.button {
  margin: 0px 4px;
}
</style>
```

`App.vue`

```vue
<script setup lang="ts">
import { useStore } from './counter.ts'

import UserCard from './UserCard.vue'

const store = useStore()
</script>

<template>
  <div>
    store price: {{ store.user.price }}
  </div>

  <hr>

  <user-card />
</template>
```

ç›®å‰ç•«é¢å¦‚ä¸‹åœ–ã€‚

![Untitled](/problem-with-accidentally-modifying-pinia-data/Untitled.png){width="200px" height="145px"}

é€™æ™‚å€™ä½ æœƒç™¼ç¾å‡ºäº‹å•¦ï¼â•­(Â°A ,Â°`)â•®

æŒ‰ä¸‹éå¢çš„æ™‚å€™ï¼Œä¸åªå…ƒä»¶å…§çš„ user æ•¸å€¼ç™¼ç”Ÿè®ŠåŒ–ï¼Œé€£ store çš„æ•¸å€¼ä¹Ÿä¸€èµ·è®Šå•¦ï¼Î£(ËŠĞ”Ë‹;)

ç†Ÿæ‚‰ JS çš„æœ‹å‹å€‘ä¸€å®šéƒ½çŸ¥é“ç™¼ç”Ÿç”šéº¼äº‹ï¼Œé€™æ˜¯å› ç‚ºç›´æ¥æŒ‡æ´¾ç‰©ä»¶æ˜¯ Call by Referenceï¼Œæ‰€ä»¥ï¼š

```ts
const user = ref(store.user)
```

é€™å€‹éƒ¨åˆ†çš„ç¨‹å¼æœƒè®“ user ä¾èˆŠæŒ‡å‘ store çš„ userï¼Œçµæœå°±æ„å¤–æ”¹åˆ°é³³æ¢¨è£¡é¢çš„è³‡æ–™äº†ã€‚(â€ºÂ´Ï‰`â€¹ )

é€™æ™‚å€™è°æ˜çš„è®€è€…å€‘ä¸€å®šä¹Ÿæƒ³åˆ°è§£æ³•ï¼Œåœ¨ ref çš„æ™‚å€™æ‹·è²ä¸€æ¬¡ä¸å°±è¡Œäº†ï¼Ÿ

`UserCard.vue`

```vue
<script setup lang="ts">
// ...
const user = ref(clone(store.user))

function clone<Data>(data: Data): Data {
  return JSON.parse(JSON.stringify(data))
}
</script>
```

é€™æ™‚å€™æœƒç™¼ç¾ä¸–ç•Œæ¢å¾©å’Œå¹³äº†ï¼Œè³‡æ–™ä¸€åˆ‡æ­£å¸¸ï¼â—( â€¢Ï‰â€¢ )â—Ÿ

<br>

é±ˆé­šï¼šã€Œä½†æ˜¯é˜¿ã€‚(Â´â— Ï‰ â—`)ã€

è·¯äººï¼šã€Œæ€éº¼é‚£éº¼å¤šä½†æ˜¯ï¼Ÿâ€¦(â€ºÂ´Ï‰`â€¹ )ã€

<br>

å¯¦éš›ä¸Šå”ä½œé–‹ç™¼çš„æ™‚å€™é›£ä¿å¤§å®¶éƒ½æœƒæ³¨æ„åˆ°é€™ä»¶äº‹æƒ…ï¼Œæ‰€ä»¥ä¿éšªèµ·è¦‹ï¼Œå¯ä»¥åœ¨ Pinia æä¾›è³‡æ–™æ™‚å…ˆæ‹·è²ä¸€æ¬¡ã€‚

`counter.ts`

```ts
import { defineStore } from 'pinia'
import { computed, ref } from 'vue'

interface User {
  name: string;
  price: number;
}

function clone<Data>(data: Data): Data {
  return JSON.parse(JSON.stringify(data))
}

export const useStore = defineStore('counter', () => {
  const user = ref<User>({
    name: 'cod',
    price: 100,
  })

  function updateUser(data: Partial<User>) {
    user.value = {
      ...user.value,
      ...data,
    }
  }

  return {
    user: computed(() => clone(user.value)),
    updateUser,
  }
})
```

é€™æ¨£å³ä½¿å…ƒä»¶ä¸­ä½¿ç”¨

```ts
const user = ref(store.user)
```

ä¹Ÿä¸æœƒæ„å¤–ä¿®æ”¹ Pinia ä¸­çš„è³‡æ–™äº†ï¼âœ§â‘ï½¡Ù©(ËŠá—œË‹*)Ùˆâœ§â•ï½¡

ç•¶ç„¶é‚„æœ‰å…¶ä»–æ–¹å¼ï¼š

- [readonly](https://vuejs.org/api/reactivity-core.html#readonly)

  ä¸éåœ¨ TypeScript ä¸­æœƒè®“å‹åˆ¥è®Šå¾—è¤‡é›œï¼Œä½¿ç”¨ä¸Šæœƒç¨å¾®æœ‰é»éº»ç…©

- [immutable.js](https://immutable-js.com/)

  åŠŸèƒ½å¼·å¤§ï¼Œä½†æœ‰é¡å¤–çš„å­¸ç¿’ã€ä¾è³´æˆæœ¬

å°±çœ‹å¤§å®¶å–œæ­¡å“ªä¸€ç¨®äº†ã€‚â™ª( â—œÏ‰â—Ùˆ(Ùˆ

ä»¥ä¸Šç¨‹å¼å¯ä»¥ä¾†é€™è£¡å–å¾—ï¼š[ç¯„ä¾‹ç¨‹å¼](https://play.pinia.vuejs.org/#eNqtVc1OGzEQfhVrL9kI8IJAVEoDoqUcygFQaW97cXYnYNj1WrY3BEU59AH6Chw49hH6PlXbt+j4J94FKpRDL4k9nvk83+eZ2UXyTko6ayEZJWNdKC4N0WBaSSomrg7yxOg8OcwFr2WjDPmiQR0zVZKpamoyoNnKYCEGb3MRPRek1XBpGgVkGb2LphUGFDV6YF2LRmi8zjkdRP90iDjjzCeDV+PGQC0rZgB3hIxLPnMLEkKl4gWMyGLh9xSBFHVGsly6iMyHuPW1ItlqHelYyzjrXZNsJp7IVs0kvdGNQIEWNigPB6gL3unzyBPJBWfWkieZW1PQ9dZENXc2mRt03ly5HqFUWQkz0zSV3mKS+7BrY6QeZVlRCvQvoeIzRQWYTMg6exFztE/36U5W8UmGF2VclDB/eg1GbJVQr4O+cj3apjt79I1Dne0G0NqiWlCUcomyGI3PNuVXz0QpmlryCtS5NByf9Yk4rKqau1NnM6qFmGJxDcXtP+w3eu6zvlCA8s2gR8swdQXGH59cnsEc1/Gwbsq2Qu9XDj+BbqrW5ujd3reixLR7fi7bj+6Nubj6rE/mBoRekbKJOjWcv5P5+BXqXbq7dLenYtcJKGFsmRKmXDzrGldN2C7RScF0k1i5WwNldLP959rPwk4Z1r4tbp+IYDX2hzYK+WBvkVXHiLaegEILJpWLaSsKS4AUVSNg/IEZdpiW+Dsidj30fx5R4YhQgpxenp9RyZSG1C39FXx67+KGtpEdNMxd7r7f41w46PNNB0GSwSZJh+Tg0F8UQxS6I3PXsodp0NcTw8hyEJ4vMNvZ3naG5dB3euTWSswMLEigdsHwmVnlcYerh3MjZMaq1mYZbIRQ6meLOwgXOquFCns3cBzpqFIPcxQfLvUkndZphzocBpwuUU8ElUQuWDn9ibve0HYl86xQ/s+Ufv46aTeA7XGvprgoFNQgDNJ2enSU/aje2PDFEiN0O6l5dA/A3ev1JPOB630xxpPWGFfjTGtUym/zhBwVFS9u0RIzdRL6J/7z9eHn40NAyHzM2oCeSA/t1+OP39+/vUALhi5XrP5WKcyk94V78W3rvm7d6smXDLfa3Fd2SUOuTtEaJxMXI7It52RPzqOIwTdZ/gUMSr+N)

## ç¸½çµ ğŸŸ

- å°å¿ƒ call by reference å°è‡´æ„å¤–ä¿®æ”¹ Pinia è³‡æ–™
- Pinia æä¾›è³‡æ–™æ™‚å…ˆæ‹·è²ä¸€æ¬¡ï¼Œé¿å…æ„å¤–ä¿®æ”¹
