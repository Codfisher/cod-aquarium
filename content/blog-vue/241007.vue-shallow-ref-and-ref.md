---
title: Vue çš„ shallowRef æ˜¯å•¥ï¼Ÿå’Œ ref æœ‰ç”šéº¼å·®åˆ¥ï¼Ÿ
description: 
tags: ['vue']
image: https://codlin.me/vue-shallow-ref-and-ref.webp
date: 20241007

head:
  meta:
    - name: 'keywords'
      content: 'cod, lin'
---

# Vue çš„ shallowRef æ˜¯å•¥ï¼Ÿå’Œ ref æœ‰ç”šéº¼å·®åˆ¥ï¼Ÿ

![vue-shallow-ref-and-ref](/vue-shallow-ref-and-ref.webp){height="600"}

ä½¿ç”¨ Vue çš„æœ‹å‹å€‘ä¸€å®šçŸ¥é“ `ref` æ˜¯å•¥ã€‚Ô…( Ë˜Ï‰Ë˜Ô…)

ä¸çŸ¥é“å¤§å®¶æœ‰æ²’æœ‰æ³¨æ„åˆ° Vue é‚„æœ‰ä¸€å€‹åå­—æœ‰é»åƒçš„ APIï¼Œå«åš `shallowRef`ã€‚

`shallowRef` å’Œ `ref` æœ‰ç”šéº¼å·®åˆ¥å‘¢ï¼Ÿ

é¡§åæ€ç¾©ï¼Œç°¡å–®ä¾†èªª `shallowRef` åªå°æ·ºå±¤ï¼ˆç¬¬ä¸€å±¤ï¼‰é€²è¡ŒéŸ¿æ‡‰å¼è™•ç†ã€‚

ä¹Ÿå°±æ˜¯èªªä»¥ä¸‹ç¨‹å¼ç¢¼ã€‚

```vue
<script setup>
import { shallowRef } from 'vue'

const shallowData = shallowRef({ cod: [] })

async function updateShallowData() {
  shallowData.value.cod.push('fish')
}
</script>

<template>
  <div>
    shallowData: {{ shallowData.cod.length }}
  </div>
  <button @click="updateShallowData">
    æ›´æ–°è³‡æ–™
  </button>
</template>
```

[ç¨‹å¼ç¢¼å‚³é€é–€](https://play.vuejs.org/#eNp9kk1OwzAQha8y8qZFQukCVlVA/C5gAQjYYRbBmTQGx7ZiuxRFWXMDJMQlkOBMFcdg4tBSBGJnz7z3/I3thu1am0wDsjFLnail9eDQB7vNtaysqT004MpMKXN/jgW0UNSmggE5BlxzLYx25OgFB5nPYGtFPmxAmHwMV9fQrnXyzD1oAUXQwkujIdg883jx7R6uQcM1rAYm00wFTCgnscGVw0EhXTmgtJbrdNQjEyxtPFZWUR7tANJcTuPiR9gYmuU4MbyLVagnvoSWAsk3WhjTm+A9Qe4IJcXdFme/aDn7OmH+8j5/ev14e5w/PfchvZfa6WiJxdaZd3RhhZwkt85ouvI4LGfCVFYqrE9tdy2OM+LskzmLpx3Hmq8Dri/qokRx90f91s26GmdnNTqsp8jZsuezeoK+bx9enOCM1stmZfKgSP1P8xydUaFj7GV7QeeEvaKLtEfx40g9uXSHM4/aLYbqQDtlG/Wc0S/a/2f0b9yNZDP66NVZ+wk04O8u)

ç•¶æˆ‘å€‘é»æ“Šã€Œæ›´æ–°è³‡æ–™ã€æŒ‰éˆ•æ™‚ï¼Œ`{{ shallowData.cod.length }}` éƒ¨åˆ†ä¸æœƒè¢«æ›´æ–°ï¼Œæ–‡å­—æœƒä¿æŒ shallowData: 0ã€‚

é™¤é `updateShallowData` å…§å®¹æ”¹æˆï¼š

```ts
async function updateShallowData() {
  const cod = [...shallowData.value.cod, 'fish'];
  shallowData.value = { cod }
}
```

é€™æ¨£å°±æœƒå› ç‚ºç¬¬ä¸€å±¤ï¼Œä¹Ÿå°±æ˜¯ `shallowData.value` çš„å€¼è¢«æ”¹è®Šï¼Œæ‰æœƒè§¸ç™¼éŸ¿æ‡‰ï¼Œè®“ç•«é¢æ›´æ–°ã€‚

æˆ–è€…ä½¿ç”¨ `triggerRef` è§¸ç™¼éŸ¿æ‡‰ä¹Ÿå¯ä»¥ã€‚

```ts
async function updateShallowData() {
  shallowData.value.cod.push('fish')
  triggerRef(shallowData)
}
```

çœ‹åˆ°é€™è£¡ä½ å¯èƒ½æœƒæƒ³ã€Œæ€éº¼æå¾—æ›´éº»ç…©äº†ï¼Ÿáƒšï¼ˆÂ´å£`áƒšï¼‰ã€

åˆ¥æ€¥åˆ¥æ€¥ï¼Œè®“æˆ‘å€‘ä¾†çœ‹çœ‹ç‚ºç”šéº¼éœ€è¦ `shallowRef` é€™å€‹ç©æ„å…’ã€‚

## shallowRef çš„ä½¿ç”¨å ´æ™¯

å…ˆä¾†å€‹å·¥ç¨‹å¸«çš„å¥½ç¿’æ…£ï¼Œç¬¬ä¸€æ­¥å…ˆçœ‹çœ‹[æ–‡ä»¶å¯«ç”šéº¼](https://vuejs.org/api/reactivity-advanced.html)ã€‚

å…¶å¯¦æ–‡ä»¶èªªå¾—å¾ˆæ¸…æ¥šï¼Œä¸»è¦ç›®çš„æ˜¯ç‚ºäº†ã€Œæ€§èƒ½è€ƒé‡ã€èˆ‡ã€Œå¤–éƒ¨ç‹€æ…‹ç®¡ç†æ•´åˆã€ã€‚

æ–‡ä»¶ä¹Ÿçµ¦äº†å…·é«”ä¾‹å­ï¼š

- [Guide - Reduce Reactivity Overhead for Large Immutable Structures](https://vuejs.org/guide/best-practices/performance#reduce-reactivity-overhead-for-large-immutable-structures)
- [Guide - Integration with External State Systems](https://vuejs.org/guide/extras/reactivity-in-depth#integration-with-external-state-systems)

### å¤§å‹ç‰©ä»¶

å°æ•´å€‹é¾å¤§ç‰©ä»¶é€²è¡ŒéŸ¿æ‡‰å¼è™•ç†ï¼Œæœƒå°è‡´æ€§èƒ½ä¸‹é™ã€‚

åªçœ‹æ–‡å­—èªªæ˜ä¸å¤ å…·é«”ï¼Œè®“æˆ‘å€‘ç”¨ç¨‹å¼ç¢¼è­‰æ˜çœ‹çœ‹å§ã€‚

è€ƒæ…®ä»¥ä¸‹ç¨‹å¼ç¢¼ã€‚

```vue
<script setup>
import {
  ref, shallowRef,
  watch, triggerRef,
  nextTick
} from 'vue'

/** å»ºç«‹ä¸€å€‹ 10 å€‹ keyï¼Œæ¯å€‹ value çŸ©é™£é•·åº¦ 1000 çš„å¤§å‹ç‰©ä»¶ */
function createData() {
  const data = {
    cod: [],
  }

  for (let i = 0; i < 10; i++) {
    const key = crypto.randomUUID();
    data[key] = new Array(1000).fill('fish');
  }

  return data;
}

/** ä½¿ç”¨ ref åŒ…è£çš„è³‡æ–™ */
const data = ref(createData())
watch(data, () => {
  console.log('[watch] data');
}, { deep: true })

async function updateData() {
  console.time('updateData');
  data.value.cod.push('fish')
  await nextTick();
  console.timeEnd('updateData');
}

/** ä½¿ç”¨ shallowRef åŒ…è£çš„è³‡æ–™ */
const shallowData = shallowRef(createData())
watch(shallowData, () => {
  console.log('[watch] shallowData');
}, { deep: true })

async function updateShallowData() {
  console.time('updateShallowData');
  shallowData.value.cod.push('fish')
  triggerRef(shallowData)
  await nextTick();
  console.timeEnd('updateShallowData');
}
</script>

<template>
  <div>
    data: {{ data.cod.length }}
  </div>
  <button @click="updateData">
    æ›´æ–°è³‡æ–™
  </button>

  <hr>

  <div>
    shallowData: {{ shallowData.cod.length }}
  </div>
  <button @click="updateShallowData">
    æ›´æ–°è³‡æ–™
  </button>
</template>

```

[ç¯„ä¾‹ç¨‹å¼ç¢¼](https://play.vuejs.org/#eNqVlU1v00AQhv/KyJc4JXKC4JSmFYX2UA6A+nHq9mDsje3WXlvrddIoslQhEEKtxAUqAYILiA9xAAkEqAXxZ5qknPgLzK6d2rRVoCd7Z9+dfeeZ9bqvzUWR0Umo1tRascW9SEBMRRLNEuYFUcgF9AkD4LRdg9g1fT/sLuG7jHVNYbk1ENxzHMrHUUa3xIpnbRKWQpuHAVQwe4UwwupTUzA42B+93zn8tj3Y3oGLDZCPTdr7/X13+OGhHHRMP6EwurP/6/HXwf5r1DQaMHp6d/DqzeDFzujBu8ODLzBVJ6ydMEt4IQOLU1PQeVOYejUza4UsFmBjBGayiIzZTVhbVxZT6QagHXLQfSrAQ1ljGh8t3A6fFy7kicap0CFKLN6LRGhwk9lhsLq6OK9XpzOV3GoNReuoYrQLc5ybPV1arxptz/f1StuL3Uomz3fnSJkztRTDKigBHf74OXr0VvKGwe69o5fPsfajT/eHe09U1X+VhiK9XH2VMNUTXc7XAHHMzBZEQp8afujolTUlWldZlKe0Bn2wKY2a2Eykn2Iiwsy4xyw4xpxEqD+FWSYVXkD1SjGf1ynTG6qdBsI3oiR2xxzktNk1PXF8WnKU5ZQLzD6V9SSm4kROoJWLZBKEViw5m11J/W+EJfF5SS4XSycBLclyrqU9J+AtvspyRecmf3J7bECrnt0TeEPgQNAg8lGII4CW7XXUS9b9JvSRhvQpHfqUOcKFFFOgsj6Wtm4nQiCVK5aPbmaIVrScaHmy4bPPw72PWWOz1dkiZQGHLh+/FQZKVSsfZWznt1Pi8D+uWvUSF62miRj5tj3H2IhDhletajfRrDCIPJ/ym5E8GDHR0GmWm2hqv+sqJo+SurjUGpdam2fEN+ItGSPaLU5jyjuUaMdzwuQOFdn0wvIN7HxpMgjtxEf1hMklimcjkR4z2dWE2Wi7pFNuF9UPw2POSrywJSiLx0VJo+rqU3qi4R/h2oTSC7uXjMv5lZlq6R9PPGXz)

ä»¥ä¸Šç¨‹å¼çš„é‚è¼¯ç‚ºï¼š

1. `createData` å»ºç«‹ä¸€å€‹ 10 å€‹ keyï¼Œæ¯å€‹ value ç‚ºé•·åº¦ 1000 çš„å¤§å‹ç‰©ä»¶ã€‚
1. åˆ†åˆ¥ä½¿ç”¨ `ref` å’Œ `shallowRef` å° `createData` çš„çµæœé€²è¡ŒåŒ…è£ã€‚
1. `nextTick` è¡¨ç¤ºè§¸ç™¼éŸ¿æ‡‰è³‡æ–™è®Šæ›´ã€ç­‰å¾… DOM ä¸‹æ¬¡æ›´æ–°å¾Œï¼Œæ¥è‘—é…åˆ `console.time` è¨ˆç®—æ›´æ–°è³‡æ–™æ‰€éœ€æ™‚é–“ã€‚

ç¾åœ¨å¤§å®¶å¯ä»¥é»æ“Šçœ‹çœ‹å…©è€…çš„ã€Œæ›´æ–°è³‡æ–™ã€æŒ‰éˆ•ï¼Œçœ‹çœ‹æ›´æ–°è³‡æ–™æ‰€éœ€æ™‚é–“ã€‚

æœƒåœ¨ console ä¸­çœ‹åˆ°ä»¥ä¸‹è³‡è¨Šã€‚

```shell
[watch] data
updateData: 7.468994140625 ms
[watch] shallowData
updateShallowData: 0.60498046875 ms
```

å¯ä»¥æ³¨æ„åˆ° `shallowData` çš„æ›´æ–°æ™‚é–“æ¯” `data` å¿«äº†è¿‘ 10 å€ï¼[( â€¢Ì€ Ï‰ â€¢Ì )âœ§]{.text-nowrap}

<br>

è·¯äººï¼šã€Œé›–ç„¶å·® 10 å€ï¼Œä½†å¯¦éš›ä¸Šä¹Ÿæ‰èŠ±äº† 7msï¼Œå¹³å¸¸ä¹Ÿç”¨ä¸åˆ°é€™éº¼å¤§çš„ç‰©ä»¶ï¼Œé€™æ¨£æ˜¯ä¸æ˜¯ä¸ç”¨ `shallowRef` ä¹Ÿç„¡æ‰€è¬‚å•Šï¼Ÿ[(*Â´ï½¥Ğ´ï½¥)?]{.text-nowrap}ã€

é±ˆé­šï¼šã€Œä½ èªªæ²’éŒ¯ [(Â´,,â€¢Ï‰â€¢,,)]{.text-nowrap}ï¼Œå¹³å¸¸å¾ˆé›£é‡åˆ°å¤§å‹ç‰©ä»¶ï¼Œä¸éé‚„è¦æ˜¯æ³¨æ„ä¸€äº›æƒ…å¢ƒã€‚ã€

### é…åˆç¬¬ä¸‰æ–¹å¥—ä»¶

ç•¶ä½ ä½¿ç”¨ pixiã€babylon.js é€™é¡å¥—ä»¶æ™‚ï¼Œå¥—ä»¶æœ¬èº«æœƒå»ºç«‹å„ç¨®è¤‡é›œç‰©ä»¶ï¼Œä¾‹å¦‚ï¼šEngineã€Sceneã€Mesh ç­‰ç­‰ã€‚

é›–ç„¶ä¸€èˆ¬æƒ…æ³ä¸‹ï¼Œå®Œå…¨ä¸éœ€è¦ `ref`ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚

```ts
// âŒ ä¸éœ€è¦ ref åŒ…è£
const engine = ref(new Engine(canvas, true));

// âœ…
const engine = new Engine(canvas, true);
```

ä½†æ˜¯æœ‰æ™‚å€™é‚„æ˜¯éœ€è¦éŸ¿æ‡‰æ€éº¼è¾¦ï¼Ÿé€™å€‹æ™‚å€™å°±å¯ä»¥ç”¨ `shallowRef` äº†ï¼[à©­ Ë™á—œË™ )à©­]{.text-nowrap}

ç›´æ¥ä½¿ç”¨ `ref` åŒ…è£ï¼Œæœƒè®“ç•«é¢æœƒå¡åˆ°çˆ†ç‚¸å–”ã€‚

é™¤äº†å¡åˆ°ç‚¸ä»¥å¤–ï¼Œ`ref` çš„ `Proxy` é‚„æœ‰å¯èƒ½ç ´å£å¥—ä»¶çš„å…§éƒ¨é‚è¼¯ï¼Œå°è‡´å¥—ä»¶ç„¡æ³•æ­£å¸¸é‹ä½œã€‚

ä¾‹å¦‚ä»¥ä¸‹ issueï¼š

- [Bug: When Application is proxied by Vue 3(ref), an error occurs when rendering graphics](https://github.com/pixijs/pixijs/issues/10477)

å¯ä»¥çœ‹åˆ°è£¡é¢æåˆ°çš„è§£æ³•ä¹Ÿæ˜¯ç”¨ `shallowRef` è§£æ±ºã€‚[â—( â€¢Ï‰â€¢ )â—Ÿ]{.text-nowrap}

::alert{type="primary"}
ä¾‹å¦‚é…·é…·å…ƒä»¶ä¸­çš„ [useBabylonScene](https://gitlab.com/side_project/chill-component/-/blob/main/src/composables/use-babylon-scene.ts?ref_type=heads#L67)ï¼Œç”¨æ–¼å¿«é€Ÿå»ºç«‹ä¸€å€‹ 3D å ´æ™¯ã€‚å…¶ä¸­çš„ babylon.js ç›¸é—œç‰©ä»¶å°±æ˜¯ä½¿ç”¨ `shallowRef` åŒ…è£ã€‚
::

å†é€²éšä¸€é»é‚„å¯ä»¥è€ƒæ…®ä½¿ç”¨ `customRef`ï¼Œä¸éé€™å€‹å°±ç•™åˆ°æœªä¾†æœ‰æ©Ÿæœƒå†èŠå•¦ã€‚[( Â´ â–½ ` )ï¾‰]{.text-nowrap}

## ç¸½çµ ğŸŸ

- `shallowRef` åªå°ç¬¬ä¸€å±¤é€²è¡ŒéŸ¿æ‡‰å¼è™•ç†ï¼Œé©åˆå¤§å‹ç‰©ä»¶ã€‚
- é…åˆç¬¬ä¸‰æ–¹å¥—ä»¶çš„è¤‡é›œç‰©ä»¶æ™‚ï¼Œä½¿ç”¨ `shallowRef` å¯ä»¥é¿å…ç ´å£ç‰©ä»¶å…§éƒ¨é‚è¼¯æˆ–æ‹–å®æ€§èƒ½ã€‚
