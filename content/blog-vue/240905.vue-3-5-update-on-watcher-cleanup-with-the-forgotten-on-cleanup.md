---
title: Vue 3.5 更新，onWatcherCleanup 與被遺忘的 onCleanup
description: Vue 3.5 更新新增了 onWatcherCleanup，用於清理 watcher 中的副作用（Side Effect），可是原本的 watch 已經有 onCleanup，所以到底差在哪呢？(╯▽╰ )
tags: ['Vue']
image: https://codlin.me/vue-3-5-update-on-watcher-cleanup-with-the-forgotten-on-cleanup.webp
date: 202

head:
  meta:
    - name: 'keywords'
      content: 'cod, lin'
---

# Vue 3.5 更新，onWatcherCleanup 與被遺忘的 onCleanup

![vue-3-5-update-on-watcher-cleanup-with-the-forgotten-on-cleanup](/vue-3-5-update-on-watcher-cleanup-with-the-forgotten-on-cleanup.webp){height="600"}

[Vue 3.5 更新了](https://blog.vuejs.org/posts/vue-3-5)！除了其他改進與實用功能外，有一個很有趣的新 API，[叫做 `onWatcherCleanup`](https://blog.vuejs.org/posts/vue-3-5#onwatchercleanup)。

不過原本的 watch 已經有 `onCleanup` 了，所以到底差在哪呢？

[文檔 Side Effect Cleanup 一節](https://vuejs.org/guide/essentials/watchers.html#side-effect-cleanup)中提到的用法為：

```ts
import { watch, onWatcherCleanup } from 'vue'

watch(id, (newId) => {
  const controller = new AbortController()

  fetch(`/api/${newId}`, { signal: controller.signal }).then(() => {
    // callback logic
  })

  onWatcherCleanup(() => {
    // abort stale request
    controller.abort()
  })
})
```

不過 watch 本身就有 onCleanup，所以應該可以這樣寫。

```ts
watch(id, (newId, oldId, onCleanup) => {
  const controller = new AbortController()

  fetch(`/api/${newId}`, { signal: controller.signal }).then(() => {
    // callback logic
  })

  onCleanup(() => {
    // abort stale request
    controller.abort()
  })
})
```

[文檔 onWatcherCleanup 章節](https://vuejs.org/api/reactivity-core#onwatchercleanup)也沒有其他說明。

說不定實際效果不一樣？讓我們來實測看看吧。(๑•̀ㅂ•́)و✧

這裡我們使用一個[免費的 API](https://alexwohlbruck.github.io/cat-facts/docs/) 來測試，順便取得貓貓冷知識 XD。

::alert{type="warning"}
如果 API 壞了，大家可以換成[其他 API 測試](https://free-apis.github.io/#/browse)。
::

## 實際測試

```vue
<script setup>
import { ref, watch, onWatcherCleanup } from 'vue'

const id = ref('cod')
const data = ref([])

watch(id, (newId, oldId, onCleanup) => {
  const controller = new AbortController()

  fetch(
    `https://cat-fact.herokuapp.com/facts?id=${newId}`,
    { signal: controller.signal }
  )
    .then((res) => res.json())
    .then((value) => {
      data.value = value;
    })
    .catch((error) => {
      console.error(error);
    })

  onWatcherCleanup(() => {
    console.log('[ onWatcherCleanup ] : ', controller);
    controller.abort()
  }) // */

  /* onCleanup(() => {
    console.log('[ onCleanup ] : ', controller);
    controller.abort()
  }) // */
})

function getData() {
  id.value = crypto.randomUUID();
}
</script>

<template>
  <button @click="getData()">取得貓貓小知識</button>

  <p v-for="datum, i in data">
    {{ i + 1 }}. {{ datum.text }}
  </p>
</template>

```

就一個簡單的按鈕，點擊後會取得貓貓小知識，並顯示在畫面上。

![測試程式](/vue-3-5-update-on-watcher-cleanup-with-the-forgotten-on-cleanup/1.webp)

每次 watch 觸發時，會呼叫上一次的 onCleanup 或 onWatcherCleanup，這樣就可以清理上一次的副作用。

所以讓我們快速點擊按鈕兩下，觀察一下 DevTools 之 Network 的結果。

![Network](/vue-3-5-update-on-watcher-cleanup-with-the-forgotten-on-cleanup/2.webp)

可以注意到上次的 fetch 順利取消了！

現在讓我們把 onWatcherCleanup 註解掉，改用 onCleanup，再來觀察一下。

見證奇蹟的時刻到了！

結果一模一樣！╮(╯▽╰)╭

...嗯，目前看來沒什麼差別，onWatcherCleanup 的限制甚至還更多，目前文檔也沒有其他資訊。

不知道是不是我用法不對，還是有甚麼特殊場景。

如果各位讀者們知道的話，還請不吝賜教。(´▽`ʃ♡ƪ)

以上程式碼可以在此取得：[範例程式碼](https://play.vuejs.org/#eNqdVMFu1DAQ/ZWRhbRpSROqgoSW3UJpeygHQEDFoa6omzi7bh07sp3tVqt8Qw9IwI0TRyTEB/A3Ff0Mxs7uNgVUJFar2J6Z92bmZeIZ2aqqZFJz0icDmxlRObDc1dUmVaKstHEwA8OLGM6Yy8YxaPXWb7jZlpypuoIGCqNL6CFHjyqqMq2sA5HD0OOiXqbz3srCnDPH5o6DQ7RSFWgjkccQKX62h6uWeVjUPMMKDDdhRhVAy4FPZ7SU3CATYmDrGMvcXlqjwAtQcM/sdwBHY+cq20/TjLm1gmUuwQ70ac2w+UyXqTfZxyIf3pmFKpqjuAXOwIqRYrLfSZu0Jmh8CCbzcYkbcxVFhttQLq7JidUqWrnpnzBZ8+uG/M9LkgQ7thPWR62rWUCxZmwk4sZocxPrBdGSJ8E1D+ig/W4pYxR1sQuk1KOod3AdBYfQh17c6XZB2OmfecG9zD4NpCmspm2ydPWP+fhH2t+G6b+zt+0Wtcqc0ApG3O2grpg7JBb5UuHMnFdOJ4apXJf7+3s7kU+Br3KQtuOPg48Hx8tKMsfxBDA4rp1D1ieZFNnpkJIlPSWblxcfLn98vPr+Hv+X3y5+fv5y9fXTIG0hgQwJcjGBTDJrEexERQlM1gpt8ISvvy5jECBUGAVknE/eDI13YR2aJvGHEJg4PnVoCaQpsrbVpp1y8WjdufTbBFO1ApTMjITqw8NqCveW/c7DSEycRYELMQpDi1dBAFGCn0YlUPMXlVfVUtJfvEhKmJT67FmwOVPz+feCmDHPTv9iP7FTb6PkJX4c3Ew4JUufw/K4a927r59jjx1nqfNaYvQtzlccp6r2NbZhT2uVY9mduFDtXrjQhBq9sbtTx5VdNOULDfMU4inBu2z7ltavy91I7gccKooqvptw4zlRwI3kQbJOml8X+Mrc)

## 總結 🐟

- 認識 onCleanup 與 onWatcherCleanup
- 目前測試兩者沒有差別
