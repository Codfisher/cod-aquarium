---
description: å¸¸è½åˆ¥äººèªª Vue template æœ‰ç·¨è­¯é­”æ³•ï¼Œä¾†ä»”ç´°çœ‹çœ‹åˆ°åº•å·®åœ¨å“ªå§ã€‚
tags: ["Vue"]
image: https://codlin.me/vue-template-compilation-magic.webp
pubDate: 20260115
draft: true
---

<script setup>
  import PerfComparison from './vue-template-compilation-magic/perf-comparison.vue'
</script>

![vue-template-compilation-magic](/vue-template-compilation-magic.webp){.cover}

# Vue template ç·¨è­¯é­”æ³•

å’ŒåŒäº‹è¨è«–åˆ° Vue templateã€`h()` çš„ä½¿ç”¨æƒ…å¢ƒå‰›å¥½æœ€è¿‘ä½¿ç”¨ Nuxt UI ä¹Ÿå¸¸ä½¿ç”¨ `h()` ä¾†æ¸²æŸ“å…§å®¹ã€‚

åœ¨é«˜åº¦å‹•æ…‹çš„å ´æ™¯ä¸‹ï¼Œä½¿ç”¨ `h()` æœƒæ›´åŠ æ–¹ä¾¿ï¼Œå…ˆå‰ä¹Ÿæœ‰[æ–‡ç« ](/blog-vue/vue-h-function-makes-quasar-dialog-easier-to-reuse.html)æåˆ°ç›¸é—œæ‡‰ç”¨ã€‚

::: tip ç”šéº¼æ˜¯ `h()`
`h()` æ˜¯ Vue çš„æ¸²æŸ“å‡½å¼ï¼Œè©³ç´°èªªæ˜å¯ä»¥[çœ‹çœ‹å®˜æ–¹æ–‡ä»¶](https://vuejs.org/guide/extras/render-function.html)
:::

ä½†æ˜¯ `h()` ä¸æœƒæœ‰ template çš„ç·¨è­¯æœ€ä½³åŒ–ï¼Œæ‰€ä»¥æ²’æœ‰ç‰¹åˆ¥éœ€æ±‚çš„æƒ…å¢ƒä¸‹ï¼Œé‚„æ˜¯å»ºè­°ä½¿ç”¨ templateã€‚

[å®˜æ–¹æ–‡ä»¶](https://vuejs.org/guide/essentials/template-syntax.html)æåˆ°ï¼š

> If you are familiar with Virtual DOM concepts and prefer the raw power of JavaScript, you can also directly write render functions instead of templates, with optional JSX support. However, do note that they do not enjoy the same level of compile-time optimizations as templates.

è½èªªæ­¸è½èªªï¼Œ~~å¿è€…é¾œå¿è€…~~ï¼Œå¾ä¾†æ²’æœ‰ä»”ç´°ç ”ç©¶éåˆ°åº•å·®åœ¨å“ªï¼Œè¶é€™æ¬¡æ©Ÿæœƒä¾†çœ‹çœ‹å§ã€‚%( Â´ â–½ ` )ï¾‰%

## é€Ÿåº¦çœŸçš„æœ‰å·®ï¼Ÿ

å£èªªç„¡æ†‘ï¼Œç›´æ¥å¯«å€‹ç¯„ä¾‹æ¯”è¼ƒçœ‹çœ‹å§ã€‚%( Â´ â–½ ` )ï¾‰%

ç”±æ–¼ JSX èˆ‡ `h()` æ¦‚å¿µç›¸è¿‘ï¼Œæ‰€ä»¥é€™è£¡åªæ¯”è¼ƒ template èˆ‡ `h()` çš„å·®ç•°ã€‚

åˆ†åˆ¥å»ºç«‹ template èˆ‡ `h()` çš„ç¯„ä¾‹ï¼š

::: code-group

<<< ./vue-template-compilation-magic/list-template.vue[list-template.vue]

<<< ./vue-template-compilation-magic/list-h.ts[list-h.ts]

:::

æ¥è‘—å¼•ç”¨ä»¥ä¸Šå…ƒä»¶ä¸¦è¨ˆæ™‚æ›´æ–°è€—æ™‚ï¼Œç‚ºäº†è®“å·®è·æ˜é¡¯ä¸€é»ï¼Œè®“å…§å®¹é‡è¤‡ 2000 æ¬¡ã€‚

`perf-comparison.vue`

<<< ./vue-template-compilation-magic/perf-comparison.vue

ç¾åœ¨å¤§å®¶å¯ä»¥æŒ‰ä¸‹é–‹å§‹æŒ‰éˆ•ä¸¦åˆ‡æ›æ¨¡å¼ï¼Œçœ‹çœ‹è€—æ™‚æœ‰ç”šéº¼å·®ç•°ã€‚

<perf-comparison />

åœ¨æˆ‘çš„é›»è…¦ä¸Šï¼Œtemplate å¤§ç´„åœ¨ 5 msï¼Œ`h()` å¤§ç´„åœ¨ 20 msã€‚

ä¸åŒè£ç½®çµæœæœƒä¸ä¸€æ¨£ï¼Œä¸éå¾ˆæ˜é¡¯å¯ä»¥çœ‹å‡º template çš„é€Ÿåº¦æœƒæ¯” `h()` å¿«å¾—å¤šã€‚

ä¸éé€šå¸¸ä¸æœƒç”¢ç”Ÿå¤§é‡å…ƒç´ ï¼Œæ‰€ä»¥å¹³æ™‚å®Œå…¨çœ‹ä¸å‡ºå·®åˆ¥ï¼Œåªæ˜¯ç•¶ä½ çš„ç¶²é é‡ç´šå¢åŠ ï¼Œç©å°‘æˆå¤šï¼Œæ€§èƒ½è² æ“”è‡ªç„¶æœƒå¢åŠ ã€‚

æ‰€ä»¥å¯¦å‹™ä¸Šä¾†èªªé™¤éæœ‰æ˜ç¢ºçš„éœ€æ±‚æˆ–å…ƒä»¶ API é™åˆ¶ï¼Œå¦å‰‡æ¯”è¼ƒæ¨è–¦ä½¿ç”¨ templateã€‚%(ãƒ»âˆ€ãƒ»)ï¼™%

## ç·¨è­¯çµæœ

template ç‚ºç”šéº¼æœƒæ¯”è¼ƒå¿«å‘¢ï¼Ÿæ–‡ä»¶çš„èªªæ³•æ˜¯å› ç‚º Vue çš„ç·¨è­¯å™¨æœƒè‡ªå‹•æœ€ä½³åŒ–ï¼ˆCompile-time Optimizationï¼‰ï¼Œå¿«å–éœæ…‹ç¯€é»ã€åŠ é€Ÿ Patch Flags åŠ é€Ÿæ¯”è¼ƒéç¨‹ç­‰ç­‰ã€‚

å¯¦éš›ä¸Šä¸ç®¡æ˜¯ template é‚„æ˜¯ `h()`ï¼Œæœ€çµ‚ Vue éƒ½æœƒç·¨è­¯æˆ JS ç¨‹å¼ç¢¼ï¼Œç”¨ä»¥ç”¢ç”Ÿ Virtual DOM (VNode)

è®“æˆ‘å€‘ä¾†çœ‹çœ‹ç·¨è­¯å¾Œçš„ç”¢ç‰©æœ‰ç”šéº¼å·®åˆ¥å§ã€‚%à©­ Ë™á—œË™ )à©­%

é€™è£¡ä½¿ç”¨ [Vue SFC Playground](https://play.vuejs.org/) çš„ PROD æ¨¡å¼é€²è¡Œç·¨è­¯ï¼Œä¾†æ¯”è¼ƒ templateã€`h()` èˆ‡ JSX çš„ç·¨è­¯å…§å®¹ã€‚

åˆ†åˆ¥å»ºç«‹ 3 ç¨®ç‰ˆæœ¬çš„ç°¡å–®ç¯„ä¾‹ï¼š

::: code-group

```vue [template]
<script setup>
import { ref } from 'vue'

const msg = ref('Hello Vue!')
</script>

<template>
  <h1>{{ msg }}</h1>
  <input v-model="msg">

  <h2>Hi</h2>
</template>
```

```ts [h()]
import { defineComponent, h, ref } from 'vue'

export default defineComponent({
  setup() {
    const msg = ref('Hello Vue!')

    return () => h('div', null, [
      h('h1', null, msg.value),
      h('input', {
        value: msg.value,
        onInput: (e: Event) => {
          msg.value = (e.target as HTMLInputElement).value
        },
      }),
      h('h2', null, 'Hi'),
    ])
  },
})
```

```tsx [JSX]
import { defineComponent, ref } from 'vue'

export default defineComponent({
  setup() {
    const msg = ref('Hello Vue!')

    return () => (
      <div>
        <h1>{msg.value}</h1>
        <input
          value={msg.value}
          onInput={(e) => (msg.value = (e.target as HTMLInputElement).value)}
        />
        <h2>Hi</h2>
      </div>
    )
  },
})
```

:::

ç·¨è­¯çµæœï¼š

::: code-group

```js [template]
/* Analyzed bindings: {
  "ref": "setup-const",
  "msg": "setup-ref"
} */
import { createElementBlock as _createElementBlock, createElementVNode as _createElementVNode, Fragment as _Fragment, openBlock as _openBlock, toDisplayString as _toDisplayString, vModelText as _vModelText, withDirectives as _withDirectives, ref } from 'vue'

const __sfc__ = {
  __name: 'App',
  setup(__props) {
    const msg = ref('Hello Vue!')

    return (_ctx, _cache) => {
      return (_openBlock(), _createElementBlock(_Fragment, null, [
        _createElementVNode('h1', null, _toDisplayString(msg.value), 1 /* TEXT */),
        _withDirectives(_createElementVNode('input', {
          'onUpdate:modelValue': _cache[0] || (_cache[0] = ($event) => ((msg).value = $event))
        }, null, 512 /* NEED_PATCH */), [
          [_vModelText, msg.value]
        ]),
        _cache[1] || (_cache[1] = _createElementVNode('h2', null, 'Hi', -1 /* CACHED */))
      ], 64 /* STABLE_FRAGMENT */))
    }
  }
}
__sfc__.__file = 'src/App.vue'
export default __sfc__
```

```js [h()]
/* Analyzed bindings: {} */

import { defineComponent, h, ref } from 'vue'

const __sfc__ = defineComponent({
  setup() {
    const msg = ref('Hello Vue!')

    return () => h('div', null, [
      h('h1', null, msg.value),
      h('input', {
        value: msg.value,
        onInput: (e) => {
          msg.value = (e.target).value
        },
      }),
      h('h2', null, 'Hi'),
    ])
  },
})

__sfc__.__file = 'src/App.vue'
export default __sfc__
```

```js [JSX]
/* Analyzed bindings: {} */

import { createTextVNode as _createTextVNode, createVNode as _createVNode, defineComponent, ref } from 'vue'
const __sfc__ = defineComponent({
  setup() {
    const msg = ref('Hello Vue!')
    return () => _createVNode('div', null, [_createVNode('h1', null, [msg.value]), _createVNode('input', {
      value: msg.value,
      onInput: (e) => msg.value = e.target.value
    }, null), _createVNode('h2', null, [_createTextVNode('Hi')])])
  }
})
__sfc__.__file = 'src/App.vue'
export default __sfc__
```

:::

å¾çµæœä¸­å¯ä»¥ç™¼ç¾ `h()` èˆ‡ JSX çµæœåŸºæœ¬ä¸Šç›¸ä¼¼ï¼Œä¸»è¦å¤šäº† `_createTextVNode`

template å‰‡æ˜¯åŠ äº†ä¸å°‘æ±è¥¿ï¼Œè®“æˆ‘å€‘ä¾†çœ‹çœ‹æ˜¯ç”šéº¼å§ã€‚%ãƒ¾(â—'à±ª`â—)ï¾‰ï¾%

## Vue Runtime Helpers

template ç·¨è­¯çµæœä¸­çš„ `openBlock`ã€`createElementBlock`ã€`withDirectives`ã€`toDisplayString`ã€`_cache` ç­‰ç­‰éƒ½æ˜¯ [Vue Runtime Helpers](https://github.com/vuejs/core/blob/main/packages/compiler-core/src/runtimeHelpers.ts) çš„ä¸€éƒ¨åˆ†ï¼Œç”¨æ–¼è™•ç† Virtual DOM çš„æ“ä½œã€‚

å…¶ä¸­ Cache èˆ‡ Patch Flags æ˜¯ç›¸ç•¶é‡è¦çš„ä¸€ç’°ï¼Œå¯ä»¥ä¾†çœ‹çœ‹ Vue çš„ [Rendering Mechanism](https://vuejs.org/guide/extras/rendering-mechanism) æ–‡ä»¶ï¼Œè£¡é¢èªªæ˜äº† Vue å¦‚ä½•æ”¹é€²æ¸²æŸ“æ•ˆèƒ½ã€‚

ä¸é `h()` ä¹Ÿå¯ä»¥å¯«å‡ºåŒ Cache çš„æ•ˆæœï¼Œåªè¦å°‡å¸Œæœ›å¿«å–çš„å…§å®¹æå‡åˆ°è®Šæ•¸ä¸­å³å¯ï¼Œä¾‹å¦‚å‰›å‰›çš„ç¯„ä¾‹å°±å¯ä»¥æ”¹å¯«æˆé€™æ¨£ï¼š

```ts
import { defineComponent, h, ref } from 'vue'

export default defineComponent({
  setup() {
    const msg = ref('Hello Vue!')

    const onInput = (e: Event) => { // [!code ++]
      msg.value = (e.target as HTMLInputElement).value // [!code ++]
    } // [!code ++]

    const staticNode = h('h2', null, 'Hi') // [!code ++]

    return () => h('div', null, [
      h('h1', null, msg.value),
      h('input', {
        value: msg.value,
        onInput: (e) => { // [!code --]
          msg.value = (e.target).value // [!code --]
        }, // [!code --]
        onInput, // [!code ++]
      }),
      h('h2', null, 'Hi'), // [!code --]
      staticNode, // [!code ++]
    ])
  },
})
```

åªæ˜¯é€™æ¨£å¯«èµ·ä¾†æœƒæ¯”è¼ƒéº»ç…©ï¼Œä¹Ÿä¸æ”¯æ´ Patch Flagsã€‚%â—( â€¢Ï‰â€¢ )â—Ÿ%

## ç¸½çµ ğŸŸ

- template æ¯” `h()` å¿«
- é«˜åº¦å‹•æ…‹æƒ…å¢ƒä½¿ç”¨ `h()` æ›´åŠ æ–¹ä¾¿
- Vue Compiler æœƒè‡ªå‹•æœ€ä½³åŒ– templateï¼Œæ›´é«˜æ•ˆçš„æ“ä½œ Virtual DOM
