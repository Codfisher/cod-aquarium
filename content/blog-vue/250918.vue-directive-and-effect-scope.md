---
description: Directive å…§æ²’æœ‰è‡ªå‹•è§£é™¤éŸ¿æ‡‰å¼è³‡æ–™èˆ‡å‰¯ä½œç”¨çš„é­”æ³•å‘¦ (ãƒ»âˆ€ãƒ»)
tags: ['Vue']
image: https://codlin.me/vue-directive-and-effect-scope.webp
pubDate: 20250918
---

![vue-directive-and-effect-scope](/vue-directive-and-effect-scope.webp){.cover}

# è‡ªå‹•è§£é™¤çš„é­”æ³•å‘¢ï¼ŸVue Directive å’Œ Effect Scope

Vue é™¤äº†å…ƒä»¶èˆ‡ Composition API å¤–ï¼Œé‚„æœ‰å¾ˆæ–¹ä¾¿çš„è‡ªå®šç¾© [Directive](https://cn.vuejs.org/guide/reusability/custom-directives)ã€‚

å‰é™£å­çš„æ–°ä½œ - [å½ˆç æª¯](https://chillcomponent.codlin.me/components/util-pinball/)ï¼Œå°±ç”¨äº†è‡ªå®šç¾©æŒ‡ä»¤ï¼Œå¯ä»¥å°‡ DOM è®Šæˆå½ˆç æª¯çš„ä¸­çš„æ©Ÿé—œï¼Œåƒé€™æ¨£ï¼š

```vue
<template>
  <div
    v-pinball-mech
    class="wall absolute bottom-0 left-0 h-4 w-full rounded-full"
  />
</template>
```

å…¶ä¸­æœ‰å€‹éœ€è¦å–å¾— DOM å°ºå¯¸èˆ‡ä½ç½®çš„é‚è¼¯ï¼Œé€™è£¡å–ç°¡åŒ–å¾Œçš„æ ¸å¿ƒç¨‹å¼ç¢¼ï¼š

```ts
export const vPinballMech: Directive = {
  mounted(el) {
    if (!(el instanceof HTMLElement)) {
      console.warn('v-pinball-mech åªèƒ½ç”¨æ–¼ HTMLElement')
      return
    }

    const bounding = reactive(useElementBounding(el))

    const id = store.add({
      options,
      ...bounding,
    })

    watch(bounding, (value) => {
      store.update(id, value)
    }, { deep: true })
  },
}
```

ç•¶å…ƒç´ ç¶å®šå¾Œï¼Œåœ¨ `store` æ–°å¢æ­¤å…ƒç´ ï¼Œé…åˆ `useElementBounding` å–å¾—å…ƒç´ å°ºå¯¸ä¸¦ç”¨ `watch` åŒæ­¥å°ºå¯¸è®ŠåŒ–ã€‚

ä¸éç•¶å…ƒä»¶ç§»é™¤æ™‚ï¼ŒæŒ‡ä»¤ä¸­ `watch` èˆ‡ `useElementBounding` ä¸¦ä¸æœƒè‡ªå‹•è§£é™¤å‘¦ã€‚%( ï¾Ÿ âˆ€ã€‚)%

## çœŸçš„æœƒé€™æ¨£å—ï¼Ÿ

è¦è­‰æ˜é€™ä»¶äº‹ï¼Œå…¶å¯¦ä¹Ÿç›¸ç•¶ç°¡å–®ï¼Œä¾†å€‹ [`useIntervalFn`](https://vueuse.org/shared/useIntervalFn/)ï¼š

æ­£å¸¸æƒ…æ³ä¸‹ `useIntervalFn` æœƒåœ¨ Effect Scope åœæ­¢æ™‚è‡ªå‹•è§£é™¤ã€‚

```ts
export const vTest: Directive = {
  mounted(el, binding) {
    useIntervalFn(() => {
      console.log('cod')
    }, 1000)
  },
}
```

å¯ä»¥æ³¨æ„åˆ°å³ä½¿å…ƒä»¶è¢«ç§»é™¤ï¼Œ`cod` ä»ç„¶æœƒä¸æ–·å‡ºç¾ã€‚

ç‚ºç”šéº¼æœƒé€™å€‹æ¨£å­å‘¢ï¼Ÿé€™å€‹æˆ‘å€‘å¯ä»¥åéä¾†æƒ³ï¼ŒVue å…ƒä»¶ç§»é™¤æ™‚å¦‚ä½•æ¸…ç†éŸ¿æ‡‰å¼è³‡æ–™èˆ‡å‰¯ä½œç”¨å‘¢ï¼Ÿ

ç›¸é—œæ¦‚å¿µå…¶å¯¦æ›¾ç¶“åœ¨[é€™ç¯‡æ–‡ç« ](/blog-vue/vue-watch-may-cause-a-memory-leak)æéã€‚

ä¸»è¦æ˜¯ Vue æœƒåœ¨å…ƒä»¶å»ºç«‹è‡ªå‹•ç”¢ç”Ÿå…ƒä»¶ç¯„åœçš„ [Effect Scope](https://cn.vuejs.org/api/reactivity-advanced#effectscope) ä¸¦åœ¨ç§»é™¤æ™‚è‡ªå‹•åœæ­¢ Effect Scopeã€‚

è€Œ Directive ä¸¦æ²’æœ‰è‡ªå·±çš„ Effect Scopeï¼Œæ‰€ä»¥è£¡é¢çš„éŸ¿æ‡‰å¼è³‡æ–™ä¸æœƒè¢«è‡ªå‹•æ¸…ç†ã€‚

æ‰€ä»¥æ€éº¼çŸ¥é“ Directive æ²’æœ‰ Effect Scope ï¼Ÿå¾ˆç°¡å–®ï¼Œä½¿ç”¨ `getCurrentScope` å³å¯ï¼š

```ts
export const vPinballMech: Directive = {
  mounted(el) {
    if (!(el instanceof HTMLElement)) {
      console.warn('v-pinball-mech åªèƒ½ç”¨æ–¼ HTMLElement')
      return
    }

    const currentScope = getCurrentScope()
    console.log('currentScope: ', currentScope)

    // ...
  },
}
```

æœƒæ³¨æ„åˆ° console çµæœæ˜¯ `currentScope: undefined`ã€‚

ç”šéº¼ï¼Ÿä½ èªªç‚ºç”šéº¼ Directive æ²’æœ‰ Effect Scopeï¼Ÿ%(Â´ãƒ»Ï‰ãƒ»`)%

é€™å€‹æˆ‘ä¹Ÿä¸æ¸…æ¥šï¼Œå°±çœ‹æœ‰æ²’æœ‰å¤§å¤§çŸ¥é“ç‚ºç”šéº¼äº†ã€‚

## æ‰€ä»¥è©²æ€éº¼è¾¦å‘¢ï¼Ÿ

è§£æ±ºæ–¹æ³•å…¶å¯¦å¾ˆç°¡å–®ï¼Œå°±æ˜¯è‡ªå·±å»ºä¸€å€‹ Effect Scopeï¼Œç„¶å¾Œè‡ªå·±çš„ Scope è‡ªå·±é—œã€‚%áƒšï¼ˆÂ´âˆ€`áƒšï¼‰%

ä¸éä¸çŸ¥é“ç‚ºç”šéº¼åœ¨ `mounted` ä¹‹å¤–çš„åœ°æ–¹å‘¼å« `scope.stop()` éƒ½æ²’æœ‰æ•ˆï¼ˆç„¡æ•ˆçš„ç¨‹å¼ç¢¼åœ¨[é€™è£¡](https://gitlab.com/side_project/chill-component/-/blob/develop/src/components/util-pinball/v-pinball-mech.ts?ref_type=heads)ï¼‰

æ‰€ä»¥æ”¹æˆåœ¨ `mounted` ä¸­æŒçºŒåˆ¤æ–· DOM æ˜¯å¦ä¾ç„¶å­˜åœ¨ï¼Œä¸å­˜åœ¨å‰‡è§£é™¤ã€‚

```ts
export const vPinballMech: Directive = {
  mounted(el) {
    if (!(el instanceof HTMLElement)) {
      console.warn('v-pinball-mech åªèƒ½ç”¨æ–¼ HTMLElement')
      return
    }

    const scope = effectScope()

    scope.run(() => {
    const bounding = reactive(useElementBounding(el))

      const id = store.add({
        options,
        ...bounding,
      })

      watch(bounding, (value) => {
        store.update(id, value)
      }, { deep: true })

      useIntervalFn(() => {
        // æª¢æŸ¥å…ƒç´ æ˜¯å¦é‚„åœ¨ DOM ä¸­ï¼Œå¦å‰‡åœæ­¢ effect scope
        if (!el.isConnected) {
          scope.stop()
        }
      }, 100)
    })
  },
}
```

ç¾åœ¨åœ¨å…ƒä»¶è¢«ç§»é™¤å¾Œï¼ŒéŸ¿æ‡‰å¼è³‡æ–™èˆ‡å‰¯ä½œç”¨éƒ½æœƒè‡ªå‹•è§£é™¤äº†ã€‚%âœ§â‘ï½¡Ù©(ËŠá—œË‹*)Ùˆâœ§â•ï½¡%

## ç¸½çµ ğŸŸ

- Vue Directive è‡ªèº«æ²’æœ‰ Effect Scopeï¼Œæ‰€ä»¥è£¡é¢çš„éŸ¿æ‡‰å¼è³‡æ–™èˆ‡å‰¯ä½œç”¨ä¸æœƒè¢«è‡ªå‹•æ¸…ç†ã€‚
- å¯è‡ªè¡Œå»ºç«‹ Effect Scopeï¼Œä¸¦åœ¨é©ç•¶æ™‚æ©Ÿåœæ­¢ã€‚
